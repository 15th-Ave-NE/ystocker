{% extends "base.html" %}
{% block title %}yStocker — Market Overview{% endblock %}

{% block content %}
<style>
  .range-btn {
    font-size: 11px; font-weight: 500; line-height: 1;
    padding: 3px 7px; border-radius: 5px;
    border: 1px solid #334155; background: transparent; color: #64748b;
    cursor: pointer; transition: color 0.15s, background 0.15s, border-color 0.15s;
  }
  .range-btn:hover  { color: #cbd5e1; border-color: #475569; background: #1e293b; }
  .range-btn.active { color: #a5b4fc; border-color: #6366f1; background: rgba(99,102,241,0.15); }
  .idx-tab-btn {
    padding: 8px 16px; font-size: 14px; font-weight: 500;
    border-bottom: 2px solid transparent; color: #94a3b8;
    cursor: pointer; transition: color 0.15s, border-color 0.15s;
    background: transparent; border-top: none; border-left: none; border-right: none;
  }
  .idx-tab-btn.active { color: #a5b4fc; border-bottom-color: #6366f1; }
  .idx-tab-btn:hover:not(.active) { color: #e2e8f0; }
  .stat-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 12px 14px; }
  .stat-label { font-size: 11px; color: #64748b; margin-bottom: 4px; }
  .stat-val   { font-size: 16px; font-weight: 700; color: #f1f5f9; }
  .up   { color: #34d399 !important; }
  .down { color: #f87171 !important; }
  .neutral { color: #94a3b8 !important; }
  .bar-fill { height: 8px; border-radius: 4px; transition: width 0.4s; }
  .rsi-zone { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
</style>

<!-- ── Fullscreen chart modal ────────────────────────────────────────── -->
<div id="mktsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
     style="display:none" onclick="closeMktsModal()">
  <div class="relative w-full max-w-5xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col"
       style="max-height:90vh" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 shrink-0">
      <div>
        <h3 id="mktsModalTitle" class="font-semibold text-slate-100"></h3>
        <p id="mktsModalSub" class="text-xs text-slate-500 mt-0.5"></p>
      </div>
      <button onclick="closeMktsModal()"
              class="text-slate-500 hover:text-slate-200 transition p-1 rounded-lg hover:bg-slate-800">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-6 flex-1 min-h-0" style="min-height:460px">
      <canvas id="mktsModalCanvas"></canvas>
    </div>
  </div>
</div>

<!-- ── Header ─────────────────────────────────────────────────────────── -->
<div class="mb-6 fade-up">
  <h1 class="text-xl sm:text-2xl font-bold grad-text" data-i18n="markets.title">Market Overview</h1>
  <p class="text-slate-400 mt-1 text-xs" data-i18n="markets.subtitle">S&amp;P 500 · Nasdaq · Dow Jones — live snapshot &amp; historical charts</p>
</div>

<!-- ── Loading overlay ────────────────────────────────────────────────── -->
<div id="marketsLoading" class="flex items-center gap-2 text-slate-500 text-sm mb-6">
  <svg class="animate-spin w-4 h-4 text-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
    <path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
  </svg>
  <span data-i18n="markets.loading">Loading market data…</span>
</div>
<div id="marketsContent">

<!-- ── Index snapshot cards ───────────────────────────────────────────── -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-4 xl:grid-cols-8 gap-3 mb-6 fade-up" id="indexCards">
  {% for _ in range(8) %}
  <div class="animate-pulse bg-slate-900 border border-slate-800 rounded-xl p-3 h-24"></div>
  {% endfor %}
</div>

<!-- ── VIX + Fear & Greed row (2 per row) ─────────────────────────── -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4 fade-up">

  <!-- VIX card -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 sm:p-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="markets.vix">VIX (Volatility)</h2>
        <p class="text-xs text-slate-500 mt-0.5" data-i18n="markets.vix_desc">CBOE Volatility Index — fear gauge of the S&amp;P 500</p>
      </div>
      <div id="vixBadge" class="text-right flex items-start gap-2">
        <button onclick="expandMktsChart('vix')" title="Expand"
                class="text-slate-600 hover:text-slate-300 transition p-1 rounded-lg hover:bg-slate-800 shrink-0">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="vixSkeleton" class="animate-pulse bg-slate-800 rounded-lg" style="height:200px"></div>
    <div id="vixChartWrap" style="height:200px; display:none"><canvas id="vixChart"></canvas></div>
  </div>

  <!-- CNN Fear & Greed card -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 sm:p-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="markets.fear_greed">Fear &amp; Greed</h2>
        <p class="text-xs text-slate-500 mt-0.5" data-i18n="markets.fear_greed_desc">CNN Fear &amp; Greed Index — composite sentiment</p>
      </div>
      <div id="fgBadge" class="text-right flex items-start gap-2">
        <button onclick="expandMktsChart('fg')" title="Expand"
                class="text-slate-600 hover:text-slate-300 transition p-1 rounded-lg hover:bg-slate-800 shrink-0">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="fgLoading" class="text-xs text-slate-600 py-2" data-i18n="markets.loading">Loading…</div>
    <div id="fgBody" style="display:none">
      <!-- Gauge bar -->
      <div class="mb-4">
        <div class="flex justify-between text-[10px] text-slate-500 mb-1.5">
          <span data-i18n="markets.fg_extreme_fear">Extreme Fear</span>
          <span data-i18n="markets.fg_fear">Fear</span>
          <span data-i18n="markets.fg_neutral">Neutral</span>
          <span data-i18n="markets.fg_greed">Greed</span>
          <span data-i18n="markets.fg_extreme_greed">Extreme Greed</span>
        </div>
        <div class="relative h-3.5 rounded-full overflow-hidden" style="background:linear-gradient(to right,#7f1d1d,#ef4444,#334155,#10b981,#065f46)">
          <div id="fgNeedle" class="absolute top-0 w-0.5 h-full bg-white/90 rounded-full transition-all duration-700" style="left:50%"></div>
        </div>
        <div class="flex justify-between text-[10px] text-slate-500 mt-1"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>
      </div>
      <!-- Comparison row -->
      <div class="grid grid-cols-4 gap-2 mb-4" id="fgCompare"></div>
      <!-- History chart -->
      <div style="height:110px"><canvas id="fgChart"></canvas></div>
    </div>
  </div>

</div>

<!-- ── AAII Sentiment + Put/Call Ratio + Sector Performance row ─────── -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6 fade-up">

  <!-- AAII Sentiment Survey card -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 sm:p-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="markets.aaii_title">AAII Sentiment</h2>
        <p class="text-xs text-slate-500 mt-0.5" data-i18n="markets.aaii_desc">AAII Investor Sentiment Survey — weekly</p>
      </div>
      <div id="aaiiBadge" class="text-right flex items-start gap-2">
        <button onclick="expandMktsChart('aaii')" title="Expand"
                class="text-slate-600 hover:text-slate-300 transition p-1 rounded-lg hover:bg-slate-800 shrink-0">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="aaiiLoading" class="text-xs text-slate-600 py-2" data-i18n="markets.loading">Loading…</div>
    <div id="aaiiBody" style="display:none">
      <!-- Bull/Bear/Neutral bars -->
      <div class="space-y-3 mb-4" id="aaiiBars"></div>
      <!-- History chart -->
      <div style="height:130px"><canvas id="aaiiChart"></canvas></div>
    </div>
  </div>

  <!-- Put/Call Ratio card -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 sm:p-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="markets.pcr_title">Put/Call Ratio</h2>
        <p class="text-xs text-slate-500 mt-0.5" data-i18n="markets.pcr_desc">CBOE Equity Put/Call Ratio — options sentiment</p>
      </div>
      <div id="pcrBadge" class="text-right flex items-start gap-2">
        <button onclick="expandMktsChart('pcr')" title="Expand"
                class="text-slate-600 hover:text-slate-300 transition p-1 rounded-lg hover:bg-slate-800 shrink-0">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="pcrLoading" class="text-xs text-slate-600 py-2" data-i18n="markets.loading">Loading…</div>
    <div id="pcrBody" style="display:none">
      <!-- Gauge bar: <0.6 bullish, 0.6-0.8 neutral, >0.8 bearish -->
      <div class="mb-4">
        <div class="flex justify-between text-[10px] text-slate-500 mb-1.5">
          <span data-i18n="markets.pcr_bullish">Bullish</span>
          <span data-i18n="markets.pcr_neutral">Neutral</span>
          <span data-i18n="markets.pcr_bearish">Bearish</span>
        </div>
        <div class="relative h-3.5 rounded-full overflow-hidden"
             style="background:linear-gradient(to right,#065f46,#10b981,#334155,#ef4444,#7f1d1d)">
          <div id="pcrNeedle" class="absolute top-0 w-0.5 h-full bg-white/90 rounded-full transition-all duration-700" style="left:50%"></div>
        </div>
        <div class="flex justify-between text-[10px] text-slate-500 mt-1">
          <span>0.3</span><span>0.6</span><span>0.8</span><span>1.0</span><span>1.3</span>
        </div>
      </div>
      <!-- Stats row -->
      <div class="grid grid-cols-2 gap-3 mb-4" id="pcrStats"></div>
      <!-- History chart -->
      <div style="height:110px"><canvas id="pcrChart"></canvas></div>
    </div>
  </div>

  <!-- Sector ETF performance -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 sm:p-6">
    <h2 class="text-base font-semibold text-slate-200 mb-4" data-i18n="markets.sector_perf">Sector Performance</h2>
    <div id="sectorBars" class="space-y-2.5"></div>
  </div>

</div>

<!-- ── Per-index detail tabs ──────────────────────────────────────────── -->
<div id="idxDetail" class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
  <div class="flex gap-1 border-b border-slate-800 mb-5 -mx-4 sm:-mx-6 px-4 sm:px-6 overflow-x-auto">
    <button class="idx-tab-btn active whitespace-nowrap" id="tabSpx"   onclick="switchIdx('spx')"   data-i18n="markets.tab_spx">S&amp;P 500</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabIxic"  onclick="switchIdx('ixic')"  data-i18n="markets.tab_ixic">Nasdaq</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabDji"   onclick="switchIdx('dji')"   data-i18n="markets.tab_dji">Dow Jones</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabFtse"  onclick="switchIdx('ftse')"  data-i18n="markets.tab_ftse">FTSE 100</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabN225"  onclick="switchIdx('n225')"  data-i18n="markets.tab_n225">Nikkei 225</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabSse"   onclick="switchIdx('sse')"   data-i18n="markets.tab_sse">Shanghai</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabTwii"  onclick="switchIdx('twii')"  data-i18n="markets.tab_twii">Taiwan</button>
    <button class="idx-tab-btn whitespace-nowrap"        id="tabKospi" onclick="switchIdx('kospi')" data-i18n="markets.tab_kospi">KOSPI</button>
  </div>

  <!-- Stat row (shared, updated per tab) -->
  <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 mb-5" id="idxStats"></div>

  <!-- Technical indicators -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
    <!-- MA status -->
    <div class="bg-slate-800/50 rounded-xl p-3">
      <p class="text-[10px] font-semibold uppercase tracking-widest text-slate-500 mb-2" data-i18n="markets.moving_avg">Moving Averages</p>
      <div id="maStatus" class="space-y-1.5 text-sm"></div>
    </div>
    <!-- RSI gauge -->
    <div class="bg-slate-800/50 rounded-xl p-3">
      <p class="text-[10px] font-semibold uppercase tracking-widest text-slate-500 mb-2">RSI-14</p>
      <div id="rsiGauge"></div>
    </div>
  </div>

  <!-- Chart + range buttons -->
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-sm font-semibold text-slate-300" data-i18n="markets.hist_title">Price History</h3>
    <div class="flex items-center gap-2">
      <div class="flex gap-1" id="idxRangeBtns">
      <button class="range-btn" data-period="1m"      onclick="switchIdxRange('1m')">1M</button>
      <button class="range-btn" data-period="6m"      onclick="switchIdxRange('6m')">6M</button>
      <button class="range-btn active" data-period="daily"   onclick="switchIdxRange('daily')">1Y</button>
      <button class="range-btn" data-period="weekly"  onclick="switchIdxRange('weekly')">3Y</button>
      <button class="range-btn" data-period="monthly" onclick="switchIdxRange('monthly')">5Y</button>
      </div>
      <button onclick="expandMktsChart('idx')" title="Expand"
              class="text-slate-600 hover:text-slate-300 transition p-1 rounded-lg hover:bg-slate-800">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
        </svg>
      </button>
    </div>
  </div>
  <div style="height:320px"><canvas id="idxChart"></canvas></div>

  <!-- ── MACD ──────────────────────────────────────────────────────── -->
  <div class="mt-5 pt-4 border-t border-slate-800">
    <div class="flex items-center justify-between mb-2">
      <div>
        <span class="text-sm font-semibold text-slate-300">MACD</span>
        <span class="text-xs text-slate-500 ml-2">12 / 26 / 9 — daily</span>
      </div>
      <div class="flex items-center gap-3 text-[11px]">
        <span class="flex items-center gap-1 text-slate-400"><span class="w-3 h-0.5 inline-block" style="background:#38bdf8"></span>MACD</span>
        <span class="flex items-center gap-1 text-slate-400"><span class="w-3 h-0.5 inline-block border-t border-dashed border-current"></span><span style="color:#fb923c" data-i18n="markets.macd_signal">Signal</span></span>
        <span class="flex items-center gap-1 text-slate-400"><span class="w-3 h-3 inline-block rounded-sm" style="background:#6366f144"></span><span data-i18n="markets.macd_histogram">Histogram</span></span>
      </div>
    </div>
    <div style="height:200px"><canvas id="macdChart"></canvas></div>
  </div>

  <!-- ── RSI chart ─────────────────────────────────────────────────── -->
  <div class="mt-5 pt-4 border-t border-slate-800">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-semibold text-slate-300">RSI-14</span>
      <div class="flex items-center gap-3 text-[11px] text-slate-500">
        <span class="text-rose-400" data-i18n="markets.rsi_overbought">70 Overbought</span>
        <span class="text-emerald-400" data-i18n="markets.rsi_oversold">30 Oversold</span>
      </div>
    </div>
    <div style="height:160px"><canvas id="rsiChart"></canvas></div>
  </div>

  <!-- ── Forecast section ──────────────────────────────────────────── -->
  <div class="mt-6 pt-5 border-t border-slate-800">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h3 class="text-sm font-semibold text-slate-300" data-i18n="forecast.title">Price Forecast — 90 Days</h3>
        <p class="text-xs text-slate-500" data-i18n="forecast.desc">Statistical projections from 3 independent models. Not investment advice.</p>
      </div>
      <div class="flex items-center gap-3 flex-wrap justify-end text-[11px]">
        <span class="flex items-center gap-1.5 text-slate-400"><span class="w-3 h-1 rounded-sm inline-block" style="background:#38bdf8"></span><span data-i18n="forecast.actual">Actual</span></span>
        <span class="flex items-center gap-1.5" style="color:#a78bfa"><span class="w-3 h-1 rounded-sm inline-block" style="background:#a78bfa"></span>Prophet</span>
        <span class="flex items-center gap-1.5" style="color:#fb923c"><span class="w-3 h-1 rounded-sm inline-block" style="background:#fb923c"></span>ARIMA</span>
        <span class="flex items-center gap-1.5" style="color:#34d399"><span class="w-3 h-1 rounded-sm inline-block" style="background:#34d399"></span><span data-i18n="forecast.linear">Linear</span></span>
      </div>
    </div>
    <div id="idxForecastLoading" class="flex items-center gap-2 text-sm text-slate-500 py-4">
      <svg class="animate-spin w-4 h-4 text-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
      </svg>
      <span data-i18n="forecast.loading">Running models…</span>
    </div>
    <div style="height:360px; display:none" id="idxForecastWrap"><canvas id="idxForecastChart"></canvas></div>
    <p class="text-[11px] text-slate-600 mt-2" data-i18n="forecast.disclaimer">⚠ Statistical projections only — not financial advice.</p>
  </div>

</div>

<!-- ── Economic Events Calendar ──────────────────────────────────────── -->
<div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mt-6 fade-up" id="econSection">
  <!-- Header row -->
  <div class="flex items-center justify-between cursor-pointer" onclick="toggleEconSection()">
    <div>
      <h2 class="text-sm font-semibold text-slate-200" data-i18n="markets.econ_events_title">Economic Events</h2>
      <p class="text-xs text-slate-500 mt-0.5" data-i18n="markets.econ_events_desc">Key macro releases &amp; central bank decisions this week</p>
    </div>
    <div class="flex items-center gap-2" onclick="event.stopPropagation()">
      <button id="econTranslateBtn" onclick="translateEconEvents()"
              class="text-xs px-3 py-1.5 rounded-lg border border-slate-700 text-slate-400
                     hover:border-indigo-500 hover:text-indigo-300 transition-all">
        <span data-i18n="markets.econ_translate">Translate to Chinese</span>
      </button>
      <span onclick="event.stopPropagation(); toggleEconSection()" class="cursor-pointer p-1">
        <svg id="econChevron" class="w-4 h-4 text-slate-500 transition-transform duration-200 rotate-180"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </span>
    </div>
  </div>
  <!-- Collapsible body -->
  <div id="econCollapse">
    <div id="econLoading" class="text-xs text-slate-600 py-2 mt-3" data-i18n="markets.loading">Loading…</div>
    <div id="econBody" style="display:none" class="mt-3">
      <!-- Region filter buttons -->
      <div id="econFilters" class="flex flex-wrap gap-1.5 mb-3">
        <button onclick="filterEcon('all')" id="econFilter-all"
                class="econ-filter-btn px-2.5 py-1 rounded-lg text-[11px] font-medium border border-slate-700 text-slate-400 hover:border-indigo-500 hover:text-indigo-300 transition-all"
                data-i18n="markets.econ_filter_all">All</button>
        <button onclick="filterEcon('us')" id="econFilter-us"
                class="econ-filter-btn px-2.5 py-1 rounded-lg text-[11px] font-medium border border-slate-700 text-slate-400 hover:border-indigo-500 hover:text-indigo-300 transition-all">US</button>
        <button onclick="filterEcon('eu')" id="econFilter-eu"
                class="econ-filter-btn px-2.5 py-1 rounded-lg text-[11px] font-medium border border-slate-700 text-slate-400 hover:border-indigo-500 hover:text-indigo-300 transition-all">EU</button>
        <button onclick="filterEcon('cn')" id="econFilter-cn"
                class="econ-filter-btn px-2.5 py-1 rounded-lg text-[11px] font-medium border border-slate-700 text-slate-400 hover:border-indigo-500 hover:text-indigo-300 transition-all">CN</button>
        <button onclick="filterEcon('jp')" id="econFilter-jp"
                class="econ-filter-btn px-2.5 py-1 rounded-lg text-[11px] font-medium border border-slate-700 text-slate-400 hover:border-indigo-500 hover:text-indigo-300 transition-all">JP</button>
        <button onclick="filterEcon('high')" id="econFilter-high"
                class="econ-filter-btn active px-2.5 py-1 rounded-lg text-[11px] font-medium border border-rose-500 text-rose-300 hover:border-rose-500 hover:text-rose-300 transition-all"
                data-i18n="markets.econ_filter_high">High Impact</button>
        <label class="flex items-center gap-1.5 ml-auto text-[11px] text-slate-400 cursor-pointer select-none">
          <input type="checkbox" id="econHidePast" onchange="_renderEconTable(_econData)"
                 class="rounded border-slate-600 bg-slate-800 text-brand focus:ring-brand" checked>
          <span data-i18n="markets.econ_hide_past">Hide past</span>
        </label>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-xs text-left">
          <thead>
            <tr class="border-b border-slate-800 text-slate-500 text-[10px] uppercase tracking-wider">
              <th class="pb-2 pr-3 font-medium" data-i18n="markets.econ_col_date">Date</th>
              <th class="pb-2 pr-3 font-medium" id="econTimeColHeader"><span data-i18n="markets.econ_col_time">Time</span></th>
              <th class="pb-2 pr-3 font-medium" data-i18n="markets.econ_col_country">Country</th>
              <th class="pb-2 pr-3 font-medium" data-i18n="markets.econ_col_event">Event</th>
              <th class="pb-2 pr-3 font-medium" data-i18n="markets.econ_col_impact">Impact</th>
              <th class="pb-2 pr-3 font-medium text-right" data-i18n="markets.econ_col_actual">Actual</th>
              <th class="pb-2 pr-3 font-medium text-right" data-i18n="markets.econ_col_forecast">Forecast</th>
              <th class="pb-2 font-medium text-right" data-i18n="markets.econ_col_previous">Previous</th>
            </tr>
          </thead>
          <tbody id="econTableBody" class="divide-y divide-slate-800/60"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div><!-- #marketsContent -->

<script>
const TICKER = '';  // not used here but referenced by base template helpers


let _mkData   = null;
let _curIdx   = 'spx';
let _curRange = 'daily';
let _idxChartInst     = null;
let _macdChartInst    = null;
let _rsiChartInst     = null;
let _vixChartInst     = null;
let _idxForecastInst  = null;
let _forecastCache    = {};  // key → forecast data

// Yahoo Finance symbols per index key (for forecast API)
const IDX_SYMBOLS = {
  spx: '%5EGSPC', ixic: '%5EIXIC', dji: '%5EDJI',
  ftse: '%5EFTSE', n225: '%5EN225', sse: '000001.SS', twii: '%5ETWII', kospi: '%5EKS11',
};
const IDX_COLORS = {
  spx: '#6366f1', ixic: '#38bdf8', dji: '#fb923c',
  ftse: '#e879f9', n225: '#f472b6', sse: '#f87171', twii: '#34d399', kospi: '#fbbf24',
};
const IDX_ALL_KEYS = ['spx', 'ixic', 'dji', 'ftse', 'n225', 'sse', 'twii', 'kospi'];
const IDX_LABELS = {
  spx: 'S&P 500', ixic: 'Nasdaq', dji: 'Dow Jones',
  ftse: 'FTSE 100', n225: 'Nikkei 225', sse: 'Shanghai', twii: 'Taiwan', kospi: 'KOSPI',
};
function idxLabel(key) {
  return (typeof I18n !== 'undefined' && I18n.tIdx) ? I18n.tIdx(key) : (IDX_LABELS[key] || key.toUpperCase());
}
const GRID_COL = '#1e293b', TICK_COL = '#64748b';

function _fmt(v, prefix='', suffix='', dec=2) {
  if (v == null) return '—';
  const n = typeof v === 'number' ? v : parseFloat(v);
  if (isNaN(n)) return '—';
  return prefix + n.toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec }) + suffix;
}
function _chgClass(v) { return v == null ? 'neutral' : v >= 0 ? 'up' : 'down'; }
function _chgSign(v)  { return v == null ? '' : v >= 0 ? '+' : ''; }

// ── Compute YTD from daily data when server value is null ────────────
function _computeYtd(d) {
  if (d.ytd != null) return d.ytd;
  const daily = d.daily || {};
  const dates  = daily.dates  || [];
  const prices = daily.prices || [];
  if (!dates.length || !d.current) return null;
  const thisYear = new Date().getFullYear().toString();
  const idx = dates.findIndex(dt => dt.startsWith(thisYear));
  if (idx < 0) return null;
  const first = prices[idx];
  if (!first || first <= 0) return null;
  return Math.round((d.current - first) / first * 10000) / 100;
}

// ── Render index snapshot cards ───────────────────────────────────────
function renderCards(data) {
  document.getElementById('indexCards').innerHTML = IDX_ALL_KEYS.map(k => {
    const d = data.indices[k] || {};
    const col = IDX_COLORS[k];
    const label = idxLabel(k);
    const chgCls = _chgClass(d.day_chg);
    const ytd    = _computeYtd(d);
    const ytdCls = _chgClass(ytd);
    return `
    <button onclick="switchIdx('${k}', true)"
            class="bg-slate-900 border border-slate-800 rounded-2xl p-4 text-left
                   hover:border-slate-600 active:scale-95 transition-all cursor-pointer group">
      <div class="flex items-center justify-between mb-1">
        <span class="text-xs font-semibold tracking-wide truncate" style="color:${col}">${label}</span>
        <span class="text-[10px] text-slate-600 ml-1 shrink-0">${d.symbol || ''}</span>
      </div>
      <div class="text-xl font-bold text-slate-100 tabular-nums">${d.current != null ? d.current.toLocaleString(undefined,{maximumFractionDigits:2}) : '—'}</div>
      <div class="flex items-center gap-2 mt-1 flex-wrap">
        <span class="text-sm font-semibold ${chgCls}">${_chgSign(d.day_chg)}${_fmt(d.day_chg,'','%',2)}</span>
        <span class="text-xs ${ytdCls}">${_chgSign(ytd)}${_fmt(ytd,'','% YTD',1)}</span>
      </div>
    </button>`;
  }).join('');
}

// ── VIX ──────────────────────────────────────────────────────────────
function renderVix(vix) {
  if (!vix) return;
  const badgeEl = document.getElementById('vixBadge');
  const level   = vix.current;
  let label = '', col = '';
  if (level < 15)      { label = I18n.t('markets.vix_calm')    || 'Calm';     col = '#34d399'; }
  else if (level < 20) { label = I18n.t('markets.vix_normal')  || 'Normal';   col = '#a5b4fc'; }
  else if (level < 30) { label = I18n.t('markets.vix_elevated')|| 'Elevated'; col = '#fb923c'; }
  else                  { label = I18n.t('markets.vix_extreme') || 'Extreme';  col = '#f87171'; }

  badgeEl.innerHTML = `
    <div class="text-2xl font-bold tabular-nums" style="color:${col}">${level?.toFixed(2) ?? '—'}</div>
    <div class="text-xs font-semibold mt-0.5" style="color:${col}">${label}</div>
    <div class="text-xs text-slate-500">${_chgSign(vix.day_chg)}${_fmt(vix.day_chg, '', '%', 2)} today</div>`;

  if (_vixChartInst) { _vixChartInst.destroy(); _vixChartInst = null; }
  const dates  = vix.weekly?.dates  || [];
  const prices = vix.weekly?.prices || [];
  _vixChartInst = new Chart(document.getElementById('vixChart'), {
    type: 'line',
    data: { labels: dates, datasets: [{
      label: 'VIX', data: prices,
      borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.07)',
      borderWidth: 2, pointRadius: 0, fill: true, tension: 0.3, spanGaps: true,
    }]},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: {
        x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 6, maxRotation: 0, font: { size: 9 } } },
        y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, font: { size: 9 } } },
      },
    },
    plugins: [{
      afterDraw(chart) {
        const { ctx: c, chartArea: a, scales: { y } } = chart;
        [[20, '#fb923c', I18n.t('markets.vix_elevated') || 'Elevated'], [30, '#f87171', I18n.t('markets.vix_extreme') || 'Extreme']].forEach(([lvl, clr, lbl]) => {
          const py = y.getPixelForValue(lvl);
          if (py < a.top || py > a.bottom) return;
          c.save(); c.strokeStyle = clr + '66'; c.lineWidth = 1; c.setLineDash([4, 4]);
          c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
          c.fillStyle = clr; c.font = '10px Inter,sans-serif';
          c.fillText(lvl + ' ' + lbl, a.right - 70, py - 3); c.restore();
        });
      },
    }],
  });
}

// ── Sector bars ───────────────────────────────────────────────────────
function renderSectors(sectors) {
  const el = document.getElementById('sectorBars');
  if (!sectors || !sectors.length) { el.innerHTML = '<p class="text-xs text-slate-600">' + (I18n.t('markets.no_data') || 'No data') + '.</p>'; return; }
  const sorted = [...sectors].sort((a, b) => (b.day_chg ?? -999) - (a.day_chg ?? -999));
  const maxAbs = Math.max(...sorted.map(s => Math.abs(s.day_chg ?? 0)), 1);
  el.innerHTML = sorted.map(s => {
    const pct = s.day_chg;
    const col = pct == null ? '#475569' : pct >= 0 ? '#34d399' : '#f87171';
    const w   = pct == null ? 0 : Math.round(Math.abs(pct) / maxAbs * 100);
    const sign = _chgSign(pct);
    const labelKey = 'markets.sector.' + s.label;
    const label = (typeof I18n !== 'undefined' && I18n.t(labelKey)) || s.label;
    return `
    <div class="flex items-center gap-2">
      <span class="text-xs text-slate-400 w-28 shrink-0">${label}</span>
      <div class="flex-1 bg-slate-800 rounded-full h-2 overflow-hidden">
        <div class="bar-fill" style="width:${w}%; background:${col}"></div>
      </div>
      <span class="text-xs font-semibold tabular-nums w-14 text-right" style="color:${col}">
        ${pct != null ? sign + pct.toFixed(2) + '%' : '—'}
      </span>
    </div>`;
  }).join('');
}

// ── Per-index stats & chart ───────────────────────────────────────────
function renderIdxStats(key, data) {
  const d = data.indices[key] || {};
  const fmtPt = v => v != null ? v.toLocaleString(undefined, { maximumFractionDigits: 2 }) : '—';
  const fmtPct = v => v != null ? (v >= 0 ? '+' : '') + v.toFixed(2) + '%' : '—';
  const stats = [
    { label: I18n.t('markets.price') || 'Price',     val: fmtPt(d.current),   cls: '' },
    { label: I18n.t('markets.day_chg') || 'Day Chg', val: fmtPct(d.day_chg), cls: _chgClass(d.day_chg) },
    { label: 'YTD', val: fmtPct(_computeYtd(d)), cls: _chgClass(_computeYtd(d)) },
    { label: I18n.t('markets.52w_high') || '52W Hi', val: fmtPt(d.hi52),      cls: '' },
    { label: I18n.t('markets.52w_low')  || '52W Lo', val: fmtPt(d.lo52),      cls: '' },
    { label: I18n.t('markets.pe')       || 'P/E',    val: d.pe != null ? d.pe.toFixed(1) + 'x' : '—', cls: '' },
    { label: I18n.t('markets.volume')   || 'Volume', val: d.volume != null ? (d.volume / 1e9).toFixed(1) + 'B' : '—', cls: '' },
  ];
  document.getElementById('idxStats').innerHTML = stats.map(s => `
    <div class="stat-card">
      <div class="stat-label">${s.label}</div>
      <div class="stat-val ${s.cls}">${s.val}</div>
    </div>`).join('');

  // Moving averages
  const cur = d.current, ma50 = d.ma50, ma200 = d.ma200;
  const maRows = [];
  if (ma50 != null) {
    const diff = cur != null ? ((cur - ma50) / ma50 * 100).toFixed(1) : null;
    const cls  = cur != null && cur > ma50 ? 'up' : 'down';
    maRows.push(`<div class="flex justify-between"><span class="text-slate-400">${I18n.t('markets.ma50') || '50-day MA'}</span>
      <span>${fmtPt(ma50)} <span class="${cls} text-xs">(${diff != null ? (diff >= 0 ? '+' : '') + diff + '%' : '—'})</span></span></div>`);
  }
  if (ma200 != null) {
    const diff = cur != null ? ((cur - ma200) / ma200 * 100).toFixed(1) : null;
    const cls  = cur != null && cur > ma200 ? 'up' : 'down';
    let cross = '';
    if (ma50 != null && ma200 != null) {
      cross = ma50 > ma200
        ? `<span class="text-[10px] text-emerald-400 ml-1 font-semibold">${I18n.t('markets.golden_cross') || 'Golden Cross'}</span>`
        : `<span class="text-[10px] text-rose-400 ml-1 font-semibold">${I18n.t('markets.death_cross') || 'Death Cross'}</span>`;
    }
    maRows.push(`<div class="flex justify-between"><span class="text-slate-400">${I18n.t('markets.ma200') || '200-day MA'}${cross}</span>
      <span>${fmtPt(ma200)} <span class="${cls} text-xs">(${diff != null ? (diff >= 0 ? '+' : '') + diff + '%' : '—'})</span></span></div>`);
  }
  document.getElementById('maStatus').innerHTML = maRows.length ? maRows.join('') : `<span class="text-slate-600 text-xs">${I18n.t('markets.no_data') || 'No data'}</span>`;

  // RSI gauge
  const rsi = d.rsi14;
  const rsiEl = document.getElementById('rsiGauge');
  if (rsi == null) { rsiEl.innerHTML = `<span class="text-slate-600 text-xs">${I18n.t('markets.no_data') || 'No data'}</span>`; }
  else {
    let zone = '', zoneCol = '';
    if (rsi > 70)      { zone = I18n.t('markets.rsi_zone_ob')      || 'Overbought'; zoneCol = '#f87171'; }
    else if (rsi > 55) { zone = I18n.t('markets.rsi_zone_bullish') || 'Bullish';    zoneCol = '#34d399'; }
    else if (rsi > 45) { zone = I18n.t('markets.rsi_zone_neutral') || 'Neutral';    zoneCol = '#94a3b8'; }
    else if (rsi > 30) { zone = I18n.t('markets.rsi_zone_bearish') || 'Bearish';    zoneCol = '#fb923c'; }
    else                { zone = I18n.t('markets.rsi_zone_os')     || 'Oversold';   zoneCol = '#a78bfa'; }
    const pct = Math.round(rsi);
    rsiEl.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <span class="text-xl font-bold text-slate-100">${rsi.toFixed(1)}</span>
        <span class="rsi-zone font-semibold" style="background:${zoneCol}22;color:${zoneCol}">${zone}</span>
      </div>
      <div class="bg-slate-700 rounded-full h-2 overflow-hidden">
        <div class="bar-fill" style="width:${pct}%; background:${zoneCol}"></div>
      </div>
      <div class="flex justify-between text-[10px] text-slate-600 mt-1"><span>0</span><span>30</span><span>50</span><span>70</span><span>100</span></div>`;
  }
}

function renderIdxChart(key, range, data) {
  const d = data.indices[key] || {};
  // 1M and 6M slice from daily data
  let dates, prices;
  if (range === '1m' || range === '6m') {
    const src = d['daily'] || {};
    const allDates  = src.dates  || [];
    const allPrices = src.prices || [];
    const cutDays   = range === '1m' ? 21 : 126;  // ~1 month or ~6 months of trading days
    dates  = allDates.slice(-cutDays);
    prices = allPrices.slice(-cutDays);
  } else {
    const series = d[range] || d['weekly'] || {};
    dates  = series.dates  || [];
    prices = series.prices || [];
  }
  const col = IDX_COLORS[key] || '#6366f1';

  if (_idxChartInst) { _idxChartInst.destroy(); _idxChartInst = null; }
  _idxChartInst = new Chart(document.getElementById('idxChart'), {
    type: 'line',
    data: { labels: dates, datasets: [{
      label: idxLabel(key),
      data: prices,
      borderColor: col, backgroundColor: col + '0d',
      borderWidth: 2, pointRadius: 0, pointHoverRadius: 5,
      fill: true, tension: 0.3, spanGaps: true,
    }]},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false, callbacks: { label: c => ` ${c.raw?.toLocaleString(undefined, {maximumFractionDigits: 2})}` } },
      },
      scales: {
        x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 8, maxRotation: 0 } },
        y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, callback: v => v.toLocaleString() } },
      },
      interaction: { mode: 'index', intersect: false },
    },
    plugins: [{
      afterDraw(chart) {
        // Draw MA-200 and MA-50 as reference lines for daily-based ranges
        if (range !== 'daily' && range !== '1m' && range !== '6m') return;
        const { ctx: c, chartArea: a, scales: { y } } = chart;
        [[d.ma50, '#34d399', I18n.t('markets.ma50') || '50MA'],
         [d.ma200,'#fb923c', I18n.t('markets.ma200') || '200MA']].forEach(([val, clr, lbl]) => {
          if (val == null) return;
          const py = y.getPixelForValue(val);
          if (py < a.top || py > a.bottom) return;
          c.save(); c.strokeStyle = clr + '88'; c.lineWidth = 1.5; c.setLineDash([5, 4]);
          c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
          c.fillStyle = clr; c.font = '10px Inter,sans-serif';
          c.fillText(lbl + ' ' + val.toLocaleString(undefined, {maximumFractionDigits: 0}), a.left + 6, py - 4); c.restore();
        });
      },
    }],
  });
}

// ── Technical indicator helpers ───────────────────────────────────────
function _ema(vals, period) {
  const k = 2 / (period + 1);
  const result = new Array(vals.length).fill(null);
  // Find first non-null index
  let start = vals.findIndex(v => v != null);
  if (start < 0) return result;
  result[start] = vals[start];
  for (let i = start + 1; i < vals.length; i++) {
    if (vals[i] == null) { result[i] = result[i - 1]; continue; }
    result[i] = vals[i] * k + result[i - 1] * (1 - k);
  }
  return result;
}

function _computeMacd(prices) {
  // Returns { dates, macd, signal, histogram } aligned to original dates
  const ema12 = _ema(prices, 12);
  const ema26 = _ema(prices, 26);
  const macdLine = prices.map((_, i) => (ema12[i] != null && ema26[i] != null) ? ema12[i] - ema26[i] : null);
  const signal   = _ema(macdLine, 9);
  const histogram = macdLine.map((v, i) => (v != null && signal[i] != null) ? v - signal[i] : null);
  return { macdLine, signal, histogram };
}

function _computeRsiHistory(prices, period = 14) {
  const result = new Array(prices.length).fill(null);
  if (prices.length < period + 1) return result;
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = prices[i] - prices[i - 1];
    if (diff > 0) gains += diff; else losses -= diff;
  }
  let avgGain = gains / period, avgLoss = losses / period;
  result[period] = avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
  for (let i = period + 1; i < prices.length; i++) {
    const diff = prices[i] - prices[i - 1];
    const g = diff > 0 ? diff : 0;
    const l = diff < 0 ? -diff : 0;
    avgGain = (avgGain * (period - 1) + g) / period;
    avgLoss = (avgLoss * (period - 1) + l) / period;
    result[i] = avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
  }
  return result;
}

function renderMacdChart(key, data, range) {
  if (_macdChartInst) { _macdChartInst.destroy(); _macdChartInst = null; }
  const d = data.indices[key] || {};
  // Compute MACD on full daily data, then slice to the visible range
  const dailySeries = d['daily'] || {};
  const allDates  = dailySeries.dates  || [];
  const allPrices = dailySeries.prices || [];
  if (!allPrices.length) return;

  // Compute on full series so EMAs are correctly warmed up, then slice view
  const { macdLine, signal, histogram } = _computeMacd(allPrices);

  let dates, macdSlice, signalSlice, histSlice;
  const cutDays = range === '1m' ? 21 : range === '6m' ? 126 : allDates.length;
  dates       = allDates.slice(-cutDays);
  macdSlice   = macdLine.slice(-cutDays);
  signalSlice = signal.slice(-cutDays);
  histSlice   = histogram.slice(-cutDays);

  // Histogram bar colors: positive = green, negative = red
  const histColors  = histSlice.map(v => v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.55)' : 'rgba(248,113,113,0.55)');
  const histBorders = histSlice.map(v => v == null ? 'transparent' : v >= 0 ? '#34d399' : '#f87171');

  _macdChartInst = new Chart(document.getElementById('macdChart'), {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          type: 'bar',
          label: 'Histogram',
          data: histSlice,
          backgroundColor: histColors,
          borderColor: histBorders,
          borderWidth: 1,
          order: 3,
        },
        {
          type: 'line',
          label: 'MACD',
          data: macdSlice,
          borderColor: '#38bdf8',
          backgroundColor: 'transparent',
          borderWidth: 1.5, pointRadius: 0, spanGaps: true, tension: 0.2, order: 1,
          elements: { point: { hitRadius: 6, radius: 0, hoverRadius: 3 } },
        },
        {
          type: 'line',
          label: 'Signal',
          data: signalSlice,
          borderColor: '#fb923c',
          backgroundColor: 'transparent',
          borderWidth: 1.5, pointRadius: 0, spanGaps: true, tension: 0.2, order: 2,
          borderDash: [4, 3],
          elements: { point: { hitRadius: 6, radius: 0, hoverRadius: 3 } },
        },
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: {
            label: c => {
              const v = c.raw;
              if (v == null) return null;
              return ` ${c.dataset.label}: ${v.toFixed(2)}`;
            },
          },
        },
      },
      scales: {
        x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 8, maxRotation: 0 } },
        y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, callback: v => v.toFixed(1) } },
      },
      interaction: { mode: 'index', intersect: false },
    },
    plugins: [{
      afterDraw(chart) {
        const { ctx: c, chartArea: a, scales: { y } } = chart;
        const z = y.getPixelForValue(0);
        if (z >= a.top && z <= a.bottom) {
          c.save(); c.strokeStyle = 'rgba(148,163,184,0.3)'; c.lineWidth = 1;
          c.beginPath(); c.moveTo(a.left, z); c.lineTo(a.right, z); c.stroke(); c.restore();
        }
      },
    }],
  });
}

function renderRsiChart(key, data, range) {
  if (_rsiChartInst) { _rsiChartInst.destroy(); _rsiChartInst = null; }
  const d = data.indices[key] || {};
  const dailySeries = d['daily'] || {};
  const allDates  = dailySeries.dates  || [];
  const allPrices = dailySeries.prices || [];
  if (!allPrices.length) return;

  // Compute on full series so warm-up is correct, then slice to view
  const allRsi = _computeRsiHistory(allPrices, 14);
  const cutDays = range === '1m' ? 21 : range === '6m' ? 126 : allDates.length;
  const dates   = allDates.slice(-cutDays);
  const rsiVals = allRsi.slice(-cutDays);

  // Color the RSI line by zone
  _rsiChartInst = new Chart(document.getElementById('rsiChart'), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'RSI-14',
        data: rsiVals,
        borderColor: '#a78bfa',
        backgroundColor: 'rgba(167,139,250,0.06)',
        borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.2, spanGaps: true,
        elements: { point: { hitRadius: 6, radius: 0, hoverRadius: 3 } },
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: { label: c => c.raw != null ? ` RSI: ${c.raw.toFixed(1)}` : null },
        },
      },
      scales: {
        x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 8, maxRotation: 0 } },
        y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL }, min: 0, max: 100,
             ticks: { color: TICK_COL, stepSize: 25, callback: v => v } },
      },
      interaction: { mode: 'index', intersect: false },
    },
    plugins: [{
      afterDraw(chart) {
        const { ctx: c, chartArea: a, scales: { y } } = chart;
        [[70, '#f87171', 'OB 70'], [30, '#34d399', 'OS 30']].forEach(([lvl, clr, lbl]) => {
          const py = y.getPixelForValue(lvl);
          if (py < a.top || py > a.bottom) return;
          c.save();
          c.strokeStyle = clr + '55'; c.lineWidth = 1; c.setLineDash([4, 3]);
          c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
          c.fillStyle = clr; c.font = '10px Inter,sans-serif';
          c.fillText(lbl, a.right - 36, py - 3); c.restore();
        });
        // Shade overbought zone (70-100)
        const y70 = y.getPixelForValue(70), y100 = y.getPixelForValue(100);
        c.save(); c.fillStyle = 'rgba(248,113,113,0.05)';
        c.fillRect(a.left, Math.min(y70, y100), a.width, Math.abs(y70 - y100)); c.restore();
        // Shade oversold zone (0-30)
        const y30 = y.getPixelForValue(30), y0 = y.getPixelForValue(0);
        c.save(); c.fillStyle = 'rgba(52,211,153,0.05)';
        c.fillRect(a.left, Math.min(y30, y0), a.width, Math.abs(y30 - y0)); c.restore();
      },
    }],
  });
}

// ── Synchronized cross-chart hover ───────────────────────────────────
// Syncs tooltips across price/MACD/RSI charts by matching the hovered date.
// Price chart may use weekly/monthly data while MACD/RSI always use daily,
// so we find the nearest date in the destination chart rather than using
// the same numeric index.
let _syncHoverCleanup = null;  // function to remove previous listeners

function _syncHover() {
  // Remove previous listeners
  if (_syncHoverCleanup) { _syncHoverCleanup(); _syncHoverCleanup = null; }

  const canvasIds = ['idxChart', 'macdChart', 'rsiChart'];
  function _getChart(id) {
    const c = document.getElementById(id);
    return c ? Chart.getChart(c) : null;
  }

  const handlers = [];
  canvasIds.forEach(srcId => {
    const canvas = document.getElementById(srcId);
    if (!canvas) return;

    function onMove(evt) {
      const src = _getChart(srcId);
      if (!src) return;
      const pts = src.getElementsAtEventForMode(evt, 'index', { intersect: false }, false);
      const srcIdx = pts.length ? pts[0].index : null;
      if (srcIdx == null) return;
      const srcDate = src.data.labels[srcIdx];

      canvasIds.forEach(dstId => {
        if (dstId === srcId) return;
        const dst = _getChart(dstId);
        if (!dst) return;
        const xScale = dst.scales['x'];
        if (!xScale) return;

        const dstLabels = dst.data.labels || [];
        let dstIdx = dstLabels.indexOf(srcDate);
        if (dstIdx < 0) {
          const prefix = (srcDate || '').slice(0, 7);
          dstIdx = dstLabels.findIndex(l => (l || '').startsWith(prefix));
        }
        if (dstIdx < 0) return;

        const x = xScale.getPixelForValue(dstIdx);
        dst.tooltip.setActiveElements(
          dst.data.datasets.map((_, di) => ({ datasetIndex: di, index: dstIdx }))
            .filter(pt => {
              const meta = dst.getDatasetMeta(pt.datasetIndex);
              return meta.visible && dst.data.datasets[pt.datasetIndex].data[dstIdx] != null;
            }),
          { x, y: dst.chartArea.top }
        );
        dst.update('none');
      });
    }

    function onLeave() {
      canvasIds.forEach(id => {
        const c = _getChart(id);
        if (c) { c.tooltip.setActiveElements([], {}); c.update('none'); }
      });
    }

    canvas.addEventListener('mousemove', onMove);
    canvas.addEventListener('mouseleave', onLeave);
    handlers.push({ canvas, onMove, onLeave });
  });

  _syncHoverCleanup = () => {
    handlers.forEach(({ canvas, onMove, onLeave }) => {
      canvas.removeEventListener('mousemove', onMove);
      canvas.removeEventListener('mouseleave', onLeave);
    });
  };
}

function switchIdx(key, scroll) {
  _curIdx = key;
  IDX_ALL_KEYS.forEach(k => {
    const id = 'tab' + k.charAt(0).toUpperCase() + k.slice(1);
    const btn = document.getElementById(id);
    if (btn) btn.classList.toggle('active', k === key);
  });
  if (_mkData) {
    renderIdxStats(key, _mkData);
    renderIdxChart(key, _curRange, _mkData);
    renderMacdChart(key, _mkData, _curRange);
    renderRsiChart(key, _mkData, _curRange);
    _syncHover();
    loadIdxForecast(key);
  }
  if (scroll) {
    const el = document.getElementById('idxDetail');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function switchIdxRange(range) {
  _curRange = range;
  document.querySelectorAll('#idxRangeBtns .range-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.period === range);
  });
  if (_mkData) {
    renderIdxChart(_curIdx, range, _mkData);
    renderMacdChart(_curIdx, _mkData, range);
    renderRsiChart(_curIdx, _mkData, range);
    _syncHover();
  }
}

// ── Forecast for selected index ───────────────────────────────────────
function _buildForecastChart(result) {
  const gridCol = GRID_COL, tickCol = TICK_COL;
  const trainDates  = (result.train || []).map(p => p.date);
  const trainPrices = (result.train || []).map(p => p.value);
  const fcModels    = ['prophet', 'arima', 'linear'];
  const modelColors = { prophet: '#a78bfa', arima: '#fb923c', linear: '#34d399' };

  const firstFC  = fcModels.map(m => result[m]?.forecast || []).find(fc => fc.length > 0) || [];
  const fcDates  = firstFC.map(p => p.date);
  const allDates = [...trainDates, ...fcDates];
  const actualData = [...trainPrices, ...fcDates.map(() => null)];

  const fcAvailable = [];
  const datasets = [{
    label: I18n.t('forecast.actual') || 'Actual',
    data: actualData,
    borderColor: '#38bdf8', backgroundColor: 'rgba(56,189,248,0.06)',
    borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, hitRadius: 8,
    fill: 'origin', tension: 0.3, spanGaps: true,
    elements: { point: { hitRadius: 8, radius: 0, hoverRadius: 4 } },
  }];

  fcModels.forEach((m, idx) => {
    const fc = result[m]?.forecast || [];
    if (!fc.length) return;
    const padLen = trainDates.length > 0 ? trainDates.length - 1 : 0;
    const col = modelColors[m];
    const fVals  = [...Array(padLen).fill(null), trainPrices[trainPrices.length - 1], ...fc.map(p => p.value)];
    const loVals = [...Array(padLen).fill(null), trainPrices[trainPrices.length - 1], ...fc.map(p => p.lo)];
    const hiVals = [...Array(padLen).fill(null), trainPrices[trainPrices.length - 1], ...fc.map(p => p.hi)];
    fcAvailable.push({ m, loVals, hiVals, color: col });
    datasets.push({
      label: I18n.t('forecast.' + m) || m.toUpperCase(),
      data: fVals,
      borderColor: col, backgroundColor: 'transparent',
      borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, hitRadius: 8,
      borderDash: [5, 3], tension: 0.3, spanGaps: true,
      elements: { point: { hitRadius: 8, radius: 0, hoverRadius: 4 } },
    });
  });

  const boundaryIdx = trainDates.length - 1;
  return new Chart(document.getElementById('idxForecastChart'), {
    type: 'line',
    data: { labels: allDates, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'top', labels: { color: tickCol, font: { size: 10 } } },
        tooltip: { mode: 'index', intersect: false },
      },
      scales: {
        x: { grid: { color: gridCol }, ticks: { color: tickCol, maxTicksLimit: 8, maxRotation: 0 } },
        y: { grid: { color: gridCol }, ticks: { color: tickCol, callback: v => v.toLocaleString() } },
      },
    },
    plugins: [{
      afterDraw(chart) {
        const { ctx: c, chartArea: a, scales: { x, y } } = chart;
        fcAvailable.forEach(({ loVals, hiVals, color }) => {
          const len = Math.min(loVals.length, hiVals.length, allDates.length);
          c.save(); c.beginPath();
          let started = false;
          for (let i = 0; i < len; i++) {
            if (hiVals[i] == null) continue;
            const px = x.getPixelForValue(i), py = y.getPixelForValue(hiVals[i]);
            if (!started) { c.moveTo(px, py); started = true; } else c.lineTo(px, py);
          }
          for (let i = len - 1; i >= 0; i--) {
            if (loVals[i] == null) continue;
            c.lineTo(x.getPixelForValue(i), y.getPixelForValue(loVals[i]));
          }
          c.closePath(); c.fillStyle = color + '28'; c.fill(); c.restore();
        });
        if (boundaryIdx >= 0 && boundaryIdx < allDates.length) {
          const bx = x.getPixelForValue(boundaryIdx);
          if (bx >= a.left && bx <= a.right) {
            c.save(); c.strokeStyle = 'rgba(100,116,139,0.5)'; c.lineWidth = 1; c.setLineDash([4,4]);
            c.beginPath(); c.moveTo(bx, a.top); c.lineTo(bx, a.bottom); c.stroke();
            c.fillStyle = '#64748b'; c.font = '10px Inter,sans-serif';
            c.fillText(I18n.t('markets.forecast_arrow') || 'Forecast →', bx + 4, a.top + 12); c.restore();
          }
        }
      },
    }],
  });
}

async function loadIdxForecast(key) {
  const loadEl = document.getElementById('idxForecastLoading');
  const wrapEl = document.getElementById('idxForecastWrap');
  if (!loadEl || !wrapEl) return;

  // Show loading, hide chart
  loadEl.style.display = 'flex';
  wrapEl.style.display = 'none';
  if (_idxForecastInst) { _idxForecastInst.destroy(); _idxForecastInst = null; }

  // Use cache if available
  if (_forecastCache[key]) {
    loadEl.style.display = 'none';
    wrapEl.style.display = '';
    _idxForecastInst = _buildForecastChart(_forecastCache[key]);
    return;
  }

  const sym = IDX_SYMBOLS[key];
  if (!sym) { loadEl.style.display = 'none'; return; }

  try {
    const resp = await fetch(`/api/forecast/${encodeURIComponent(sym)}`);
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    _forecastCache[key] = result;
    loadEl.style.display = 'none';
    wrapEl.style.display = '';
    _idxForecastInst = _buildForecastChart(result);
  } catch(e) {
    loadEl.innerHTML = `<span class="text-slate-600 text-xs">${I18n.t('forecast.failed') || 'Forecast unavailable.'} ${e.message}</span>`;
  }
}

// ── Fear & Greed ──────────────────────────────────────────────────────
let _fgChartInst = null;

function renderFearGreed(data) {
  if (!data || data.error) {
    document.getElementById('fgLoading').textContent = data?.error || I18n.t('markets.unavailable') || 'Unavailable';
    return;
  }

  const score  = data.score != null ? Math.round(data.score) : null;
  const rating = data.rating || '';

  // Color mapping by rating keyword
  function _fgColor(r) {
    const lo = (r || '').toLowerCase();
    if (lo.includes('extreme fear')) return '#7f1d1d';
    if (lo.includes('fear'))         return '#ef4444';
    if (lo.includes('extreme greed'))return '#065f46';
    if (lo.includes('greed'))        return '#10b981';
    return '#94a3b8';
  }
  const col = _fgColor(rating);

  // Badge
  document.getElementById('fgBadge').innerHTML = score != null
    ? `<div class="text-2xl font-bold tabular-nums" style="color:${col}">${score}</div>
       <div class="text-xs font-semibold mt-0.5" style="color:${col}">${rating}</div>`
    : '<div class="text-slate-600 text-xs">—</div>';

  // Needle position (0–100 → 0–100%)
  if (score != null) {
    document.getElementById('fgNeedle').style.left = score + '%';
  }

  // Comparison row
  const comps = [
    { label: I18n.t('markets.fg_prev_close') || 'Prev Close', val: data.prev_close },
    { label: I18n.t('markets.fg_prev_week')  || 'Prev Week',  val: data.prev_week  },
    { label: I18n.t('markets.fg_prev_month') || 'Prev Month', val: data.prev_month },
    { label: I18n.t('markets.fg_prev_year')  || 'Prev Year',  val: data.prev_year  },
  ];
  document.getElementById('fgCompare').innerHTML = comps.map(c => {
    if (c.val == null) return '';
    const v   = Math.round(c.val);
    const diff = score != null ? score - v : null;
    const col2 = diff == null ? '#94a3b8' : diff >= 0 ? '#34d399' : '#f87171';
    const sign = diff != null && diff >= 0 ? '+' : '';
    return `<div class="bg-slate-800/60 rounded-lg p-1.5 text-center">
      <div class="text-[9px] text-slate-500 mb-0.5">${c.label}</div>
      <div class="text-xs font-semibold text-slate-300">${v}</div>
      ${diff != null ? `<div class="text-[9px]" style="color:${col2}">${sign}${diff}</div>` : ''}
    </div>`;
  }).join('');

  // History chart
  const hist = (data.history || []).filter(h => h.t && h.y != null);
  if (hist.length && document.getElementById('fgChart')) {
    const labels  = hist.map(h => {
      const d = new Date(h.t);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: '2-digit' });
    });
    const values  = hist.map(h => h.y);
    const ptColors = hist.map(h => _fgColor(h.rating));

    if (_fgChartInst) { _fgChartInst.destroy(); _fgChartInst = null; }
    _fgChartInst = new Chart(document.getElementById('fgChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Fear & Greed',
          data: values,
          borderColor: '#a78bfa',
          backgroundColor: 'rgba(167,139,250,0.07)',
          borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 3,
          fill: true, tension: 0.3, spanGaps: true,
        }],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: {
              label: c => ` ${c.raw?.toFixed(1)} — ${hist[c.dataIndex]?.rating || ''}`,
            },
          },
        },
        scales: {
          x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 4, maxRotation: 0, font: { size: 9 } } },
          y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, stepSize: 25, font: { size: 9 } }, min: 0, max: 100 },
        },
      },
      plugins: [{
        afterDraw(chart) {
          const { ctx: c, chartArea: a, scales: { y } } = chart;
          [[25, '#ef444444', 'Fear'], [75, '#10b98144', 'Greed']].forEach(([lvl, clr, lbl]) => {
            const py = y.getPixelForValue(lvl);
            if (py < a.top || py > a.bottom) return;
            c.save(); c.strokeStyle = clr; c.lineWidth = 1; c.setLineDash([3, 3]);
            c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke(); c.restore();
          });
        },
      }],
    });
  }

  document.getElementById('fgLoading').style.display = 'none';
  document.getElementById('fgBody').style.display = '';
}


// ── AAII Sentiment Survey ─────────────────────────────────────────
let _aaiiChartInst = null;

function renderAaii(data) {
  if (!data || data.error) {
    document.getElementById('aaiiLoading').textContent = data?.error || I18n.t('markets.unavailable') || 'Unavailable';
    return;
  }
  if (data._stale) {
    const badge = document.createElement('span');
    badge.className = 'ml-2 text-[10px] text-amber-500/70';
    badge.textContent = '(cached)';
    document.querySelector('[data-i18n="markets.aaii_title"]')?.appendChild(badge);
  }

  const latest = data.latest || {};
  const bull = latest.bullish, bear = latest.bearish, neu = latest.neutral;
  const spread = latest.bull_bear_spread;

  // Badge: show bull-bear spread
  const spreadCls = spread == null ? 'neutral' : spread >= 0 ? 'up' : 'down';
  document.getElementById('aaiiBadge').innerHTML = `
    <div class="text-sm font-bold ${spreadCls}">${spread != null ? (spread >= 0 ? '+' : '') + spread.toFixed(1) + '%' : '—'}</div>
    <div class="text-[10px] text-slate-500" data-i18n="markets.aaii_spread">Bull-Bear</div>`;

  // Bull / Neutral / Bear bars
  const bars = [
    { label: I18n.t('markets.aaii_bullish') || 'Bullish',  val: bull, col: '#34d399' },
    { label: I18n.t('markets.aaii_neutral') || 'Neutral',  val: neu,  col: '#94a3b8' },
    { label: I18n.t('markets.aaii_bearish') || 'Bearish',  val: bear, col: '#f87171' },
  ];
  document.getElementById('aaiiBars').innerHTML = bars.map(b => `
    <div class="flex items-center gap-2">
      <span class="text-[10px] text-slate-400 w-14 shrink-0">${b.label}</span>
      <div class="flex-1 bg-slate-800 rounded-full h-2 overflow-hidden">
        <div style="width:${b.val ?? 0}%; background:${b.col}; height:100%; border-radius:4px; transition:width 0.4s"></div>
      </div>
      <span class="text-[11px] font-semibold tabular-nums w-10 text-right" style="color:${b.col}">
        ${b.val != null ? b.val.toFixed(1) + '%' : '—'}
      </span>
    </div>`).join('');

  // History chart — stacked area: bullish (green), neutral (gray), bearish (red)
  const hist = data.history || [];
  if (hist.length && document.getElementById('aaiiChart')) {
    const labels = hist.map(h => h.date);
    if (_aaiiChartInst) { _aaiiChartInst.destroy(); _aaiiChartInst = null; }
    _aaiiChartInst = new Chart(document.getElementById('aaiiChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: I18n.t('markets.aaii_bullish') || 'Bullish', data: hist.map(h => h.bullish),
            borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.15)',
            borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.3, spanGaps: true },
          { label: I18n.t('markets.aaii_bearish') || 'Bearish', data: hist.map(h => h.bearish),
            borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)',
            borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.3, spanGaps: true },
        ],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: { label: c => ` ${c.dataset.label}: ${c.raw?.toFixed(1)}%` },
          },
        },
        scales: {
          x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 4, maxRotation: 0, font: { size: 9 } } },
          y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, callback: v => v + '%', font: { size: 9 } }, min: 0 },
        },
      },
      plugins: [{
        afterDraw(chart) {
          const { ctx: c, chartArea: a, scales: { y } } = chart;
          // Historical average bullish ~37.5%
          const avg = y.getPixelForValue(37.5);
          if (avg >= a.top && avg <= a.bottom) {
            c.save(); c.strokeStyle = '#34d39955'; c.lineWidth = 1; c.setLineDash([4, 3]);
            c.beginPath(); c.moveTo(a.left, avg); c.lineTo(a.right, avg); c.stroke();
            c.fillStyle = '#34d399'; c.font = '9px Inter,sans-serif';
            c.fillText(I18n.t('markets.aaii_avg') || 'Avg 37.5%', a.right - 55, avg - 3); c.restore();
          }
        },
      }],
    });
  }

  document.getElementById('aaiiLoading').style.display = 'none';
  document.getElementById('aaiiBody').style.display = '';
}

// ── Put/Call Ratio ────────────────────────────────────────────────
let _pcrChartInst = null;

function renderPcr(data) {
  const loadEl = document.getElementById('pcrLoading');
  if (!data || data.error) {
    loadEl.textContent = data?.error || (I18n.t('markets.unavailable') || 'Unavailable');
    return;
  }

  const val  = data.current;
  const chg  = data.day_chg;
  const ma20 = data.ma20;

  // Badge: signal based on ratio level
  let signal, sigCol;
  if (val < 0.6)      { signal = I18n.t('markets.pcr_bullish') || 'Bullish';  sigCol = '#34d399'; }
  else if (val < 0.8) { signal = I18n.t('markets.pcr_neutral') || 'Neutral';  sigCol = '#94a3b8'; }
  else                { signal = I18n.t('markets.pcr_bearish') || 'Bearish';  sigCol = '#f87171'; }

  document.getElementById('pcrBadge').innerHTML = `
    <div class="text-2xl font-bold tabular-nums" style="color:${sigCol}">${val != null ? val.toFixed(2) : '—'}</div>
    <div class="text-[11px] font-semibold mt-0.5" style="color:${sigCol}">${signal}</div>`;

  // Needle position: map 0.3–1.3 range onto 0–100%
  const pct = Math.max(0, Math.min(100, (val - 0.3) / 1.0 * 100));
  document.getElementById('pcrNeedle').style.left = pct + '%';

  // Stats
  const chgCls  = chg == null ? 'text-slate-500' : chg >= 0 ? 'text-rose-400' : 'text-emerald-400';
  const chgSign = chg == null ? '' : chg >= 0 ? '+' : '';
  document.getElementById('pcrStats').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">${I18n.t('markets.day_change') || 'Day Change'}</div>
      <div class="stat-val text-sm ${chgCls}">${chgSign}${chg != null ? chg.toFixed(3) : '—'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">${I18n.t('markets.pcr_ma20') || '20-day MA'}</div>
      <div class="stat-val text-sm text-slate-200">${ma20 != null ? ma20.toFixed(2) : '—'}</div>
    </div>`;

  // History chart
  if (_pcrChartInst) { _pcrChartInst.destroy(); _pcrChartInst = null; }
  const dates  = data.dates  || [];
  const closes = data.closes || [];
  // Color line by zone
  _pcrChartInst = new Chart(document.getElementById('pcrChart'), {
    type: 'line',
    data: { labels: dates, datasets: [
      {
        label: 'Put/Call',
        data: closes,
        borderColor: '#a5b4fc', backgroundColor: 'rgba(165,180,252,0.08)',
        borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.3, spanGaps: true,
      },
      {
        label: I18n.t('markets.pcr_ma20') || '20-day MA',
        data: (() => {
          const out = new Array(closes.length).fill(null);
          for (let i = 19; i < closes.length; i++) {
            const slice = closes.slice(i - 19, i + 1).filter(v => v != null);
            out[i] = slice.length ? Math.round(slice.reduce((a,b) => a+b, 0) / slice.length * 1000) / 1000 : null;
          }
          return out;
        })(),
        borderColor: '#fb923c', borderWidth: 1.5, borderDash: [4,3],
        pointRadius: 0, fill: false, tension: 0.3, spanGaps: true,
      },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false,
          callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(2)}` } },
      },
      scales: {
        x: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, maxTicksLimit: 6, maxRotation: 0 } },
        y: { grid: { color: GRID_COL }, ticks: { color: TICK_COL, callback: v => v.toFixed(1) },
             min: 0.3, max: 1.3 },
      },
    },
    plugins: [{
      afterDraw(chart) {
        const { ctx: c, chartArea: a, scales: { y } } = chart;
        // Draw reference lines at 0.6 and 0.8
        [0.6, 0.8].forEach((lvl, i) => {
          const py = y.getPixelForValue(lvl);
          if (py >= a.top && py <= a.bottom) {
            c.save();
            c.strokeStyle = i === 0 ? 'rgba(52,211,153,0.4)' : 'rgba(248,113,113,0.4)';
            c.lineWidth = 1; c.setLineDash([4,3]);
            c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
            c.restore();
          }
        });
      },
    }],
  });

  loadEl.style.display = 'none';
  document.getElementById('pcrBody').style.display = '';
}

// ── Economic Events Calendar ──────────────────────────────────────
let _econData = [];
let _econFilter = 'high';
let _econCollapsed = false;
const hidePastEl = document.getElementById('econHidePast');

function toggleEconSection() {
  _econCollapsed = !_econCollapsed;
  const body = document.getElementById('econCollapse');
  const chevron = document.getElementById('econChevron');
  if (body) body.style.display = _econCollapsed ? 'none' : '';
  if (chevron) chevron.classList.toggle('rotate-180', !_econCollapsed);
}

/** Parse an event's datetime (source = ET, America/New_York) to a local Date object.
 *  Handles EDT/EST DST automatically via Intl offset detection. */
function _econEventDate(ev) {
  if (!ev.date) return null;
  // Events with no time are treated as all-day — no precise datetime
  if (!ev.time) return null;
  let hours = 0, minutes = 0;
  const timeStr = ev.time;
  const ampm = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
  const h24  = timeStr.match(/^(\d{1,2}):(\d{2})$/);
  if (ampm) {
    hours = parseInt(ampm[1], 10) % 12 + (ampm[3].toUpperCase() === 'PM' ? 12 : 0);
    minutes = parseInt(ampm[2], 10);
  } else if (h24) {
    hours = parseInt(h24[1], 10);
    minutes = parseInt(h24[2], 10);
  } else {
    return null;
  }
  // Detect actual ET UTC offset for this date using Intl (handles DST)
  try {
    const probe = new Date(`${ev.date}T12:00:00Z`);
    const etStr = probe.toLocaleString('en-US', { timeZone: 'America/New_York', hour12: false,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit' });
    // etStr like "02/25/2026, 07:00:00" — Safari may produce "24:00:00", normalize it
    const normalized = etStr.replace(/\b24:/g, '00:');
    const utcStr = probe.toLocaleString('en-US', { timeZone: 'UTC', hour12: false,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const etDate  = new Date(normalized.replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$1-$2'));
    const utcDate = new Date(utcStr.replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$1-$2'));
    if (isNaN(etDate) || isNaN(utcDate)) throw new Error('bad date parse');
    const offsetMs = utcDate - etDate;
    const offsetH  = Math.round(offsetMs / 3600000);
    const sign = offsetH >= 0 ? '-' : '+';
    const absH = Math.abs(offsetH);
    const isoStr = `${ev.date}T${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:00${sign}${String(absH).padStart(2,'0')}:00`;
    return new Date(isoStr);
  } catch(_) {
    // Fallback: assume EST (UTC-5)
    const isoStr = `${ev.date}T${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:00-05:00`;
    try { return new Date(isoStr); } catch(__) { return null; }
  }
}

/** Return the user's local timezone abbreviation, e.g. "PST", "CST", "JST". */
function _localTzAbbr() {
  try {
    return new Intl.DateTimeFormat('en-US', { timeZoneName: 'short' })
      .formatToParts(new Date())
      .find(p => p.type === 'timeZoneName')?.value || '';
  } catch(_) { return ''; }
}

const EU_COUNTRIES = new Set(['euro area','eurozone','germany','france','italy','spain','netherlands',
  'belgium','portugal','ireland','greece','finland','austria','sweden','norway','denmark','switzerland',
  'european union','eu']);

function _econCountryRegion(country) {
  if (!country) return 'other';
  const c = country.toLowerCase();
  if (c === 'united states' || c === 'us') return 'us';
  if (c === 'china') return 'cn';
  if (c === 'japan') return 'jp';
  if (EU_COUNTRIES.has(c)) return 'eu';
  return 'other';
}

function filterEcon(region) {
  _econFilter = region;
  // Update button active state
  document.querySelectorAll('.econ-filter-btn').forEach(b => b.classList.remove('active','border-indigo-500','text-indigo-300','border-rose-500','text-rose-300'));
  const activeBtn = document.getElementById('econFilter-' + region);
  if (activeBtn) {
    if (region === 'high') {
      activeBtn.classList.add('active','border-rose-500','text-rose-300');
    } else {
      activeBtn.classList.add('active','border-indigo-500','text-indigo-300');
    }
  }
  _renderEconTable(_econData);
}

function _renderEconTable(events) {
  const now = new Date();
  const tzAbbr = _localTzAbbr();

  // Update column header to show local timezone
  const hdr = document.getElementById('econTimeColHeader');
  if (hdr) {
    const label = (typeof I18n !== 'undefined' ? I18n.t('markets.econ_col_time') : null) || 'Time';
    hdr.innerHTML = tzAbbr
      ? `<span>${label}</span> <span class="normal-case text-slate-600 font-normal">(${tzAbbr})</span>`
      : `<span>${label}</span>`;
  }
  const hidePast = hidePastEl ? hidePastEl.checked : true;

  // Apply region/impact filter
  let filtered = events;
  if (_econFilter === 'high') {
    filtered = events.filter(ev => (ev.impact || '').toLowerCase() === 'high');
  } else if (_econFilter !== 'all') {
    filtered = events.filter(ev => _econCountryRegion(ev.country) === _econFilter);
  }

  // Determine past/future for each event using client timezone.
  // Events without a time (all-day) are only considered past if their date < today.
  const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD in local tz
  filtered = filtered.map(ev => {
    const dt = _econEventDate(ev);
    const isPast = dt ? dt < now : ev.date < todayStr;
    return { ...ev, _dt: dt, _isPast: isPast };
  });

  // Optionally hide past events
  if (hidePast) {
    filtered = filtered.filter(ev => !ev._isPast);
  }

  // Find the next upcoming event index (first not in past)
  let nextIdx = null;
  for (let i = 0; i < filtered.length; i++) {
    if (!filtered[i]._isPast) { nextIdx = i; break; }
  }

  // Group by date for display
  const byDate = {};
  filtered.forEach(ev => {
    if (!byDate[ev.date]) byDate[ev.date] = [];
    byDate[ev.date].push(ev);
  });

  const impactBadge = (imp) => {
    const k = (imp || '').toLowerCase();
    if (k.includes('high')) return `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-semibold bg-rose-950/60 text-rose-400 border border-rose-900/50">● High</span>`;
    if (k.includes('med')) return `<span class="inline-block w-1.5 h-1.5 rounded-full" style="background:#fb923c"></span>`;
    return `<span class="inline-block w-1.5 h-1.5 rounded-full" style="background:#94a3b8"></span>`;
  };

  let rows = '';
  let globalIdx = 0;
  const sortedDates = Object.keys(byDate).sort();
  sortedDates.forEach(date => {
    byDate[date].forEach((ev, i) => {
      const isHigh = (ev.impact || '').toLowerCase() === 'high';
      const isNext = globalIdx === nextIdx;
      const isPast = ev._isPast;
      const rowClass = isNext
        ? 'border-l-2 border-brand/70 bg-brand/5 transition-colors'
        : isHigh
          ? 'hover:bg-rose-950/30 bg-rose-950/10 transition-colors border-l-2 border-rose-800/60'
          : isPast
            ? 'opacity-40 transition-colors'
            : 'hover:bg-slate-800/40 transition-colors';
      const nameText = ev.zh
        ? `<span class="${isHigh ? 'text-rose-200' : isNext ? 'text-brand' : 'text-slate-200'}">${ev.zh}</span><br><span class="text-slate-500 text-[10px]">${ev.event}</span>`
        : `<span class="${isHigh ? 'text-rose-200' : isNext ? 'text-brand' : 'text-slate-200'}">${ev.event}</span>`;
      const nameCell = ev.url
        ? `<a href="${ev.url}" target="_blank" rel="noopener" class="hover:underline underline-offset-2">${nameText}</a>`
        : nameText;
      const nextBadge = isNext ? `<span class="ml-1 text-[9px] px-1 py-0.5 rounded bg-brand/20 text-brand font-semibold">Next</span>` : '';
      const actualVsForecast = (() => {
        if (!ev.actual || !ev.forecast) return '';
        const a = parseFloat(ev.actual), f = parseFloat(ev.forecast);
        if (isNaN(a) || isNaN(f)) return '';
        return a > f ? ' <span class="text-emerald-400">▲</span>' : a < f ? ' <span class="text-rose-400">▼</span>' : '';
      })();
      // Format time in client's local timezone
      const localTime = ev._dt
        ? ev._dt.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })
        : (ev.time ? `${ev.time} <span class="text-slate-600">ET</span>` : '—');
      const timeCell = ev._dt && tzAbbr
        ? `${localTime}`
        : localTime;
      rows += `<tr class="${rowClass}">
        <td class="py-2 pr-3 text-slate-400 whitespace-nowrap">${i === 0 ? date : ''}</td>
        <td class="py-2 pr-3 text-slate-400 whitespace-nowrap">${timeCell}${nextBadge}</td>
        <td class="py-2 pr-3 text-slate-400 whitespace-nowrap">${ev.country || '—'}</td>
        <td class="py-2 pr-3 max-w-xs">${nameCell}</td>
        <td class="py-2 pr-3">${impactBadge(ev.impact)}</td>
        <td class="py-2 pr-3 text-right tabular-nums font-semibold ${ev.actual ? (isHigh ? 'text-rose-300' : 'text-slate-200') : 'text-slate-600'}">${ev.actual || '—'}${actualVsForecast}</td>
        <td class="py-2 pr-3 text-right tabular-nums text-slate-400">${ev.forecast || '—'}</td>
        <td class="py-2 text-right tabular-nums text-slate-500">${ev.previous || '—'}</td>
      </tr>`;
      globalIdx++;
    });
  });

  if (!rows) {
    // If hidePast filtered everything out, auto-uncheck and re-render showing all
    if (hidePast && events.length > 0) {
      if (hidePastEl) hidePastEl.checked = false;
      _renderEconTable(_econData);
      return;
    }
    rows = `<tr><td colspan="8" class="py-6 text-center text-slate-600 text-xs">${I18n.t('markets.econ_no_events') || 'No events for this filter.'}</td></tr>`;
  }

  document.getElementById('econTableBody').innerHTML = rows;
}

function renderEconEvents(events) {
  document.getElementById('econLoading').style.display = 'none';
  if (!events || !events.length) {
    const el = document.getElementById('econLoading');
    el.style.display = '';
    el.textContent = I18n.t('markets.econ_no_events') || 'No upcoming events.';
    return;
  }
  _econData = events;
  _renderEconTable(events);
  document.getElementById('econLoading').style.display = 'none';
  document.getElementById('econBody').style.display = '';

  // Auto-translate and hide the manual button when lang=zh
  const isZh = (typeof I18n !== 'undefined') && I18n.getLang() === 'zh';
  const btn = document.getElementById('econTranslateBtn');
  if (isZh) {
    if (btn) btn.style.display = 'none';
    translateEconEvents();
  }
}

async function translateEconEvents() {
  const btn = document.getElementById('econTranslateBtn');
  if (btn) btn.disabled = true;

  // Find events without Chinese translation
  const toTranslate = _econData
    .filter(ev => !ev.zh && ev.event && ev.event_id)
    .map(ev => ({ event_id: ev.event_id, event: ev.event, date: ev.date }));

  if (!toTranslate.length) {
    if (btn) btn.disabled = false;
    return;
  }

  try {
    const resp = await fetch('/api/economic-events/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ events: toTranslate }),
    });
    const result = await resp.json();
    if (result.translations) {
      _econData = _econData.map(ev => ({
        ...ev,
        zh: result.translations[ev.event_id] || ev.zh,
      }));
      _renderEconTable(_econData);
    }
  } catch(e) {
    console.warn('Translation failed:', e);
  }
  if (btn) btn.disabled = false;
}

// ── Fullscreen chart modal ────────────────────────────────────────
let _mktsModalChart = null;

function closeMktsModal() {
  document.getElementById('mktsModal').style.display = 'none';
  if (_mktsModalChart) { _mktsModalChart.destroy(); _mktsModalChart = null; }
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMktsModal(); });

function expandMktsChart(kind) {
  const modal    = document.getElementById('mktsModal');
  const canvas   = document.getElementById('mktsModalCanvas');
  const titleEl  = document.getElementById('mktsModalTitle');
  const subEl    = document.getElementById('mktsModalSub');
  if (_mktsModalChart) { _mktsModalChart.destroy(); _mktsModalChart = null; }

  // Clone current chart config based on kind
  const cfg = _mktsModalConfig(kind);
  if (!cfg) return;
  titleEl.textContent = cfg.title;
  subEl.textContent   = cfg.sub || '';
  modal.style.display = 'flex';
  _mktsModalChart = new Chart(canvas, cfg.chartConfig);
}

function _mktsModalConfig(kind) {
  if (kind === 'vix' && _vixChartInst) {
    return {
      title: I18n.t('markets.vix') || 'VIX (Volatility)',
      sub:   I18n.t('markets.vix_desc') || '',
      chartConfig: JSON.parse(JSON.stringify(_vixChartInst.config)),
    };
  }
  if (kind === 'fg' && _fgChartInst) {
    return {
      title: I18n.t('markets.fear_greed') || 'Fear & Greed',
      sub:   I18n.t('markets.fear_greed_desc') || '',
      chartConfig: JSON.parse(JSON.stringify(_fgChartInst.config)),
    };
  }
  if (kind === 'aaii' && _aaiiChartInst) {
    return {
      title: I18n.t('markets.aaii_title') || 'AAII Sentiment',
      sub:   I18n.t('markets.aaii_desc') || '',
      chartConfig: JSON.parse(JSON.stringify(_aaiiChartInst.config)),
    };
  }
  if (kind === 'pcr' && _pcrChartInst) {
    return {
      title: I18n.t('markets.pcr_title') || 'Put/Call Ratio',
      sub:   I18n.t('markets.pcr_desc') || '',
      chartConfig: JSON.parse(JSON.stringify(_pcrChartInst.config)),
    };
  }
  if (kind === 'idx' && _idxChartInst) {
    return {
      title: idxLabel(_curIdx) + ' — ' + (I18n.t('markets.hist_title') || 'Price History'),
      sub:   '',
      chartConfig: JSON.parse(JSON.stringify(_idxChartInst.config)),
    };
  }
  return null;
}

(async function() {
  // Fire all independent APIs in parallel immediately
  const fearGreedP = fetch('/api/fear-greed').then(r => r.json());
  const aaiiP      = fetch('/api/aaii-sentiment').then(r => r.json());
  const econP      = fetch('/api/economic-events').then(r => r.json());
  const pcrP       = fetch('/api/put-call-ratio').then(r => r.json());

  // Resolve each as soon as it arrives — don't wait for the slowest
  fearGreedP
    .then(renderFearGreed)
    .catch(e => { document.getElementById('fgLoading').textContent = '⚠ ' + e.message; });
  aaiiP
    .then(d => { if (d && !d.error) renderAaii(d); else {
      document.getElementById('aaiiLoading').textContent = d?.error || (I18n.t('markets.unavailable') || 'Unavailable');
    }})
    .catch(e => { document.getElementById('aaiiLoading').textContent = '⚠ ' + e.message; });
  pcrP
    .then(renderPcr)
    .catch(e => { document.getElementById('pcrLoading').textContent = '⚠ ' + e.message; });
  econP
    .then(d => renderEconEvents(d.events || []))
    .catch(e => {
      const el = document.getElementById('econLoading');
      if (el) el.textContent = '⚠ ' + e.message;
    });

  try {
    // Check URL hash for a specific index to start on
    const hash = window.location.hash.replace('#', '');
    if (IDX_ALL_KEYS.includes(hash)) _curIdx = hash;

    const resp = await fetch('/api/markets');
    _mkData = await resp.json();
    if (!resp.ok) throw new Error(_mkData.error || 'Failed');

    document.getElementById('marketsLoading').style.display = 'none';

    renderCards(_mkData);
    // Swap VIX skeleton → chart
    document.getElementById('vixSkeleton').style.display = 'none';
    document.getElementById('vixChartWrap').style.display = '';
    renderVix(_mkData.vix);
    renderSectors(_mkData.sectors);

    // Activate the correct tab
    IDX_ALL_KEYS.forEach(k => {
      const id = 'tab' + k.charAt(0).toUpperCase() + k.slice(1);
      const btn = document.getElementById(id);
      if (btn) btn.classList.toggle('active', k === _curIdx);
    });
    renderIdxStats(_curIdx, _mkData);
    renderIdxChart(_curIdx, _curRange, _mkData);
    renderMacdChart(_curIdx, _mkData, _curRange);
    renderRsiChart(_curIdx, _mkData, _curRange);
    _syncHover();
    loadIdxForecast(_curIdx);   // async — non-blocking
  } catch(err) {
    document.getElementById('marketsLoading').textContent = '⚠ Failed to load market data: ' + err.message;
  }
})();
</script>

{% endblock %}
