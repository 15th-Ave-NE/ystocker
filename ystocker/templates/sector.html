{% extends "base.html" %}
{% block title %}yStocker — {{ sector_name }}{% endblock %}

{% block content %}

<!-- ── Header ────────────────────────────────────────────────────────── -->
<div class="mb-6 sm:mb-8 fade-up">
  <div class="flex items-center gap-3 mb-1">
    <a href="{{ url_for('main.index') }}" class="text-slate-500 hover:text-slate-300 text-sm transition">← Dashboard</a>
    <span class="text-slate-700">/</span>
    <span class="text-slate-300 text-sm font-medium">{{ sector_name }}</span>
  </div>
  <h1 class="text-2xl sm:text-3xl font-bold grad-text">{{ sector_name }}</h1>
  <p class="text-slate-400 mt-1 text-sm">Valuation analysis for this peer group</p>
</div>

<!-- ── Tab nav ───────────────────────────────────────────────────────── -->
{% set has_upside = namespace(v=false) %}
{% set has_peg    = namespace(v=false) %}
{% set has_price  = namespace(v=false) %}
{% for ticker, row in table.iterrows() %}
  {% if row.get('Upside (%)') is not none and row.get('Upside (%)') == row.get('Upside (%)') %}{% set has_upside.v = true %}{% endif %}
  {% if row.get('PEG') is not none and row.get('PEG') == row.get('PEG') %}{% set has_peg.v = true %}{% endif %}
  {% if row.get('Target Price') is not none and row.get('Target Price') == row.get('Target Price') %}{% set has_price.v = true %}{% endif %}
{% endfor %}

<div x-data="{ tab: 'pe' }" class="fade-up">

  <div class="flex gap-1 mb-6 bg-slate-900 border border-slate-800 rounded-xl p-1 w-full sm:w-fit flex-wrap">
    <button @click="tab='pe'"
            :class="tab==='pe' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">
      PE & PEG
    </button>
    {% if has_price.v %}
    <button @click="tab='prices'"
            :class="tab==='prices' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">
      Prices
    </button>
    {% endif %}
    {% if has_upside.v %}
    <button @click="tab='upside'"
            :class="tab==='upside' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">
      Upside
    </button>
    {% endif %}
    {% if has_peg.v %}
    <button @click="tab='peg'"
            :class="tab==='peg' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">
      PEG Map
    </button>
    {% endif %}
    <button @click="tab='table'"
            :class="tab==='table' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">
      Data Table
    </button>
  </div>

  <!-- PE & PEG grouped bars -->
  <div x-show="tab==='pe'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200">PE Ratios (TTM &amp; Forward) + PEG</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4">Left axis: PE ratios. Right axis (green bars): PEG ratio. Dashed line = PEG 1.0.</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <div class="flex items-center gap-1 bg-slate-800 border border-slate-700 rounded-lg p-0.5">
          <span class="text-[10px] text-slate-500 px-1.5">Sort</span>
          <button onclick="sortPeChart('pe_ttm')" id="pe-sort-pe_ttm"
                  class="pe-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            TTM <span class="pe-sort-arrow"></span>
          </button>
          <button onclick="sortPeChart('pe_fwd')" id="pe-sort-pe_fwd"
                  class="pe-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            Fwd <span class="pe-sort-arrow"></span>
          </button>
          <button onclick="sortPeChart('peg')" id="pe-sort-peg"
                  class="pe-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            PEG <span class="pe-sort-arrow"></span>
          </button>
        </div>
        <button onclick="toggleValues('pe')" data-chart="pe"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="pePegChart"></canvas></div>
  </div>

  <!-- Price vs Target -->
  <div x-show="tab==='prices'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200">Current Price vs Analyst 12-month Target</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4">Bars = current price. Diamond markers = analyst consensus target.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="sortChart('prices')" data-chart="prices"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text">A→Z</span>
        </button>
        <button onclick="toggleValues('prices')" data-chart="prices"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="priceChart"></canvas></div>
  </div>

  <!-- Upside -->
  <div x-show="tab==='upside'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200">Implied Analyst Upside (%)</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4">Implied return if stock reaches the analyst consensus 12-month target.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="sortChart('upside')" data-chart="upside"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text">Lo→Hi</span>
        </button>
        <button onclick="toggleValues('upside')" data-chart="upside"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="upsideChart"></canvas></div>
  </div>

  <!-- PEG valuation map -->
  <div x-show="tab==='peg'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200">PEG Valuation Map</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4">
          PEG = PE ÷ EPS growth rate. &nbsp;
          <span class="text-emerald-400">■</span> &lt;1 undervalued &nbsp;
          <span class="text-amber-400">■</span> 1-2 moderate &nbsp;
          <span class="text-rose-400">■</span> &gt;2 expensive
        </p>
      </div>
      <div class="flex gap-2">
        <button onclick="togglePegTickers()" id="pegTickerBtn"
                class="flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          Hide tickers
        </button>
        <button onclick="sortChart('peg')" data-chart="peg"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text">Lo→Hi</span>
        </button>
        <button onclick="toggleValues('peg')" data-chart="peg"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="pegChart"></canvas></div>
  </div>

  <!-- Data Table -->
  <div x-show="tab==='table'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-6 mb-6">
    <h2 class="text-base font-semibold text-slate-200 mb-4">Data Table</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="sectorTable">
        <thead>
          <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
            <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="ticker">Ticker <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="name">Name <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="market_cap">Mkt Cap <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="price">Price <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="target">Target <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="upside">Upside <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="pe_ttm">PE (TTM) <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="pe_fwd">PE (Fwd) <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="peg">PEG <span class="sort-icon ml-0.5">&#8597;</span></th>
          </tr>
        </thead>
        <tbody id="sectorTableBody"></tbody>
      </table>
    </div>
  </div>

</div><!-- end x-data -->

<script>
const DATA = {{ chartdata | safe }};

const labels  = DATA.map(d => d.ticker);
const gridCol = '#1e293b';
const tickCol = '#64748b';

// ---- Value toggle state ----
const chartInstances = {};
const valuesVisible  = { pe: true, prices: true, upside: true, peg: true };

// ---- Sort state ----
const sortState = { pe: { field: null, dir: 1 }, prices: 'ticker', upside: 'asc', peg: 'asc' };

function sortPeChart(field) {
  const chart = chartInstances.pe;
  if (!chart) return;

  // Toggle direction if same field; default asc for new field
  if (sortState.pe.field === field) {
    sortState.pe.dir *= -1;
  } else {
    sortState.pe.field = field;
    sortState.pe.dir = 1;
  }
  const dir = sortState.pe.dir;

  // Update button styles
  document.querySelectorAll('.pe-sort-btn').forEach(btn => {
    const arrow = btn.querySelector('.pe-sort-arrow');
    if (btn.id === 'pe-sort-' + field) {
      btn.classList.add('bg-brand/20', 'text-white');
      btn.classList.remove('text-slate-400');
      arrow.textContent = dir === 1 ? ' ↑' : ' ↓';
    } else {
      btn.classList.remove('bg-brand/20', 'text-white');
      btn.classList.add('text-slate-400');
      arrow.textContent = '';
    }
  });

  const sorted = [...DATA].sort((a, b) => {
    const av = a[field], bv = b[field];
    if (av == null && bv == null) return 0;
    if (av == null) return 1;
    if (bv == null) return -1;
    return (av - bv) * dir;
  });

  chart.data.labels = sorted.map(d => d.ticker);
  chart.data.datasets[0].data = sorted.map(d => d.pe_ttm);
  chart.data.datasets[1].data = sorted.map(d => d.pe_fwd);
  chart.data.datasets[2].data = sorted.map(d => d.peg);
  chart.update();
}

function sortChart(chartKey) {
  const chart = chartInstances[chartKey];
  if (!chart) return;
  const btn  = document.querySelector(`.chart-sort[data-chart="${chartKey}"]`);
  const text = btn.querySelector('.sort-text');

  if (chartKey === 'prices') {
    const asc = sortState.prices !== 'ticker';
    sortState.prices = asc ? 'ticker' : 'ticker_desc';
    text.textContent = asc ? 'A→Z' : 'Z→A';
    const sorted = [...DATA].sort((a, b) =>
      asc ? a.ticker.localeCompare(b.ticker) : b.ticker.localeCompare(a.ticker)
    );
    chart.data.labels = sorted.map(d => d.ticker);
    chart.data.datasets[0].data = sorted.map(d => d.price);
    chart.data.datasets[1].data = sorted.map(d => d.target);

  } else {
    // upside / peg: toggle Lo→Hi / Hi→Lo
    const goDesc = sortState[chartKey] === 'asc';
    sortState[chartKey] = goDesc ? 'desc' : 'asc';
    text.textContent = goDesc ? 'Hi→Lo' : 'Lo→Hi';

    const field = chartKey === 'upside' ? 'upside' : 'peg';
    const sorted = [...DATA]
      .filter(d => d[field] != null)
      .sort((a, b) => goDesc ? b[field] - a[field] : a[field] - b[field]);

    chart.data.labels = sorted.map(d => d.ticker);
    chart.data.datasets[0].data = sorted.map(d => d[field]);
    if (chartKey === 'upside') {
      chart.data.datasets[0].backgroundColor =
        sorted.map(d => d.upside >= 0 ? '#34d399cc' : '#f43f5ecc');
    } else {
      chart.data.datasets[0].backgroundColor =
        sorted.map(d => d.peg < 1 ? '#34d399cc' : d.peg < 2 ? '#f59e0bcc' : '#f43f5ecc');
    }
  }

  chart.update();
}

let pegTickersVisible = true;
function togglePegTickers() {
  pegTickersVisible = !pegTickersVisible;
  const btn = document.getElementById('pegTickerBtn');
  btn.textContent = pegTickersVisible ? 'Hide tickers' : 'Show tickers';
  const chart = chartInstances.peg;
  if (!chart) return;
  chart.options.scales.y.ticks.display = pegTickersVisible;
  chart.update();
}

function toggleValues(chartKey) {
  valuesVisible[chartKey] = !valuesVisible[chartKey];
  const btn = document.querySelector(`.chart-toggle[data-chart="${chartKey}"]`);
  const text = btn.querySelector('.toggle-text');
  if (valuesVisible[chartKey]) {
    text.textContent = 'Hide values';
    btn.classList.remove('bg-brand', 'text-white');
    btn.classList.add('text-brand', 'bg-brand/10');
  } else {
    text.textContent = 'Show values';
    btn.classList.add('bg-brand', 'text-white');
    btn.classList.remove('text-brand', 'bg-brand/10');
  }
  if (chartInstances[chartKey]) {
    const chart = chartInstances[chartKey];
    chart.data.datasets.forEach(ds => {
      ds.datalabels = ds.datalabels || {};
      ds.datalabels.display = valuesVisible[chartKey];
    });
    chart.update();
  }
}

// Shared click-to-history plugin for every chart in this page
function tickerClickPlugin(getLabels) {
  return {
    afterEvent(chart, args) {
      const el = chart.getElementsAtEventForMode(args.event.native, 'nearest', {intersect:true}, false);
      chart.canvas.style.cursor = el.length ? 'pointer' : 'default';
    }
  };
}
function tickerOnClick(getLabels) {
  return function(e, elements) {
    if (!elements.length) return;
    const ticker = getLabels()[elements[0].index];
    if (ticker) window.location.href = `/history/${encodeURIComponent(ticker)}`;
  };
}

// Value label plugin - draws values on top of bars
function valueLabelPlugin(chartKey, formatter) {
  return {
    id: 'valueLabels_' + chartKey,
    afterDatasetsDraw(chart) {
      if (!valuesVisible[chartKey]) return;
      const {ctx: c} = chart;
      chart.data.datasets.forEach((ds, di) => {
        const meta = chart.getDatasetMeta(di);
        if (meta.hidden) return;
        meta.data.forEach((el, i) => {
          const val = ds.data[i];
          if (val == null) return;
          const label = formatter ? formatter(val, di) : val.toFixed(1);
          c.save();
          c.fillStyle = '#cbd5e1';
          c.font = '10px Inter,sans-serif';
          c.textAlign = 'center';
          if (chart.options.indexAxis === 'y') {
            c.textAlign = 'left';
            c.fillText(label, el.x + 4, el.y + 3);
          } else {
            c.fillText(label, el.x, el.y - 6);
          }
          c.restore();
        });
      });
    }
  };
}

const chartDefaults = {
  responsive: true, maintainAspectRatio: false,
  plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } } },
};

// -- PE + PEG grouped bars (dual axis)
(function(){
  const ctx = document.getElementById('pePegChart');
  chartInstances.pe = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'PE (TTM)',    data: DATA.map(d=>d.pe_ttm),  backgroundColor: '#6366f1cc', borderRadius: 4, yAxisID: 'yPE' },
        { label: 'PE (Fwd)',   data: DATA.map(d=>d.pe_fwd),   backgroundColor: '#38bdf8cc', borderRadius: 4, yAxisID: 'yPE' },
        { label: 'PEG',        data: DATA.map(d=>d.peg),      backgroundColor: '#34d399cc', borderRadius: 4, yAxisID: 'yPEG' },
      ]
    },
    options: {
      ...chartDefaults,
      onClick: tickerOnClick(() => labels),
      scales: {
        yPE:  { position:'left',  grid:{color:gridCol}, ticks:{color:tickCol}, title:{display:true,text:'PE Ratio',color:tickCol} },
        yPEG: { position:'right', grid:{display:false},  ticks:{color:'#34d399'}, title:{display:true,text:'PEG',color:'#34d399'} },
        x:    { grid:{display:false}, ticks:{color:tickCol} }
      },
      plugins: {
        ...chartDefaults.plugins,
        annotation: {},
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('pe', (v,di) => di<2 ? v.toFixed(1)+'x' : v.toFixed(2)), {
      afterDraw(chart) {
        const {ctx:c, chartArea:a, scales:{yPEG}} = chart;
        if (!yPEG) return;
        const y1 = yPEG.getPixelForValue(1);
        if (y1 > a.top && y1 < a.bottom) {
          c.save(); c.strokeStyle='#34d39966'; c.lineWidth=1.5; c.setLineDash([5,4]);
          c.beginPath(); c.moveTo(a.left, y1); c.lineTo(a.right, y1); c.stroke();
          c.fillStyle='#34d399'; c.font='10px Inter'; c.fillText('PEG = 1', a.right-50, y1-4);
          c.restore();
        }
      }
    }]
  });
})();

// -- Price vs Target
(function(){
  const ctx = document.getElementById('priceChart');
  chartInstances.prices = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'Current Price', data: DATA.map(d=>d.price),  backgroundColor:'#6366f1cc', borderRadius:4 },
        { label:'Target Price',  data: DATA.map(d=>d.target), backgroundColor:'#f59e0b44',
          borderColor:'#f59e0b', borderWidth:2, borderRadius:4 },
      ]
    },
    options: {
      ...chartDefaults,
      onClick: tickerOnClick(() => labels),
      scales: {
        x: { grid:{display:false}, ticks:{color:tickCol} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol,callback:v=>'$'+v} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('prices', v => '$'+v.toFixed(0))]
  });
})();

// -- Upside horizontal bar
(function(){
  const ctx = document.getElementById('upsideChart');
  const sorted = [...DATA].filter(d=>d.upside!=null).sort((a,b)=>a.upside-b.upside);
  chartInstances.upside = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d=>d.ticker),
      datasets: [{
        label: 'Upside %',
        data: sorted.map(d=>d.upside),
        backgroundColor: sorted.map(d => d.upside >= 0 ? '#34d399cc' : '#f43f5ecc'),
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      onClick: tickerOnClick(() => sorted.map(d=>d.ticker)),
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` ${c.raw?.toFixed(1)}%`}} },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol,callback:v=>v+'%'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('upside', v => v.toFixed(1)+'%'), {
      afterDraw(chart){
        const {ctx:c,chartArea:a,scales:{x}} = chart;
        const z = x.getPixelForValue(0);
        if(z>a.left&&z<a.right){ c.save();c.strokeStyle='#475569';c.lineWidth=1;c.beginPath();c.moveTo(z,a.top);c.lineTo(z,a.bottom);c.stroke();c.restore(); }
      }
    }]
  });
})();

// -- PEG map horizontal bar
(function(){
  const ctx = document.getElementById('pegChart');
  const sorted = [...DATA].filter(d=>d.peg!=null).sort((a,b)=>a.peg-b.peg);
  chartInstances.peg = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d=>d.ticker),
      datasets: [{
        label:'PEG',
        data: sorted.map(d=>d.peg),
        backgroundColor: sorted.map(d => d.peg<1?'#34d399cc':d.peg<2?'#f59e0bcc':'#f43f5ecc'),
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis:'y',
      onClick: tickerOnClick(() => sorted.map(d=>d.ticker)),
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` PEG: ${c.raw?.toFixed(2)}`}} },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('peg', v => v.toFixed(2)), {
      afterDraw(chart){
        const {ctx:c,chartArea:a,scales:{x}} = chart;
        [1,2].forEach(v=>{
          const px = x.getPixelForValue(v);
          if(px>a.left&&px<a.right){
            c.save();c.strokeStyle='#47556966';c.lineWidth=1;c.setLineDash([4,3]);
            c.beginPath();c.moveTo(px,a.top);c.lineTo(px,a.bottom);c.stroke();
            c.fillStyle='#64748b';c.font='10px Inter';c.fillText('PEG='+v,px+3,a.top+12);
            c.restore();
          }
        });
      }
    }]
  });
})();

// ---- Hide controls & legend entries when data is unavailable ----
(function(){
  const hasVal = field => DATA.some(d => d[field] != null);
  const hide   = el => el && (el.style.display = 'none');

  // PE chart: hide sort buttons for missing metrics, hide legend for missing datasets
  const hasTtm = hasVal('pe_ttm'), hasFwd = hasVal('pe_fwd'), hasPeg = hasVal('peg');
  if (!hasTtm) hide(document.getElementById('pe-sort-pe_ttm'));
  if (!hasFwd) hide(document.getElementById('pe-sort-pe_fwd'));
  if (!hasPeg) hide(document.getElementById('pe-sort-peg'));
  // Hide the entire Sort pill if nothing to sort by
  if (!hasTtm && !hasFwd && !hasPeg) hide(document.querySelector('.pe-sort-btn')?.closest('div'));
  // Hide legend entries for missing datasets in PE chart
  if (chartInstances.pe) {
    const metas = chartInstances.pe.data.datasets.map((ds, i) => ({ds, meta: chartInstances.pe.getDatasetMeta(i)}));
    if (!hasTtm) { metas[0].meta.hidden = true; }
    if (!hasFwd) { metas[1].meta.hidden = true; }
    if (!hasPeg) { metas[2].meta.hidden = true; }
    // If all PE/PEG data missing, hide legend entirely
    if (!hasTtm && !hasFwd && !hasPeg) {
      chartInstances.pe.options.plugins.legend.display = false;
    }
    chartInstances.pe.update();
  }

  // Prices chart: hide sort button if no price/target data
  const hasPrice  = hasVal('price');
  const hasTarget = hasVal('target');
  if (!hasPrice && !hasTarget) {
    hide(document.querySelector('.chart-sort[data-chart="prices"]'));
    hide(document.querySelector('.chart-toggle[data-chart="prices"]'));
  }
  if (chartInstances.prices) {
    const pm = chartInstances.prices.data.datasets.map((ds, i) => chartInstances.prices.getDatasetMeta(i));
    if (!hasPrice)  pm[0].hidden = true;
    if (!hasTarget) pm[1].hidden = true;
    if (!hasPrice && !hasTarget) chartInstances.prices.options.plugins.legend.display = false;
    chartInstances.prices.update();
  }

  // Upside chart: hide sort button if no upside data
  if (!hasVal('upside')) {
    hide(document.querySelector('.chart-sort[data-chart="upside"]'));
    hide(document.querySelector('.chart-toggle[data-chart="upside"]'));
  }

  // PEG chart: hide sort + hide tickers button if no peg data
  if (!hasVal('peg')) {
    hide(document.querySelector('.chart-sort[data-chart="peg"]'));
    hide(document.querySelector('.chart-toggle[data-chart="peg"]'));
    hide(document.getElementById('pegTickerBtn'));
  }
})();
(function(){
  let sortCol = 'ticker', sortDir = 1;

  function fmtNull(s){ return '<span class="text-slate-600">-</span>'; }
  function fmtPrice(v){ return v==null ? fmtNull() : '$'+v.toFixed(2); }
  function fmtPE(v){ return v==null ? fmtNull() : v.toFixed(1)+'x'; }
  function fmtPct(v){
    if(v==null) return fmtNull();
    const col = v>=0 ? 'text-emerald-400' : 'text-rose-400';
    return `<span class="${col} font-semibold">${v.toFixed(1)}%</span>`;
  }
  function fmtPeg(v){
    if(v==null) return fmtNull();
    const col = v<1?'text-emerald-400':v<2?'text-amber-400':'text-rose-400';
    return `<span class="${col} font-semibold">${v.toFixed(2)}</span>`;
  }
  function fmtCap(v){ return v==null ? fmtNull() : '$'+v.toFixed(1)+'B'; }

  function render() {
    let rows = [...DATA];
    rows.sort((a,b) => {
      let av = a[sortCol], bv = b[sortCol];
      if (typeof av === 'string') av = av.toLowerCase();
      if (typeof bv === 'string') bv = bv.toLowerCase();
      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;
      return av < bv ? -sortDir : av > bv ? sortDir : 0;
    });

    document.querySelectorAll('#sectorTable th.sortable').forEach(th => {
      const icon = th.querySelector('.sort-icon');
      if (th.dataset.col === sortCol) {
        icon.innerHTML = sortDir === -1 ? '&#8595;' : '&#8593;';
        th.classList.add('text-brand');
        th.classList.remove('text-slate-500');
      } else {
        icon.innerHTML = '&#8597;';
        th.classList.remove('text-brand');
        th.classList.add('text-slate-500');
      }
    });

    document.getElementById('sectorTableBody').innerHTML = rows.map(d => `
      <tr class="border-b border-slate-800/60 hover:bg-slate-800/40 transition">
        <td class="py-2.5 px-3"><a href="/history/${d.ticker}" class="font-mono font-bold text-brand hover:underline">${d.ticker}</a></td>
        <td class="py-2.5 px-3 text-slate-400 text-xs max-w-[140px] truncate" title="${d.name}">${d.name}</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm">${fmtCap(d.market_cap)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPrice(d.price)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPrice(d.target)}</td>
        <td class="py-2.5 px-3 text-right">${fmtPct(d.upside)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPE(d.pe_ttm)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPE(d.pe_fwd)}</td>
        <td class="py-2.5 px-3 text-right">${fmtPeg(d.peg)}</td>
      </tr>`).join('');
  }

  document.querySelectorAll('#sectorTable th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      if (sortCol === th.dataset.col) sortDir *= -1;
      else { sortCol = th.dataset.col; sortDir = (sortCol === 'ticker' || sortCol === 'name') ? 1 : -1; }
      render();
    });
  });

  render();
})();
</script>
{% endblock %}
