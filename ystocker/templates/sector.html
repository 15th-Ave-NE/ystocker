{% extends "base.html" %}
{% block title %}yStocker — {{ sector_name }}{% endblock %}

{% block content %}

<!-- ── Header ────────────────────────────────────────────────────────── -->
<div class="mb-6 sm:mb-8 fade-up">
  <div class="flex items-center gap-3 mb-1">
    <a href="{{ url_for('main.index') }}" class="text-slate-500 hover:text-slate-300 text-sm transition" data-i18n="sector.dashboard">← Dashboard</a>
    <span class="text-slate-700">/</span>
    <span class="text-slate-300 text-sm font-medium">{{ sector_name }}</span>
  </div>
  <h1 class="text-2xl sm:text-3xl font-bold grad-text">{{ sector_name }}</h1>
  <p class="text-slate-400 mt-1 text-sm" data-i18n="sector.subtitle">Valuation analysis for this peer group</p>
</div>

<!-- ── Tab nav ───────────────────────────────────────────────────────── -->
{% set has_upside     = namespace(v=false) %}
{% set has_peg        = namespace(v=false) %}
{% set has_price      = namespace(v=false) %}
{% set has_growth     = namespace(v=false) %}
{% set has_day_change = namespace(v=false) %}
{% set has_ev_ebitda  = namespace(v=false) %}
{% set has_ev         = namespace(v=false) %}
{% set has_ebitda     = namespace(v=false) %}
{% for ticker, row in table.iterrows() %}
  {% if row.get('Upside (%)') is not none and row.get('Upside (%)') == row.get('Upside (%)') %}{% set has_upside.v = true %}{% endif %}
  {% if row.get('PEG') is not none and row.get('PEG') == row.get('PEG') %}{% set has_peg.v = true %}{% endif %}
  {% if row.get('Target Price') is not none and row.get('Target Price') == row.get('Target Price') %}{% set has_price.v = true %}{% endif %}
  {% if row.get('EPS Growth TTM (%)') is not none and row.get('EPS Growth TTM (%)') == row.get('EPS Growth TTM (%)') %}{% set has_growth.v = true %}{% endif %}
  {% if row.get('EPS Growth Q (%)') is not none and row.get('EPS Growth Q (%)') == row.get('EPS Growth Q (%)') %}{% set has_growth.v = true %}{% endif %}
  {% if row.get('Day Change (%)') is not none and row.get('Day Change (%)') == row.get('Day Change (%)') %}{% set has_day_change.v = true %}{% endif %}
  {% if row.get('EV/EBITDA') is not none and row.get('EV/EBITDA') == row.get('EV/EBITDA') %}{% set has_ev_ebitda.v = true %}{% endif %}
  {% if row.get('EV ($B)') is not none and row.get('EV ($B)') == row.get('EV ($B)') %}{% set has_ev.v = true %}{% endif %}
  {% if row.get('EBITDA ($B)') is not none and row.get('EBITDA ($B)') == row.get('EBITDA ($B)') %}{% set has_ebitda.v = true %}{% endif %}
{% endfor %}

<div x-data="{ tab: 'day_change' }" class="fade-up">

  <div class="flex gap-1 mb-6 bg-slate-900 border border-slate-800 rounded-xl p-1 w-full sm:w-fit flex-wrap">
    {% if has_day_change.v %}
    <button @click="tab='day_change'"
            :class="tab==='day_change' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_day_change">
      Day Change
    </button>
    {% endif %}
    <button @click="tab='pe'"
            :class="tab==='pe' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_pe">
      PE & PEG
    </button>
    {% if has_price.v %}
    <button @click="tab='prices'"
            :class="tab==='prices' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_prices">
      Prices
    </button>
    {% endif %}
    {% if has_upside.v %}
    <button @click="tab='upside'"
            :class="tab==='upside' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_upside">
      Upside
    </button>
    {% endif %}
    {% if has_peg.v %}
    <button @click="tab='peg'"
            :class="tab==='peg' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_peg">
      PEG Map
    </button>
    {% endif %}
    {% if has_growth.v %}
    <button @click="tab='growth'"
            :class="tab==='growth' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_growth">
      Growth
    </button>
    {% endif %}
    {% if has_ev_ebitda.v %}
    <button @click="tab='ev_ebitda'"
            :class="tab==='ev_ebitda' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_ev_ebitda">
      EV/EBITDA
    </button>
    {% endif %}
    <button @click="tab='table'"
            :class="tab==='table' ? 'bg-brand text-white shadow' : 'text-slate-400 hover:text-slate-200'"
            class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" data-i18n="sector.tab_table">
      Data Table
    </button>
  </div>

  <!-- Day Change -->
  <div x-show="tab==='day_change'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.day_change_title">Last Close — Day Change</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4" data-i18n="sector.day_change_desc">Percentage change from previous close. Green = up, red = down.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="sortChart('day_change')" data-chart="day_change"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text">Lo→Hi</span>
        </button>
        <button onclick="toggleValues('day_change')" data-chart="day_change"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px"><canvas id="dayChangeChart"></canvas></div>
  </div>

  <!-- PE & PEG grouped bars -->
  <div x-show="tab==='pe'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.pe_title">PE Ratios (TTM &amp; Forward) + PEG</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4" data-i18n="sector.pe_desc">Left axis: PE ratios. Right axis (green bars): PEG ratio. Dashed line = PEG 1.0.</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <div class="flex items-center gap-1 bg-slate-800 border border-slate-700 rounded-lg p-0.5">
          <span class="text-[10px] text-slate-500 px-1.5" data-i18n="sector.sort">Sort</span>
          <button onclick="sortPeChart('pe_ttm')" id="pe-sort-pe_ttm"
                  class="pe-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            TTM <span class="pe-sort-arrow"></span>
          </button>
          <button onclick="sortPeChart('pe_fwd')" id="pe-sort-pe_fwd"
                  class="pe-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            Fwd <span class="pe-sort-arrow"></span>
          </button>
          <button onclick="sortPeChart('peg')" id="pe-sort-peg"
                  class="pe-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            PEG <span class="pe-sort-arrow"></span>
          </button>
        </div>
        <button onclick="toggleValues('pe')" data-chart="pe"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text" data-i18n="sector.hide_values">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="pePegChart"></canvas></div>
  </div>

  <!-- Price vs Target -->
  <div x-show="tab==='prices'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.prices_title">Current Price vs Analyst 12-month Target</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4" data-i18n="sector.prices_desc">Bars = current price. Diamond markers = analyst consensus target.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="sortChart('prices')" data-chart="prices"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text" data-i18n="sector.sort_az">A→Z</span>
        </button>
        <button onclick="toggleValues('prices')" data-chart="prices"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text" data-i18n="sector.hide_values">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="priceChart"></canvas></div>
  </div>

  <!-- Upside -->
  <div x-show="tab==='upside'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.upside_title">Implied Analyst Upside (%)</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4" data-i18n="sector.upside_desc">Implied return if stock reaches the analyst consensus 12-month target.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="sortChart('upside')" data-chart="upside"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text" data-i18n="sector.sort_lohi">Lo→Hi</span>
        </button>
        <button onclick="toggleValues('upside')" data-chart="upside"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text" data-i18n="sector.hide_values">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="upsideChart"></canvas></div>
  </div>

  <!-- PEG valuation map -->
  <div x-show="tab==='peg'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.peg_title">PEG Valuation Map</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4">
          <span data-i18n="sector.peg_desc">PEG = PE ÷ EPS growth rate.</span> &nbsp;
          <span class="text-emerald-400">■</span> <span data-i18n="sector.peg_under">&lt;1 undervalued</span> &nbsp;
          <span class="text-amber-400">■</span> <span data-i18n="sector.peg_moderate">1-2 moderate</span> &nbsp;
          <span class="text-rose-400">■</span> <span data-i18n="sector.peg_expensive">&gt;2 expensive</span>
        </p>
      </div>
      <div class="flex gap-2">
        <button onclick="togglePegTickers()" id="pegTickerBtn"
                class="flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg" data-i18n="sector.hide_tickers">
          Hide tickers
        </button>
        <button onclick="sortChart('peg')" data-chart="peg"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text" data-i18n="sector.sort_lohi">Lo→Hi</span>
        </button>
        <button onclick="toggleValues('peg')" data-chart="peg"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text" data-i18n="sector.hide_values">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:260px; sm:height:320px"><canvas id="pegChart"></canvas></div>
  </div>

  <!-- Growth chart -->
  <div x-show="tab==='growth'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.growth_title">EPS Growth</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4" data-i18n="sector.growth_desc">Year-over-year earnings growth — TTM (trailing 12 months) and most recent quarter.</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <div class="flex items-center gap-1 bg-slate-800 border border-slate-700 rounded-lg p-0.5">
          <span class="text-[10px] text-slate-500 px-1.5" data-i18n="sector.sort">Sort</span>
          <button onclick="sortGrowthChart('eps_growth_ttm')" id="growth-sort-ttm"
                  class="growth-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            TTM <span class="growth-sort-arrow"></span>
          </button>
          <button onclick="sortGrowthChart('eps_growth_q')" id="growth-sort-q"
                  class="growth-sort-btn text-xs px-2 py-1 rounded-md transition text-slate-400 hover:text-slate-200">
            Q <span class="growth-sort-arrow"></span>
          </button>
        </div>
        <button onclick="toggleValues('growth')" data-chart="growth"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text" data-i18n="sector.hide_values">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:{{ [table|length * 40 + 40, 200]|max }}px"><canvas id="growthChart"></canvas></div>
  </div>

  <!-- EV/EBITDA horizontal bar -->
  <div x-show="tab==='ev_ebitda'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start gap-3 sm:gap-0 sm:justify-between mb-1">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="sector.ev_ebitda_title">EV/EBITDA</h2>
        <p class="text-xs text-slate-500 mb-2 sm:mb-4" data-i18n="sector.ev_ebitda_desc">Enterprise Value ÷ EBITDA — lower = cheaper relative to operating earnings (capital-structure neutral).</p>
        <p class="text-xs text-slate-600 mb-2">
          <span class="text-emerald-400">■</span> &lt;8x 便宜 &nbsp;
          <span class="text-sky-400">■</span> 8–13x 正常 &nbsp;
          <span class="text-amber-400">■</span> 13–20x 成长型 &nbsp;
          <span class="text-rose-400">■</span> 20x+ 高增长或泡沫
        </p>
      </div>
      <div class="flex gap-2">
        <button onclick="sortChart('ev_ebitda')" data-chart="ev_ebitda"
                class="chart-sort flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <span class="sort-text" data-i18n="sector.sort_lohi">Lo→Hi</span>
        </button>
        <button onclick="toggleValues('ev_ebitda')" data-chart="ev_ebitda"
                class="chart-toggle flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span class="toggle-text" data-i18n="sector.hide_values">Hide values</span>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:{{ [table|length * 36 + 40, 200]|max }}px"><canvas id="evEbitdaChart"></canvas></div>

    <!-- EV ($B) -->
    <div class="mt-6">
      <h3 class="text-sm font-semibold text-slate-300 mb-1" data-i18n="sector.ev_title">Enterprise Value ($B)</h3>
      <p class="text-xs text-slate-500 mb-3" data-i18n="sector.ev_desc">Total enterprise value in billions USD.</p>
      <div class="chart-container" style="height:{{ [table|length * 36 + 40, 200]|max }}px"><canvas id="evChart"></canvas></div>
    </div>

    <!-- EBITDA ($B) -->
    <div class="mt-6">
      <h3 class="text-sm font-semibold text-slate-300 mb-1" data-i18n="sector.ebitda_title">EBITDA ($B)</h3>
      <p class="text-xs text-slate-500 mb-3" data-i18n="sector.ebitda_desc">Earnings before interest, taxes, depreciation &amp; amortisation, in billions USD.</p>
      <div class="chart-container" style="height:{{ [table|length * 36 + 40, 200]|max }}px"><canvas id="ebitdaChart"></canvas></div>
    </div>
  </div>

  <!-- Data Table -->
  <div x-show="tab==='table'" x-transition class="bg-slate-900 border border-slate-800 rounded-2xl p-6 mb-6">
    <h2 class="text-base font-semibold text-slate-200 mb-4" data-i18n="sector.table_title">Data Table</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="sectorTable">
        <thead>
          <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
            <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="ticker"><span data-i18n="th.ticker">Ticker</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="name"><span data-i18n="th.name">Name</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="market_cap"><span data-i18n="th.mkt_cap">Mkt Cap</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="price"><span data-i18n="th.price">Price</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="target"><span data-i18n="th.target">Target</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="upside"><span data-i18n="th.upside">Upside</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="pe_ttm"><span data-i18n="th.pe_ttm">PE (TTM)</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="pe_fwd"><span data-i18n="th.pe_fwd">PE (Fwd)</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="peg"><span data-i18n="th.peg">PEG</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="eps_growth_ttm"><span data-i18n="th.eps_growth_ttm">EPS Gr TTM</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="eps_growth_q"><span data-i18n="th.eps_growth_q">EPS Gr Q</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="ev_ebitda"><span data-i18n="th.ev_ebitda">EV/EBITDA</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="ev"><span data-i18n="th.ev">EV ($B)</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
            <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
                data-col="ebitda"><span data-i18n="th.ebitda">EBITDA ($B)</span> <span class="sort-icon ml-0.5">&#8597;</span></th>
          </tr>
        </thead>
        <tbody id="sectorTableBody"></tbody>
      </table>
    </div>
  </div>

</div><!-- end x-data -->

<script>
const DATA = {{ chartdata | safe }};

const labels  = DATA.map(d => d.ticker);
const gridCol = '#1e293b';
const tickCol = '#64748b';

// ---- Value toggle state ----
const chartInstances = {};
const valuesVisible  = { pe: true, prices: true, upside: true, peg: true, growth: true, day_change: true, ev_ebitda: true };

// ---- Sort state ----
const sortState = { pe: { field: null, dir: 1 }, prices: 'ticker', upside: 'asc', peg: 'asc', growth: 'asc', day_change: 'asc', ev_ebitda: 'asc' };

// ---- Growth sort state ----
const growthSortState = { field: 'eps_growth_ttm', dir: 1 };

function sortGrowthChart(field) {
  const chart = chartInstances.growth;
  if (!chart) return;

  if (growthSortState.field === field) {
    growthSortState.dir *= -1;
  } else {
    growthSortState.field = field;
    growthSortState.dir = 1;
  }
  const dir = growthSortState.dir;

  document.querySelectorAll('.growth-sort-btn').forEach(btn => {
    const arrow = btn.querySelector('.growth-sort-arrow');
    if (btn.id === 'growth-sort-' + (field === 'eps_growth_ttm' ? 'ttm' : 'q')) {
      btn.classList.add('bg-brand/20', 'text-white');
      btn.classList.remove('text-slate-400');
      arrow.textContent = dir === 1 ? ' ↑' : ' ↓';
    } else {
      btn.classList.remove('bg-brand/20', 'text-white');
      btn.classList.add('text-slate-400');
      arrow.textContent = '';
    }
  });

  const sorted = [...DATA]
    .filter(d => d[field] != null || d.eps_growth_ttm != null || d.eps_growth_q != null)
    .sort((a, b) => {
      const av = a[field] ?? -Infinity, bv = b[field] ?? -Infinity;
      return (av - bv) * dir;
    });

  chart.data.labels = sorted.map(d => d.ticker);
  chart.data.datasets[0].data = sorted.map(d => d.eps_growth_ttm);
  chart.data.datasets[1].data = sorted.map(d => d.eps_growth_q);
  chart.update();
}

function sortPeChart(field) {
  const chart = chartInstances.pe;
  if (!chart) return;

  // Toggle direction if same field; default asc for new field
  if (sortState.pe.field === field) {
    sortState.pe.dir *= -1;
  } else {
    sortState.pe.field = field;
    sortState.pe.dir = 1;
  }
  const dir = sortState.pe.dir;

  // Update button styles
  document.querySelectorAll('.pe-sort-btn').forEach(btn => {
    const arrow = btn.querySelector('.pe-sort-arrow');
    if (btn.id === 'pe-sort-' + field) {
      btn.classList.add('bg-brand/20', 'text-white');
      btn.classList.remove('text-slate-400');
      arrow.textContent = dir === 1 ? ' ↑' : ' ↓';
    } else {
      btn.classList.remove('bg-brand/20', 'text-white');
      btn.classList.add('text-slate-400');
      arrow.textContent = '';
    }
  });

  const sorted = [...DATA].sort((a, b) => {
    const av = a[field], bv = b[field];
    if (av == null && bv == null) return 0;
    if (av == null) return 1;
    if (bv == null) return -1;
    return (av - bv) * dir;
  });

  chart.data.labels = sorted.map(d => d.ticker);
  chart.data.datasets[0].data = sorted.map(d => d.pe_ttm);
  chart.data.datasets[1].data = sorted.map(d => d.pe_fwd);
  chart.data.datasets[2].data = sorted.map(d => d.peg);
  chart.update();
}

function sortChart(chartKey) {
  const chart = chartInstances[chartKey];
  if (!chart) return;
  const btn  = document.querySelector(`.chart-sort[data-chart="${chartKey}"]`);
  const text = btn.querySelector('.sort-text');

  if (chartKey === 'prices') {
    const asc = sortState.prices !== 'ticker';
    sortState.prices = asc ? 'ticker' : 'ticker_desc';
    text.textContent = asc ? I18n.t('sector.sort_az') : I18n.t('sector.sort_za');
    const sorted = [...DATA].sort((a, b) =>
      asc ? a.ticker.localeCompare(b.ticker) : b.ticker.localeCompare(a.ticker)
    );
    chart.data.labels = sorted.map(d => d.ticker);
    chart.data.datasets[0].data = sorted.map(d => d.price);
    chart.data.datasets[1].data = sorted.map(d => d.target);

  } else {
    // upside / peg / growth: toggle Lo→Hi / Hi→Lo
    const goDesc = sortState[chartKey] === 'asc';
    sortState[chartKey] = goDesc ? 'desc' : 'asc';
    text.textContent = goDesc ? I18n.t('sector.sort_hilo') : I18n.t('sector.sort_lohi');

    const field = chartKey === 'upside' ? 'upside' : chartKey === 'growth' ? 'eps_growth_ttm' : chartKey === 'day_change' ? 'day_change_pct' : chartKey === 'ev_ebitda' ? 'ev_ebitda' : 'peg';
    const sorted = [...DATA]
      .filter(d => d[field] != null || (chartKey === 'growth' && d.eps_growth_q != null))
      .sort((a, b) => {
        const av = a[field] ?? -Infinity, bv = b[field] ?? -Infinity;
        return goDesc ? bv - av : av - bv;
      });

    chart.data.labels = sorted.map(d => d.ticker);
    if (chartKey === 'growth') {
      chart.data.datasets[0].data = sorted.map(d => d.eps_growth_ttm);
      chart.data.datasets[1].data = sorted.map(d => d.eps_growth_q);
    } else if (chartKey === 'day_change') {
      const maxAbs = Math.max(...sorted.map(d => Math.abs(d.day_change_pct ?? 0)), 0.01);
      chart.data.datasets[0].data = sorted.map(d => d.day_change_pct);
      chart.data.datasets[0].backgroundColor = sorted.map(d => {
        const v = d.day_change_pct ?? 0;
        const t = Math.min(Math.abs(v) / maxAbs, 1);
        const a = (0.25 + t * 0.65).toFixed(2);
        return v >= 0 ? `rgba(52,211,153,${a})` : `rgba(244,63,94,${a})`;
      });
    } else if (chartKey === 'upside') {
      chart.data.datasets[0].data = sorted.map(d => d[field]);
      chart.data.datasets[0].backgroundColor =
        sorted.map(d => d.upside >= 0 ? '#34d399cc' : '#f43f5ecc');
    } else if (chartKey === 'ev_ebitda') {
      chart.data.datasets[0].data = sorted.map(d => d[field]);
    } else {
      chart.data.datasets[0].data = sorted.map(d => d[field]);
      chart.data.datasets[0].backgroundColor =
        sorted.map(d => d.peg < 1 ? '#34d399cc' : d.peg < 2 ? '#f59e0bcc' : '#f43f5ecc');
    }
  }

  chart.update();
}

let pegTickersVisible = true;
function togglePegTickers() {
  pegTickersVisible = !pegTickersVisible;
  const btn = document.getElementById('pegTickerBtn');
  btn.textContent = pegTickersVisible ? I18n.t('sector.hide_tickers') : I18n.t('sector.show_tickers');
  const chart = chartInstances.peg;
  if (!chart) return;
  chart.options.scales.y.ticks.display = pegTickersVisible;
  chart.update();
}

function toggleValues(chartKey) {
  valuesVisible[chartKey] = !valuesVisible[chartKey];
  const btn = document.querySelector(`.chart-toggle[data-chart="${chartKey}"]`);
  const text = btn.querySelector('.toggle-text');
  if (valuesVisible[chartKey]) {
    text.textContent = I18n.t('sector.hide_values');
    btn.classList.remove('bg-brand', 'text-white');
    btn.classList.add('text-brand', 'bg-brand/10');
  } else {
    text.textContent = I18n.t('sector.show_values');
    btn.classList.add('bg-brand', 'text-white');
    btn.classList.remove('text-brand', 'bg-brand/10');
  }
  if (chartInstances[chartKey]) {
    const chart = chartInstances[chartKey];
    chart.data.datasets.forEach(ds => {
      ds.datalabels = ds.datalabels || {};
      ds.datalabels.display = valuesVisible[chartKey];
    });
    chart.update();
  }
}

// Shared click-to-history plugin for every chart in this page
function tickerClickPlugin(getLabels) {
  return {
    afterEvent(chart, args) {
      const el = chart.getElementsAtEventForMode(args.event.native, 'nearest', {intersect:true}, false);
      chart.canvas.style.cursor = el.length ? 'pointer' : 'default';
    }
  };
}
function tickerOnClick(getLabels) {
  return function(e, elements) {
    if (!elements.length) return;
    const ticker = getLabels()[elements[0].index];
    if (ticker) window.location.href = `/history/${encodeURIComponent(ticker)}`;
  };
}

// Value label plugin - draws values on top of bars
function valueLabelPlugin(chartKey, formatter) {
  return {
    id: 'valueLabels_' + chartKey,
    afterDatasetsDraw(chart) {
      if (!valuesVisible[chartKey]) return;
      const {ctx: c} = chart;
      chart.data.datasets.forEach((ds, di) => {
        const meta = chart.getDatasetMeta(di);
        if (meta.hidden) return;
        meta.data.forEach((el, i) => {
          const val = ds.data[i];
          if (val == null) return;
          const label = formatter ? formatter(val, di) : val.toFixed(1);
          c.save();
          c.fillStyle = '#cbd5e1';
          c.font = '10px Inter,sans-serif';
          c.textAlign = 'center';
          if (chart.options.indexAxis === 'y') {
            c.textAlign = 'left';
            c.fillText(label, el.x + 4, el.y + 3);
          } else {
            c.fillText(label, el.x, el.y - 6);
          }
          c.restore();
        });
      });
    }
  };
}

const chartDefaults = {
  responsive: true, maintainAspectRatio: false,
  plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } } },
};

// -- PE + PEG grouped bars (dual axis)
(function(){
  const ctx = document.getElementById('pePegChart');
  chartInstances.pe = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'PE (TTM)',    data: DATA.map(d=>d.pe_ttm),  backgroundColor: '#6366f1cc', borderRadius: 4, yAxisID: 'yPE' },
        { label: 'PE (Fwd)',   data: DATA.map(d=>d.pe_fwd),   backgroundColor: '#38bdf8cc', borderRadius: 4, yAxisID: 'yPE' },
        { label: 'PEG',        data: DATA.map(d=>d.peg),      backgroundColor: '#34d399cc', borderRadius: 4, yAxisID: 'yPEG' },
      ]
    },
    options: {
      ...chartDefaults,
      onClick: tickerOnClick(() => labels),
      scales: {
        yPE:  { position:'left',  grid:{color:gridCol}, ticks:{color:tickCol}, title:{display:true,text:'PE Ratio',color:tickCol} },
        yPEG: { position:'right', grid:{display:false},  ticks:{color:'#34d399'}, title:{display:true,text:'PEG',color:'#34d399'} },
        x:    { grid:{display:false}, ticks:{color:tickCol} }
      },
      plugins: {
        ...chartDefaults.plugins,
        annotation: {},
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('pe', (v,di) => di<2 ? v.toFixed(1)+'x' : v.toFixed(2)), {
      afterDraw(chart) {
        const {ctx:c, chartArea:a, scales:{yPEG}} = chart;
        if (!yPEG) return;
        const y1 = yPEG.getPixelForValue(1);
        if (y1 > a.top && y1 < a.bottom) {
          c.save(); c.strokeStyle='#34d39966'; c.lineWidth=1.5; c.setLineDash([5,4]);
          c.beginPath(); c.moveTo(a.left, y1); c.lineTo(a.right, y1); c.stroke();
          c.fillStyle='#34d399'; c.font='10px Inter'; c.fillText('PEG = 1', a.right-50, y1-4);
          c.restore();
        }
      }
    }]
  });
})();

// -- Price vs Target
(function(){
  const ctx = document.getElementById('priceChart');
  chartInstances.prices = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'Current Price', data: DATA.map(d=>d.price),  backgroundColor:'#6366f1cc', borderRadius:4 },
        { label:'Target Price',  data: DATA.map(d=>d.target), backgroundColor:'#f59e0b44',
          borderColor:'#f59e0b', borderWidth:2, borderRadius:4 },
      ]
    },
    options: {
      ...chartDefaults,
      onClick: tickerOnClick(() => labels),
      scales: {
        x: { grid:{display:false}, ticks:{color:tickCol} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol,callback:v=>'$'+v} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('prices', v => '$'+v.toFixed(0))]
  });
})();

// -- Upside horizontal bar
(function(){
  const ctx = document.getElementById('upsideChart');
  const sorted = [...DATA].filter(d=>d.upside!=null).sort((a,b)=>a.upside-b.upside);
  chartInstances.upside = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d=>d.ticker),
      datasets: [{
        label: 'Upside %',
        data: sorted.map(d=>d.upside),
        backgroundColor: sorted.map(d => d.upside >= 0 ? '#34d399cc' : '#f43f5ecc'),
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      onClick: tickerOnClick(() => sorted.map(d=>d.ticker)),
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` ${c.raw?.toFixed(1)}%`}} },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol,callback:v=>v+'%'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('upside', v => v.toFixed(1)+'%'), {
      afterDraw(chart){
        const {ctx:c,chartArea:a,scales:{x}} = chart;
        const z = x.getPixelForValue(0);
        if(z>a.left&&z<a.right){ c.save();c.strokeStyle='#475569';c.lineWidth=1;c.beginPath();c.moveTo(z,a.top);c.lineTo(z,a.bottom);c.stroke();c.restore(); }
      }
    }]
  });
})();

// -- PEG map horizontal bar
(function(){
  const ctx = document.getElementById('pegChart');
  const sorted = [...DATA].filter(d=>d.peg!=null).sort((a,b)=>a.peg-b.peg);
  chartInstances.peg = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d=>d.ticker),
      datasets: [{
        label:'PEG',
        data: sorted.map(d=>d.peg),
        backgroundColor: sorted.map(d => d.peg<1?'#34d399cc':d.peg<2?'#f59e0bcc':'#f43f5ecc'),
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis:'y',
      onClick: tickerOnClick(() => sorted.map(d=>d.ticker)),
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` PEG: ${c.raw?.toFixed(2)}`}} },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('peg', v => v.toFixed(2)), {
      afterDraw(chart){
        const {ctx:c,chartArea:a,scales:{x}} = chart;
        [1,2].forEach(v=>{
          const px = x.getPixelForValue(v);
          if(px>a.left&&px<a.right){
            c.save();c.strokeStyle='#47556966';c.lineWidth=1;c.setLineDash([4,3]);
            c.beginPath();c.moveTo(px,a.top);c.lineTo(px,a.bottom);c.stroke();
            c.fillStyle='#64748b';c.font='10px Inter';c.fillText('PEG='+v,px+3,a.top+12);
            c.restore();
          }
        });
      }
    }]
  });
})();

// -- Day Change horizontal bar (heatmap colouring)
(function(){
  const ctx = document.getElementById('dayChangeChart');
  if (!ctx) return;
  const sorted = [...DATA].filter(d => d.day_change_pct != null)
                          .sort((a, b) => a.day_change_pct - b.day_change_pct);

  // Heatmap colour: intensity scales with magnitude, diverging green/red
  const maxAbs = Math.max(...sorted.map(d => Math.abs(d.day_change_pct)), 0.01);
  function heatColor(v) {
    const t = Math.min(Math.abs(v) / maxAbs, 1);           // 0 = near zero, 1 = extreme
    const alpha = 0.25 + t * 0.65;                         // 0.25 → 0.90
    return v >= 0
      ? `rgba(52,211,153,${alpha.toFixed(2)})`             // emerald
      : `rgba(244,63,94,${alpha.toFixed(2)})`;             // rose
  }

  chartInstances.day_change = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d => d.ticker),
      datasets: [{
        label: 'Day Change %',
        data: sorted.map(d => d.day_change_pct),
        backgroundColor: sorted.map(d => heatColor(d.day_change_pct)),
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      onClick: tickerOnClick(() => chartInstances.day_change.data.labels),
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => ` ${c.raw >= 0 ? '+' : ''}${c.raw?.toFixed(2)}%` } }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'%'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('day_change', v => (v>=0?'+':'')+v.toFixed(2)+'%'), {
      afterDraw(chart){
        const {ctx:c,chartArea:a,scales:{x}} = chart;
        const z = x.getPixelForValue(0);
        if(z>a.left&&z<a.right){
          c.save();c.strokeStyle='#475569';c.lineWidth=1;
          c.beginPath();c.moveTo(z,a.top);c.lineTo(z,a.bottom);c.stroke();c.restore();
        }
      }
    }]
  });
})();

// -- Growth grouped bars (TTM + Q)
(function(){
  const ctx = document.getElementById('growthChart');
  if (!ctx) return;
  const sorted = [...DATA].filter(d => d.eps_growth_ttm != null || d.eps_growth_q != null)
                          .sort((a, b) => (a.eps_growth_ttm ?? -Infinity) - (b.eps_growth_ttm ?? -Infinity));
  chartInstances.growth = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d => d.ticker),
      datasets: [
        {
          label: 'EPS Growth TTM',
          data: sorted.map(d => d.eps_growth_ttm),
          backgroundColor: sorted.map(d => (d.eps_growth_ttm ?? 0) >= 0 ? '#34d399cc' : '#f43f5ecc'),
          borderRadius: 4,
        },
        {
          label: 'EPS Growth Q',
          data: sorted.map(d => d.eps_growth_q),
          backgroundColor: sorted.map(d => (d.eps_growth_q ?? 0) >= 0 ? '#38bdf8cc' : '#fb923ccc'),
          borderRadius: 4,
        },
      ]
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      onClick: tickerOnClick(() => chartInstances.growth.data.labels),
      plugins: {
        ...chartDefaults.plugins,
        tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${c.raw?.toFixed(1)}%` } }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'%'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('growth', v => v.toFixed(1)+'%'), {
      afterDraw(chart){
        const {ctx:c,chartArea:a,scales:{x}} = chart;
        const z = x.getPixelForValue(0);
        if(z>a.left&&z<a.right){
          c.save();c.strokeStyle='#475569';c.lineWidth=1;
          c.beginPath();c.moveTo(z,a.top);c.lineTo(z,a.bottom);c.stroke();c.restore();
        }
      }
    }]
  });
})();

// -- EV/EBITDA horizontal bar
(function(){
  const ctx = document.getElementById('evEbitdaChart');
  if (!ctx) return;
  const sorted = [...DATA].filter(d => d.ev_ebitda != null).sort((a, b) => a.ev_ebitda - b.ev_ebitda);
  if (!sorted.length) return;
  const avg = avgOf(sorted.map(d => d.ev_ebitda));
  chartInstances.ev_ebitda = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d => d.ticker),
      datasets: [{
        label: 'EV/EBITDA',
        data: sorted.map(d => d.ev_ebitda),
        backgroundColor: sorted.map(d => {
          const v = d.ev_ebitda;
          return v < 8 ? '#34d399cc' : v < 13 ? '#38bdf8cc' : v < 20 ? '#f59e0bcc' : '#f43f5ecc';
        }),
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      layout: { padding: { top: 18 } },
      indexAxis: 'y',
      onClick: tickerOnClick(() => chartInstances.ev_ebitda.data.labels),
      plugins: { legend:{display:false}, tooltip:{callbacks:{
        label: c => {
          const v = c.raw;
          if (v == null) return ' EV/EBITDA: —';
          let band = v < 8 ? '便宜 (Cheap)' : v < 13 ? '正常 (Fair)' : v < 20 ? '成长型 (Growth)' : '高增长或泡沫 (High growth / Bubble)';
          return [` EV/EBITDA: ${v.toFixed(1)}x`, ` ${band}`];
        }
      }}},
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'x'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('ev_ebitda', v => v.toFixed(1)+'x'),
              avgLinePlugin(() => avg, v => v.toFixed(1)+'x', '#94a3b8')]
  });
})();

// -- helpers for average line
function avgOf(arr) {
  const vals = arr.filter(v => v != null);
  return vals.length ? vals.reduce((s, v) => s + v, 0) / vals.length : null;
}
function avgLinePlugin(getAvg, fmt, color) {
  return {
    afterDraw(chart) {
      const avg = getAvg();
      if (avg == null) return;
      const {ctx: c, chartArea: a, scales: {x}} = chart;
      const px = x.getPixelForValue(avg);
      if (px < a.left || px > a.right) return;
      c.save();
      c.strokeStyle = color;
      c.lineWidth = 1.5;
      c.setLineDash([5, 4]);
      c.beginPath(); c.moveTo(px, a.top); c.lineTo(px, a.bottom); c.stroke();
      c.fillStyle = color;
      c.font = 'bold 10px Inter,sans-serif';
      c.textAlign = 'center';
      c.fillText('avg ' + fmt(avg), px, a.top - 4);
      c.restore();
    }
  };
}

// -- EV ($B) horizontal bar
(function(){
  const ctx = document.getElementById('evChart');
  if (!ctx) return;
  const sorted = [...DATA].filter(d => d.ev != null).sort((a, b) => a.ev - b.ev);
  if (!sorted.length) return;
  const avg = avgOf(sorted.map(d => d.ev));
  chartInstances.ev = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d => d.ticker),
      datasets: [{
        label: 'EV ($B)',
        data: sorted.map(d => d.ev),
        backgroundColor: '#38bdf8cc',
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      layout: { padding: { top: 18 } },
      indexAxis: 'y',
      onClick: tickerOnClick(() => chartInstances.ev.data.labels),
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` EV: $${c.raw?.toFixed(1)}B`}} },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => '$'+v+'B'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('ev', v => '$'+v.toFixed(1)+'B'),
              avgLinePlugin(() => avg, v => '$'+v.toFixed(1)+'B', '#38bdf8')]
  });
})();

// -- EBITDA ($B) horizontal bar
(function(){
  const ctx = document.getElementById('ebitdaChart');
  if (!ctx) return;
  const sorted = [...DATA].filter(d => d.ebitda != null).sort((a, b) => a.ebitda - b.ebitda);
  if (!sorted.length) return;
  const avg = avgOf(sorted.map(d => d.ebitda));
  chartInstances.ebitda = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(d => d.ticker),
      datasets: [{
        label: 'EBITDA ($B)',
        data: sorted.map(d => d.ebitda),
        backgroundColor: '#a78bfacc',
        borderRadius: 4,
      }]
    },
    options: {
      ...chartDefaults,
      layout: { padding: { top: 18 } },
      indexAxis: 'y',
      onClick: tickerOnClick(() => chartInstances.ebitda.data.labels),
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` EBITDA: $${c.raw?.toFixed(1)}B`}} },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => '$'+v+'B'} },
        y: { grid:{display:false}, ticks:{color:'#94a3b8'} }
      }
    },
    plugins: [tickerClickPlugin(), valueLabelPlugin('ebitda', v => '$'+v.toFixed(1)+'B'),
              avgLinePlugin(() => avg, v => '$'+v.toFixed(1)+'B', '#a78bfa')]
  });
})();

// ---- Hide controls & legend entries when data is unavailable ----
  const hasVal = field => DATA.some(d => d[field] != null);
  const hide   = el => el && (el.style.display = 'none');

  // PE chart: hide sort buttons for missing metrics, hide legend for missing datasets
  const hasTtm = hasVal('pe_ttm'), hasFwd = hasVal('pe_fwd'), hasPeg = hasVal('peg');
  if (!hasTtm) hide(document.getElementById('pe-sort-pe_ttm'));
  if (!hasFwd) hide(document.getElementById('pe-sort-pe_fwd'));
  if (!hasPeg) hide(document.getElementById('pe-sort-peg'));
  // Hide the entire Sort pill if nothing to sort by
  if (!hasTtm && !hasFwd && !hasPeg) hide(document.querySelector('.pe-sort-btn')?.closest('div'));
  // Hide legend entries for missing datasets in PE chart
  if (chartInstances.pe) {
    const metas = chartInstances.pe.data.datasets.map((ds, i) => ({ds, meta: chartInstances.pe.getDatasetMeta(i)}));
    if (!hasTtm) { metas[0].meta.hidden = true; }
    if (!hasFwd) { metas[1].meta.hidden = true; }
    if (!hasPeg) { metas[2].meta.hidden = true; }
    // If all PE/PEG data missing, hide legend entirely
    if (!hasTtm && !hasFwd && !hasPeg) {
      chartInstances.pe.options.plugins.legend.display = false;
    }
    chartInstances.pe.update();
  }

  // Prices chart: hide sort button if no price/target data
  const hasPrice  = hasVal('price');
  const hasTarget = hasVal('target');
  if (!hasPrice && !hasTarget) {
    hide(document.querySelector('.chart-sort[data-chart="prices"]'));
    hide(document.querySelector('.chart-toggle[data-chart="prices"]'));
  }
  if (chartInstances.prices) {
    const pm = chartInstances.prices.data.datasets.map((ds, i) => chartInstances.prices.getDatasetMeta(i));
    if (!hasPrice)  pm[0].hidden = true;
    if (!hasTarget) pm[1].hidden = true;
    if (!hasPrice && !hasTarget) chartInstances.prices.options.plugins.legend.display = false;
    chartInstances.prices.update();
  }

  // Upside chart: hide sort button if no upside data
  if (!hasVal('upside')) {
    hide(document.querySelector('.chart-sort[data-chart="upside"]'));
    hide(document.querySelector('.chart-toggle[data-chart="upside"]'));
  }

  // PEG chart: hide sort + hide tickers button if no peg data
  if (!hasVal('peg')) {
    hide(document.querySelector('.chart-sort[data-chart="peg"]'));
    hide(document.querySelector('.chart-toggle[data-chart="peg"]'));
    hide(document.getElementById('pegTickerBtn'));
  }

(function(){
  let sortCol = 'ticker', sortDir = 1;

  function fmtNull(s){ return '<span class="text-slate-600">-</span>'; }
  function fmtPrice(v){ return v==null ? fmtNull() : '$'+v.toFixed(2); }
  function fmtPE(v){ return v==null ? fmtNull() : v.toFixed(1)+'x'; }
  function fmtPct(v){
    if(v==null) return fmtNull();
    const col = v>=0 ? 'text-emerald-400' : 'text-rose-400';
    return `<span class="${col} font-semibold">${v.toFixed(1)}%</span>`;
  }
  function fmtPeg(v){
    if(v==null) return fmtNull();
    const col = v<1?'text-emerald-400':v<2?'text-amber-400':'text-rose-400';
    return `<span class="${col} font-semibold">${v.toFixed(2)}</span>`;
  }
  function fmtCap(v){ return v==null ? fmtNull() : '$'+v.toFixed(1)+'B'; }
  function fmtGrowth(v){
    if(v==null) return fmtNull();
    const col = v>0 ? 'text-emerald-400' : 'text-rose-400';
    return `<span class="${col}">${v.toFixed(1)}%</span>`;
  }
  function fmtEvEbitda(v){
    if(v==null) return fmtNull();
    return `<span class="text-slate-200">${v.toFixed(1)}x</span>`;
  }
  function fmtBillions(v){
    if(v==null) return fmtNull();
    return `<span class="text-slate-200">$${v.toFixed(1)}B</span>`;
  }

  function render() {
    let rows = [...DATA];
    rows.sort((a,b) => {
      let av = a[sortCol], bv = b[sortCol];
      if (typeof av === 'string') av = av.toLowerCase();
      if (typeof bv === 'string') bv = bv.toLowerCase();
      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;
      return av < bv ? -sortDir : av > bv ? sortDir : 0;
    });

    document.querySelectorAll('#sectorTable th.sortable').forEach(th => {
      const icon = th.querySelector('.sort-icon');
      if (th.dataset.col === sortCol) {
        icon.innerHTML = sortDir === -1 ? '&#8595;' : '&#8593;';
        th.classList.add('text-brand');
        th.classList.remove('text-slate-500');
      } else {
        icon.innerHTML = '&#8597;';
        th.classList.remove('text-brand');
        th.classList.add('text-slate-500');
      }
    });

    document.getElementById('sectorTableBody').innerHTML = rows.map(d => `
      <tr class="border-b border-slate-800/60 hover:bg-slate-800/40 transition">
        <td class="py-2.5 px-3"><a href="/history/${d.ticker}" class="font-mono font-bold text-brand hover:underline">${d.ticker}</a></td>
        <td class="py-2.5 px-3 text-slate-400 text-xs max-w-[140px] truncate" title="${d.name}">${d.name}</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm">${fmtCap(d.market_cap)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPrice(d.price)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPrice(d.target)}</td>
        <td class="py-2.5 px-3 text-right">${fmtPct(d.upside)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPE(d.pe_ttm)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtPE(d.pe_fwd)}</td>
        <td class="py-2.5 px-3 text-right">${fmtPeg(d.peg)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtGrowth(d.eps_growth_ttm)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtGrowth(d.eps_growth_q)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtEvEbitda(d.ev_ebitda)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtBillions(d.ev)}</td>
        <td class="py-2.5 px-3 text-right font-mono">${fmtBillions(d.ebitda)}</td>
      </tr>`).join('');
  }

  document.querySelectorAll('#sectorTable th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      if (sortCol === th.dataset.col) sortDir *= -1;
      else { sortCol = th.dataset.col; sortDir = (sortCol === 'ticker' || sortCol === 'name') ? 1 : -1; }
      render();
    });
  });

  render();
})();
</script>
{% endblock %}
