{% extends "base.html" %}
{% block title %}yStocker — Valuation Dashboard{% endblock %}

{% block content %}

<!-- ── Fullscreen chart modal ────────────────────────────────────────── -->
<div x-data="chartModal()"
     x-show="open"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     @keydown.escape.window="close()"
     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
     style="display:none">

  <div class="relative w-full max-w-5xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl
              flex flex-col"
       style="max-height:90vh"
       @click.stop>

    <!-- Modal header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800 shrink-0">
      <div>
        <h3 class="font-semibold text-slate-100" x-text="title"></h3>
        <p class="text-xs text-slate-500 mt-0.5" x-text="subtitle"></p>
      </div>
      <button @click="close()"
              class="text-slate-500 hover:text-slate-200 transition p-1 rounded-lg hover:bg-slate-800">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Modal chart area -->
    <div class="p-6 flex-1 min-h-0">
      <div class="chart-container w-full h-full" style="min-height:460px">
        <canvas id="modalCanvas"></canvas>
      </div>
    </div>

    <!-- Legend for PEG map -->
    <div x-show="kind==='peg'" class="px-6 pb-4 flex gap-4 text-xs shrink-0">
      <span class="flex items-center gap-1.5 text-emerald-400"><span class="w-3 h-3 rounded-sm bg-emerald-400/70 inline-block"></span> <span data-i18n="modal.peg_under">PEG &lt; 1 — undervalued</span></span>
      <span class="flex items-center gap-1.5 text-amber-400"><span class="w-3 h-3 rounded-sm bg-amber-400/70 inline-block"></span> <span data-i18n="modal.peg_moderate">1–2 — moderate</span></span>
      <span class="flex items-center gap-1.5 text-rose-400"><span class="w-3 h-3 rounded-sm bg-rose-400/70 inline-block"></span> <span data-i18n="modal.peg_expensive">&gt; 2 — expensive</span></span>
    </div>
  </div>
</div>

<!-- ── Hero ──────────────────────────────────────────────────────────── -->
<div class="mb-6 sm:mb-8 fade-up">
  <h1 class="text-xl sm:text-2xl font-bold mb-1.5">
    <span class="grad-text" data-i18n="index.hero_title">Stock Valuation</span> <span data-i18n="index.hero_sub">Dashboard</span>
  </h1>
  <p class="text-slate-400 text-sm">
    <span data-i18n="index.hero_desc">PE ratios, PEG ratios &amp; analyst targets across</span> {{ sector_cards|length }} <span data-i18n="index.peer_groups">peer groups.</span>
  </p>
  {% if cache_last_updated %}
  <p class="text-xs text-slate-600 mt-1">
    <span data-i18n="index.data_as_of">Data as of</span> {{ cache_last_updated | int | datetimeformat }}
    {% if warming %}
      &nbsp;·&nbsp;<span class="text-brand animate-pulse" data-i18n="index.refreshing">refreshing now…</span>
    {% else %}
      &nbsp;·&nbsp;<span data-i18n="index.next_refresh">next refresh</span> {{ (cache_last_updated | int + 28800) | datetimeformat }}
    {% endif %}
  </p>
  {% endif %}
</div>

<!-- ── Sector cards ──────────────────────────────────────────────────── -->
<h2 id="sectors" class="text-lg sm:text-xl font-semibold text-slate-200 mb-4 fade-up" data-i18n="index.sector_overview">Sector Overview</h2>
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-5 mb-10">
  {% for group, info in sector_cards.items() %}
  <a href="{{ url_for('main.sector', sector_name=group) }}"
     data-group="{{ group }}"
     class="sector-card group bg-slate-900 border border-slate-800 rounded-2xl p-5 hover:border-brand/60
            hover:shadow-lg hover:shadow-brand/10 transition-all duration-200 fade-up block">
    <div class="flex items-start justify-between mb-3">
      <div>
        <h3 class="font-semibold text-slate-100 group-hover:text-brand transition"
            data-i18n="sector.name.{{ group }}">{{ group }}</h3>
        <p class="text-xs text-slate-500 mt-0.5">{{ info.tickers | join(' · ') }}</p>
      </div>
      <span class="sector-day-chg text-xs font-semibold px-1.5 py-0.5 rounded-md transition text-slate-600"></span>
    </div>
    <div class="chart-container" style="height:80px">
      <canvas id="spark_{{ loop.index }}"></canvas>
    </div>
    <p class="spark-label text-xs text-slate-400 mt-2 text-right" data-i18n="index.analyst_upside">analyst upside %</p>
  </a>
  {% endfor %}
</div>

<!-- ── Quick links ───────────────────────────────────────────────────── -->
<div class="flex flex-wrap gap-2 mb-6 fade-up">
  <a href="#stock-pe"
     class="px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-700 text-slate-400
            hover:border-brand/60 hover:text-brand transition-all">
    <span data-i18n="index.jump_stock_pe">↓ Stock PE</span>
  </a>
  <a href="#etf-pe"
     class="px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-700 text-slate-400
            hover:border-brand/60 hover:text-brand transition-all">
    <span data-i18n="index.jump_etf_pe">↓ ETF PE</span>
  </a>
</div>

<!-- ── Cross-sector scatter (PE vs Upside) ───────────────────────────── -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

  <!-- Valuation scatter — 2/3 width -->
  <div class="lg:col-span-2 bg-slate-900 rounded-2xl border border-slate-800 p-4 sm:p-6 fade-up">
    <div class="flex items-start justify-between mb-1">
      <h2 class="text-base font-semibold text-slate-200" data-i18n="index.valuation_map">Valuation Map</h2>
      <div class="flex items-center gap-1">
        <button id="scatterTextToggle"
                onclick="toggleScatterText()"
                class="flex items-center gap-1 text-xs text-white border border-brand/40 bg-brand
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg">
          <span id="scatterTextToggleText" data-i18n="index.show_labels">Show labels</span>
        </button>
        <button id="scatterLabelToggle"
                onclick="toggleScatterLabels()"
                class="flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                       hover:text-slate-200 transition px-2 py-1 rounded-lg">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-5 5a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 10V5a2 2 0 012-2z"/>
          </svg>
          <span id="scatterLabelToggleText" data-i18n="index.hide_tickers">Hide tickers</span>
        </button>
        <button onclick="window._chartModal.expand('scatter')"
                class="flex items-center gap-1 text-xs text-slate-500 hover:text-brand transition px-2 py-1
                       rounded-lg hover:bg-slate-800">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
          </svg>
          <span data-i18n="index.expand">Expand</span>
        </button>
      </div>
    </div>
    <p class="text-xs text-slate-500 mb-4" data-i18n="index.valuation_map_desc">Forward PE vs Analyst Upside — top-left = cheap with upside</p>
    <div class="chart-container" style="height:260px; sm:height:340px">
      <canvas id="scatterChart"></canvas>
    </div>
  </div>

  <!-- PEG Valuation Map — 1/3 width -->
  <div class="bg-slate-900 rounded-2xl border border-slate-800 p-4 sm:p-6 fade-up">
    <div class="flex items-start justify-between mb-1">
      <h2 class="text-base font-semibold text-slate-200" data-i18n="index.peg_map">PEG Valuation Map</h2>
      <div class="flex items-center gap-2">
        <button id="pegMapLabelBtn" onclick="togglePegMapLabels()"
                class="flex items-center gap-1 text-xs text-brand border border-brand/40 bg-brand/10
                       hover:bg-brand hover:text-white transition px-2 py-1 rounded-lg"
                data-i18n="index.hide_values">
          Hide values
        </button>
        <button onclick="window._chartModal.expand('peg')"
                class="flex items-center gap-1 text-xs text-slate-500 hover:text-brand transition px-2 py-1
                       rounded-lg hover:bg-slate-800">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/>
          </svg>
          <span data-i18n="index.expand">Expand</span>
        </button>
      </div>
    </div>
    <p class="text-xs text-slate-500 mb-4">
      <span class="text-emerald-400">■</span> <span data-i18n="index.peg_under">&lt;1 — undervalued</span> &nbsp;
      <span class="text-amber-400">■</span> <span data-i18n="index.peg_moderate">1–2 — moderate</span> &nbsp;
      <span class="text-rose-400">■</span> <span data-i18n="index.peg_expensive">&gt;2 — expensive</span>
    </p>
    <div class="chart-container" style="height:300px">
      <canvas id="pegMapChart"></canvas>
    </div>
  </div>
</div>

<!-- ── Cross-sector PE heatmap table ─────────────────────────────────── -->
<div id="stock-pe" class="bg-slate-900 rounded-2xl border border-slate-800 p-4 sm:p-6 fade-up mb-8">

  <!-- Header row -->
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <div>
      <h2 class="text-base font-semibold text-slate-200" data-i18n="index.heatmap">PE &amp; PEG Heatmap</h2>
      <p class="text-xs text-slate-500" data-i18n="index.heatmap_desc">Colour intensity = ratio magnitude</p>
    </div>

    <div class="ml-auto flex flex-wrap items-center gap-2">
      <!-- Heat legend -->
      <div class="hidden sm:flex items-center gap-1.5 text-xs text-slate-500 mr-2">
        <span class="w-3 h-3 rounded-sm inline-block" style="background:rgba(52,211,153,0.35)"></span><span data-i18n="index.heat_low">Low</span>
        <span class="w-16 h-2 rounded-sm inline-block mx-1"
              style="background:linear-gradient(to right,rgba(52,211,153,0.35),rgba(250,204,21,0.35),rgba(248,113,113,0.35))"></span>
        <span class="w-3 h-3 rounded-sm inline-block" style="background:rgba(248,113,113,0.35)"></span><span data-i18n="index.heat_high">High PE</span>
      </div>
      <!-- Sector filter -->
      <div class="relative" id="sectorFilterWrap">
        <select id="sectorFilter"
                class="appearance-none bg-slate-800 border border-slate-700 rounded-lg pl-3 pr-7 py-1.5
                       text-xs text-slate-300 focus:outline-none focus:ring-1 focus:ring-brand cursor-pointer">
          <option value="" data-i18n="index.all_sectors">All sectors</option>
        </select>
        <svg class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>

      <!-- Search -->
      <div class="relative">
        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500 pointer-events-none"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
        </svg>
        <input id="heatmapSearch" type="text"
               data-i18n-placeholder="index.search_ph"
               placeholder="Search…"
               class="bg-slate-800 border border-slate-700 rounded-lg pl-7 pr-3 py-1.5 text-xs
                      text-slate-200 placeholder:text-slate-500 focus:outline-none focus:ring-1
                      focus:ring-brand w-32 sm:w-44 transition">
      </div>

      <!-- Sort by day change -->
      <button id="heatmapDayChgSort"
              onclick="heatmapSortByDayChg()"
              class="flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                     hover:text-slate-200 transition px-2 py-1.5 rounded-lg whitespace-nowrap">
        Day Chg <span id="heatmapDayChgArrow">↕</span>
      </button>

      <!-- Row count -->
      <span id="heatmapCount" class="text-xs text-slate-600 whitespace-nowrap"></span>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="heatmapTable">
      <thead>
        <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
          <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="ticker"><span data-i18n="th.ticker">Ticker</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="sector"><span data-i18n="th.sector">Sector</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="pe_ttm"><span data-i18n="th.pe_ttm">PE (TTM)</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="pe_fwd"><span data-i18n="th.pe_fwd">PE (Fwd)</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="peg"><span data-i18n="th.peg">PEG</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="eps_growth_ttm"><span data-i18n="th.eps_growth_ttm">EPS Gr TTM</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="eps_growth_q"><span data-i18n="th.eps_growth_q">EPS Gr Q</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="upside"><span data-i18n="th.upside">Upside</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="ev_ebitda"><span data-i18n="th.ev_ebitda">EV/EBITDA</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="market_cap"><span data-i18n="th.mkt_cap">Mkt Cap</span> <span class="sort-icon ml-0.5">↕</span></th>
        </tr>
      </thead>
      <tbody id="heatmapBody"></tbody>
    </table>
  </div>
</div>

<!-- ── ETF PE table ──────────────────────────────────────────────────── -->
<div id="etf-pe" class="bg-slate-900 rounded-2xl border border-slate-800 p-4 sm:p-6 fade-up mb-8">
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <div>
      <h2 class="text-base font-semibold text-slate-200" data-i18n="index.etf_heatmap">ETF PE Heatmap</h2>
      <p class="text-xs text-slate-500" data-i18n="index.etf_heatmap_desc">PE ratios for ETFs — PEG and growth metrics are not applicable</p>
    </div>
    <div class="ml-auto flex flex-wrap items-center gap-2">
      <div class="hidden sm:flex items-center gap-1.5 text-xs text-slate-500 mr-2">
        <span class="w-3 h-3 rounded-sm inline-block" style="background:rgba(52,211,153,0.35)"></span><span data-i18n="index.heat_low">Low</span>
        <span class="w-16 h-2 rounded-sm inline-block mx-1"
              style="background:linear-gradient(to right,rgba(52,211,153,0.35),rgba(250,204,21,0.35),rgba(248,113,113,0.35))"></span>
        <span class="w-3 h-3 rounded-sm inline-block" style="background:rgba(248,113,113,0.35)"></span><span data-i18n="index.heat_high">High PE</span>
      </div>
      <button id="etfDayChgSort"
              onclick="etfSortByDayChg()"
              class="flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                     hover:text-slate-200 transition px-2 py-1.5 rounded-lg whitespace-nowrap">
        Day Chg <span id="etfDayChgArrow">↕</span>
      </button>
      <span id="etfHeatmapCount" class="text-xs text-slate-600 whitespace-nowrap"></span>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="etfHeatmapTable">
      <thead>
        <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
          <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="ticker"><span data-i18n="th.ticker">Ticker</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-left py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="sector"><span data-i18n="th.sector">Sector</span> <span class="sort-icon ml-0.5">↕</span></th>
          <th class="text-right py-2 px-3 font-medium sortable cursor-pointer hover:text-slate-300 transition whitespace-nowrap"
              data-col="pe_ttm"><span data-i18n="th.pe_ttm">PE (TTM)</span> <span class="sort-icon ml-0.5">↕</span></th>
        </tr>
      </thead>
      <tbody id="etfHeatmapBody"></tbody>
    </table>
  </div>
</div>

<!-- ── Chart.js scripts ───────────────────────────────────────────────── -->
<script>
const ALL = {{ all_chartdata | safe }};
const PALETTE = [
  '#6366f1','#38bdf8','#34d399','#f59e0b','#f43f5e','#a78bfa','#fb923c','#22d3ee'
];

// ─── Scatter label toggle state ─────────────────────────────────────────────
const SCATTER_DEFAULT_SECTORS = new Set(['Tech', 'Cloud / SaaS', 'Semiconductors']);
let scatterLabelsVisible = true;  // dots (tickers)
let scatterTextVisible   = false; // ticker text next to dots — hidden by default
let _inlineScatterChart = null;

// Hide labels = hide ticker text next to dots only
function toggleScatterText() {
  scatterTextVisible = !scatterTextVisible;
  const btn  = document.getElementById('scatterTextToggle');
  const text = document.getElementById('scatterTextToggleText');
  text.textContent = I18n.t(scatterTextVisible ? 'index.hide_labels' : 'index.show_labels');
  if (scatterTextVisible) {
    btn.classList.remove('bg-brand', 'text-white');
    btn.classList.add('text-brand', 'bg-brand/10');
  } else {
    btn.classList.add('bg-brand', 'text-white');
    btn.classList.remove('text-brand', 'bg-brand/10');
  }
  if (_inlineScatterChart) _inlineScatterChart.update();
}

// Hide tickers = hide dots (and their text) via legend hidden state
function toggleScatterLabels() {
  scatterLabelsVisible = !scatterLabelsVisible;
  const btn  = document.getElementById('scatterLabelToggle');
  const text = document.getElementById('scatterLabelToggleText');
  if (scatterLabelsVisible) {
    text.textContent = I18n.t('index.hide_tickers');
    btn.classList.remove('bg-brand', 'text-white');
    btn.classList.add('text-slate-400', 'bg-slate-800');
    btn.classList.remove('border-brand/40');
    btn.classList.add('border-slate-700');
  } else {
    text.textContent = I18n.t('index.show_tickers');
    btn.classList.add('bg-brand', 'text-white');
    btn.classList.remove('text-slate-400', 'bg-slate-800');
    btn.classList.add('border-brand/40');
    btn.classList.remove('border-slate-700');
  }
  if (_inlineScatterChart) {
    _inlineScatterChart.data.datasets.forEach((ds, di) => {
      _inlineScatterChart.getDatasetMeta(di).hidden = !scatterLabelsVisible;
      ds.pointRadius      = scatterLabelsVisible ? 7 : 0;
      ds.pointHoverRadius = scatterLabelsVisible ? 9 : 0;
    });
    _inlineScatterChart.update();
  }
}

// ─── Shared chart builder functions ────────────────────────────────────────

function buildScatterChart(ctx) {
  const sectors = [...new Set(ALL.map(d => d.sector))];
  const datasets = sectors.map((sec, i) => ({
    label: I18n.tSector(sec),
    _key: sec,
    data: ALL.filter(d => d.sector === sec && d.pe_fwd != null && d.upside != null)
              .map(d => ({ x: d.pe_fwd, y: d.upside, ticker: d.ticker })),
    backgroundColor: PALETTE[i % PALETTE.length] + 'cc',
    pointRadius: SCATTER_DEFAULT_SECTORS.has(sec) ? 7 : 0,
    pointHoverRadius: SCATTER_DEFAULT_SECTORS.has(sec) ? 9 : 0,
  })).filter(ds => ds.data.length > 0);
  const chart = new Chart(ctx, {
    type: 'scatter',
    data: { datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      onClick(e, elements) {
        if (elements.length) {
          const pt = elements[0];
          const ticker = datasets[pt.datasetIndex].data[pt.index].ticker;
          if (ticker) window.location.href = `/history/${encodeURIComponent(ticker)}`;
        }
      },
      plugins: {
        legend: {
          labels: { color: '#94a3b8', font: { size: 11 } },
          onClick(e, legendItem, legend) {
            // Default Chart.js toggle behaviour
            Chart.defaults.plugins.legend.onClick.call(this, e, legendItem, legend);
            const chart = legend.chart;
            const di    = legendItem.datasetIndex;
            const hidden = chart.getDatasetMeta(di).hidden;
            // Sync pointRadius for this dataset
            chart.data.datasets[di].pointRadius      = hidden ? 0 : 7;
            chart.data.datasets[di].pointHoverRadius = hidden ? 0 : 9;
            // If any dataset is now visible, flip scatterLabelsVisible on
            const anyVisible = chart.data.datasets.some((_, i) => !chart.getDatasetMeta(i).hidden);
            if (anyVisible && !scatterLabelsVisible) {
              scatterLabelsVisible = true;
              const btn  = document.getElementById('scatterLabelToggle');
              const text = document.getElementById('scatterLabelToggleText');
              text.textContent = I18n.t('index.hide_tickers');
              btn.classList.remove('bg-brand', 'text-white', 'border-brand/40');
              btn.classList.add('text-slate-400', 'bg-slate-800', 'border-slate-700');
            }
            chart.update();
          }
        },
        tooltip: { callbacks: { label: c => ` ${c.raw.ticker}  PE ${c.raw.x?.toFixed(1)}x  Upside ${c.raw.y?.toFixed(1)}%` } }
      },
      scales: {
        x: { title: { display: true, text: 'Forward PE', color: '#64748b' }, grid: { color: '#1e293b' }, ticks: { color: '#64748b' } },
        y: { title: { display: true, text: 'Upside (%)', color: '#64748b' }, grid: { color: '#1e293b' }, ticks: { color: '#64748b' } }
      }
    },
    plugins: [{
      afterDraw(chart) {
        const {ctx: c, chartArea: a, scales: {x, y}} = chart;
        c.save();
        c.strokeStyle = '#334155'; c.lineWidth = 1; c.setLineDash([4,4]);
        const z = y.getPixelForValue(0);
        if (z > a.top && z < a.bottom) { c.beginPath(); c.moveTo(a.left, z); c.lineTo(a.right, z); c.stroke(); }
        c.restore();
        if (scatterTextVisible) {
          chart.data.datasets.forEach((ds, di) => {
            if (chart.getDatasetMeta(di).hidden) return;
            ds.data.forEach(pt => {
              const px = x.getPixelForValue(pt.x), py = y.getPixelForValue(pt.y);
              c.save(); c.fillStyle = '#94a3b8'; c.font = '10px Inter,sans-serif';
              c.fillText(pt.ticker, px + 8, py - 4); c.restore();
            });
          });
        }
      },
      // Pointer cursor when hovering a point
      afterEvent(chart, args) {
        const el = chart.getElementsAtEventForMode(args.event.native, 'nearest', {intersect:true}, false);
        chart.canvas.style.cursor = el.length ? 'pointer' : 'default';
      }
    }]
  });
  // Hide non-default sectors on load
  chart.data.datasets.forEach((ds, di) => {
    if (!SCATTER_DEFAULT_SECTORS.has(ds._key)) {
      chart.getDatasetMeta(di).hidden = true;
    }
  });
  chart.update();
  return chart;
}

let _pegMapLabelsVisible = true;

function buildPegChart(ctx) {
  const seen = new Set();
  const rows = ALL.filter(d => {
    if (d.peg == null || seen.has(d.ticker)) return false;
    seen.add(d.ticker); return true;
  }).sort((a,b) => a.peg - b.peg);
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(d => d.ticker),
      datasets: [{
        label: 'PEG',
        data: rows.map(d => d.peg),
        backgroundColor: rows.map(d => d.peg < 1 ? '#34d399cc' : d.peg < 2 ? '#f59e0bcc' : '#f43f5ecc'),
        borderRadius: 4,
      }]
    },
    options: {
      indexAxis: 'y', responsive: true, maintainAspectRatio: false,
      onClick(e, elements) {
        if (elements.length) {
          const ticker = rows[elements[0].index]?.ticker;
          if (ticker) window.location.href = `/history/${encodeURIComponent(ticker)}`;
        }
      },
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` PEG: ${c.raw?.toFixed(2)}` } } },
      scales: {
        x: { grid: { color: '#1e293b' }, ticks: { color: '#64748b' } },
        y: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 11 } } }
      }
    },
    plugins: [{
      afterEvent(chart, args) {
        const el = chart.getElementsAtEventForMode(args.event.native, 'nearest', {intersect:true}, false);
        chart.canvas.style.cursor = el.length ? 'pointer' : 'default';
      },
      afterDatasetsDraw(chart) {
        if (!_pegMapLabelsVisible) return;
        const {ctx: c} = chart;
        chart.data.datasets[0].data.forEach((val, i) => {
          if (val == null) return;
          const el = chart.getDatasetMeta(0).data[i];
          c.save();
          c.fillStyle = '#cbd5e1';
          c.font = '10px Inter,sans-serif';
          c.textAlign = 'left';
          c.fillText(val.toFixed(2), el.x + 4, el.y + 3);
          c.restore();
        });
      }
    }]
  });
}

// ─── Render inline charts ──────────────────────────────────────────────────
_inlineScatterChart = buildScatterChart(document.getElementById('scatterChart'));
const _pegMapChart = buildPegChart(document.getElementById('pegMapChart'));

let _pegMapTickersVisible = true;
function togglePegMapTickers() {
  _pegMapTickersVisible = !_pegMapTickersVisible;
  const btn = document.getElementById('pegMapTickerBtn');
  btn.textContent = I18n.t(_pegMapTickersVisible ? 'index.hide_tickers' : 'index.show_tickers');
  _pegMapChart.options.scales.y.ticks.display = _pegMapTickersVisible;
  _pegMapChart.update();
}

function togglePegMapLabels() {
  _pegMapLabelsVisible = !_pegMapLabelsVisible;
  const btn = document.getElementById('pegMapLabelBtn');
  btn.textContent = I18n.t(_pegMapLabelsVisible ? 'index.hide_values' : 'index.show_values');
  if (_pegMapLabelsVisible) {
    btn.classList.remove('bg-brand', 'text-white');
    btn.classList.add('text-brand', 'bg-brand/10');
  } else {
    btn.classList.add('bg-brand', 'text-white');
    btn.classList.remove('text-brand', 'bg-brand/10');
  }
  _pegMapChart.update();
}

// ─── Alpine modal component ────────────────────────────────────────────────
function chartModal() {
  return {
    open: false,
    kind: '',
    title: '',
    subtitle: '',
    _instance: null,

    expand(kind) {
      this.kind = kind;
      if (kind === 'scatter') {
        this.title    = I18n.t('index.valuation_map');
        this.subtitle = I18n.t('index.valuation_map_desc');
      } else {
        this.title    = I18n.t('index.peg_map');
        this.subtitle = 'Price/Earnings-to-Growth ratio — all tickers';
      }
      this.open = true;
      // Defer until the canvas is visible in the DOM
      this.$nextTick(() => {
        if (this._instance) { this._instance.destroy(); this._instance = null; }
        const canvas = document.getElementById('modalCanvas');
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        this._instance = kind === 'scatter'
          ? buildScatterChart(canvas)
          : buildPegChart(canvas);
      });
    },

    close() {
      this.open = false;
      if (this._instance) { this._instance.destroy(); this._instance = null; }
    }
  };
}

// Expose so the onclick buttons (outside Alpine scope) can call it
document.addEventListener('alpine:init', () => {
  Alpine.data('chartModal', chartModal);
});
// Also keep a direct handle for the onclick= attributes
document.addEventListener('DOMContentLoaded', () => {
  window._chartModal = document.querySelector('[x-data="chartModal()"]')?.__x?.$data
    || { expand(k){ Alpine.$data(document.querySelector('[x-data="chartModal()"]')).expand(k); } };
  // Patch: wait a tick for Alpine to initialise
  setTimeout(() => {
    const el = document.querySelector('[x-data="chartModal()"]');
    if (el && el._x_dataStack) window._chartModal = el._x_dataStack[0];
  }, 200);
});

// ── Sparklines per sector card
{% for group, info in sector_cards.items() %}
(function(){
  const ctx = document.getElementById('spark_{{ loop.index }}');
  if (!ctx) return;
  const all = {{ info.chartdata | tojson }};
  const hasUpside = all.some(d => d.upside != null);
  const label = ctx.closest('a').querySelector('.spark-label');

  let rows, getValue, getColor, tooltipFn;
  if (hasUpside) {
    rows      = all.filter(d => d.upside != null);
    getValue  = d => d.upside;
    getColor  = d => d.upside >= 0 ? '#34d39999' : '#f43f5e99';
    tooltipFn = c => ` ${c.label}: ${c.raw?.toFixed(1)}%`;
    if (label) label.dataset.i18n = 'index.analyst_upside';
  } else {
    rows      = all.filter(d => d.pe_fwd != null || d.pe_ttm != null);
    getValue  = d => d.pe_fwd ?? d.pe_ttm;
    getColor  = () => '#6366f199';
    tooltipFn = c => ` ${c.label}: ${c.raw?.toFixed(1)}x PE`;
    if (label) label.dataset.i18n = 'index.fwd_pe';
  }
  if (!rows.length) return;
  // Apply i18n to the spark label
  if (label) I18n.apply(label.closest('a'));
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(d => d.ticker),
      datasets: [{ data: rows.map(getValue), backgroundColor: rows.map(getColor), borderRadius: 3 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      onClick(e, elements) {
        if (elements.length) {
          const ticker = rows[elements[0].index]?.ticker;
          if (ticker) window.location.href = `/history/${encodeURIComponent(ticker)}`;
        }
      },
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipFn } } },
      scales: { x: { display: false }, y: { display: false } }
    },
    plugins: [{
      afterEvent(chart, args) {
        const el = chart.getElementsAtEventForMode(args.event.native, 'nearest', {intersect:true}, false);
        chart.canvas.style.cursor = el.length ? 'pointer' : 'default';
      }
    }]
  });
})();
{% endfor %}

// ── Sector card day-change heatmap + sort
(function(){
  // Compute average day_change_pct per sector (deduplicated tickers)
  const seen = new Set();
  const sectorChanges = {};
  ALL.forEach(d => {
    if (seen.has(d.ticker)) return;
    seen.add(d.ticker);
    if (d.day_change_pct == null) return;
    if (!sectorChanges[d.sector]) sectorChanges[d.sector] = [];
    sectorChanges[d.sector].push(d.day_change_pct);
  });
  const sectorAvg = {};
  Object.entries(sectorChanges).forEach(([s, vals]) => {
    sectorAvg[s] = vals.reduce((a, b) => a + b, 0) / vals.length;
  });

  // Find max abs for intensity scaling
  const maxAbs = Math.max(...Object.values(sectorAvg).map(Math.abs), 0.01);

  function cardColor(avg) {
    const t = Math.min(Math.abs(avg) / maxAbs, 1);
    const alpha = (0.06 + t * 0.34).toFixed(2);        // 0.06 (faint) → 0.40 (dark)
    const borderAlpha = (0.2 + t * 0.65).toFixed(2);   // 0.20 → 0.85
    const isUp = avg >= 0;
    return {
      bg:     isUp ? `rgba(52,211,153,${alpha})`   : `rgba(244,63,94,${alpha})`,
      border: isUp ? `rgba(52,211,153,${borderAlpha})` : `rgba(244,63,94,${borderAlpha})`,
      text:   isUp ? '#34d399' : '#f43f5e',
      label:  (avg >= 0 ? '+' : '') + avg.toFixed(2) + '%',
    };
  }

  // Collect cards and sort by avg desc (best performers first)
  const grid = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2');
  if (!grid) return;
  const cards = [...grid.querySelectorAll('.sector-card')];

  // Sort cards by avg day change descending
  cards.sort((a, b) => {
    const av = sectorAvg[a.dataset.group] ?? -Infinity;
    const bv = sectorAvg[b.dataset.group] ?? -Infinity;
    return bv - av;
  });
  cards.forEach(card => grid.appendChild(card));

  // Apply colours
  cards.forEach(card => {
    const avg = sectorAvg[card.dataset.group];
    const badge = card.querySelector('.sector-day-chg');
    if (avg == null) return;
    const col = cardColor(avg);
    card.style.background = col.bg;
    card.style.borderColor = col.border;
    if (badge) {
      badge.textContent = col.label;
      badge.style.color = col.text;
      badge.style.background = col.bg;
    }
  });
})();

// ── Heatmap table (interactive: filter + sort)
(function(){
  const ETF_SECTORS = new Set(['US Broad ETFs', 'Sector ETFs', 'International ETFs']);

  // Deduplicate: keep first occurrence of each ticker
  const seen = new Set();
  const allRows = ALL.filter(d => { if (seen.has(d.ticker)) return false; seen.add(d.ticker); return true; });

  const stockRows = allRows.filter(d => !ETF_SECTORS.has(d.sector));
  const etfRows   = allRows.filter(d =>  ETF_SECTORS.has(d.sector));

  // ── Stock heatmap state
  let sortCol = 'market_cap', sortDir = -1;
  let filterSector = '', filterText = '';

  // Populate sector dropdown (stocks only)
  const sectors = [...new Set(stockRows.map(d => d.sector))].sort();
  const sel = document.getElementById('sectorFilter');
  sectors.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = I18n.tSector(s); sel.appendChild(o); });

  // ── ETF heatmap state
  let etfSortCol = 'pe_ttm', etfSortDir = 1;

  // ── Helpers
  function heatColor(val, lo, hi) {
    if (val == null) return '';
    const t = Math.min(1, Math.max(0, (val - lo) / (hi - lo)));
    const stops = [[52,211,153],[250,204,21],[248,113,113]];
    function lerp(a,b,t){ return a.map((v,i)=>Math.round(v+(b[i]-v)*t)); }
    const col = t < 0.5 ? lerp(stops[0],stops[1],t*2) : lerp(stops[1],stops[2],(t-0.5)*2);
    return `background:rgba(${col[0]},${col[1]},${col[2]},0.25);color:rgb(${col[0]},${col[1]},${col[2]})`;
  }
  function fmtPct(v){ return v==null?'<span class="text-slate-600">—</span>':`<span class="${v>=0?'text-emerald-400':'text-rose-400'} font-medium">${v.toFixed(1)}%</span>`; }
  function fmtPeg(v){
    if(v==null) return '<span class="text-slate-600">—</span>';
    const col=v<1?'text-emerald-400':v<2?'text-amber-400':'text-rose-400';
    return `<span class="${col} font-semibold">${v.toFixed(2)}</span>`;
  }
  function fmtPE(v){ return v==null?'<span class="text-slate-600">—</span>':v.toFixed(1)+'x'; }
  function fmtCap(v){ return v==null?'<span class="text-slate-600">—</span>':'$'+v.toFixed(1)+'B'; }
  function fmtGrowth(v){
    if(v==null) return '<span class="text-slate-600">—</span>';
    const col = v>0?'text-emerald-400':'text-rose-400';
    return `<span class="${col}">${v.toFixed(1)}%</span>`;
  }
  function fmtDayChg(v){
    if(v==null) return '<span class="text-slate-600">—</span>';
    const col = v>=0?'text-emerald-400':'text-rose-400';
    return `<span class="${col} font-medium">${v>=0?'+':''}${v.toFixed(2)}%</span>`;
  }
  // Heatmap background for a cell based on day change value
  // Compute max abs day change across all rows for dynamic scaling
  const _maxDayChg = Math.max(...allRows.map(d => Math.abs(d.day_change_pct ?? 0)), 0.01);

  function dayChgHeat(v) {
    if (v == null) return '';
    const t = Math.min(Math.abs(v) / _maxDayChg, 1); // 0 = smallest, 1 = largest mover
    const alpha = (0.08 + t * 0.72).toFixed(2);       // 0.08 (faint) → 0.80 (dark)
    return v >= 0
      ? `background:rgba(52,211,153,${alpha})`         // dark green = large up
      : `background:rgba(244,63,94,${alpha})`;         // dark red   = large down
  }

  function sortRows(rows, col, dir) {
    return [...rows].sort((a, b) => {
      let av = a[col], bv = b[col];
      if (typeof av === 'string') av = av.toLowerCase();
      if (typeof bv === 'string') bv = bv.toLowerCase();
      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;
      return av < bv ? -dir : av > bv ? dir : 0;
    });
  }

  function updateIcons(tableId, col, dir) {
    document.querySelectorAll(`#${tableId} th.sortable`).forEach(th => {
      const icon = th.querySelector('.sort-icon');
      if (th.dataset.col === col) {
        icon.textContent = dir === -1 ? '↓' : '↑';
        th.classList.add('text-brand'); th.classList.remove('text-slate-500');
      } else {
        icon.textContent = '↕';
        th.classList.remove('text-brand'); th.classList.add('text-slate-500');
      }
    });
  }

  // ── Stock render
  function render() {
    const q = filterText.toLowerCase();
    let rows = stockRows.filter(d => {
      if (filterSector && d.sector !== filterSector) return false;
      if (q && !d.ticker.toLowerCase().includes(q) && !d.name.toLowerCase().includes(q) && !I18n.stockName(d.ticker, '').toLowerCase().includes(q)) return false;
      return true;
    });
    rows = sortRows(rows, sortCol, sortDir);
    updateIcons('heatmapTable', sortCol, sortDir);
    document.getElementById('heatmapCount').textContent = `${rows.length} ticker${rows.length !== 1 ? 's' : ''}`;
    document.getElementById('heatmapBody').innerHTML = rows.length ? rows.map(d => {
      const chgStyle = dayChgHeat(d.day_change_pct);
      const chgText  = d.day_change_pct != null ? (d.day_change_pct >= 0 ? '+' : '') + d.day_change_pct.toFixed(2) + '%' : '';
      const chgColor = d.day_change_pct == null ? '' : d.day_change_pct >= 0 ? 'color:rgb(52,211,153)' : 'color:rgb(244,63,94)';
      return `
      <tr class="border-b border-slate-800/60 hover:bg-slate-800/40 transition">
        <td class="py-2 px-3" style="${chgStyle}">
          <a href="/history/${d.ticker}" class="font-mono font-bold text-slate-100 hover:underline">${d.ticker}</a>
          <div class="text-slate-400 text-xs truncate max-w-[120px]">${I18n.stockName(d.ticker, d.name)}</div>
          <div class="text-[10px] font-semibold mt-0.5" style="${chgColor}">${chgText}</div>
        </td>
        <td class="py-2 px-3 text-xs text-slate-500">${I18n.tSector(d.sector)}</td>
        <td class="py-2 px-3 text-right font-mono text-sm" style="${heatColor(d.pe_ttm,10,60)}">${fmtPE(d.pe_ttm)}</td>
        <td class="py-2 px-3 text-right font-mono text-sm" style="${heatColor(d.pe_fwd,10,60)}">${fmtPE(d.pe_fwd)}</td>
        <td class="py-2 px-3 text-right">${fmtPeg(d.peg)}</td>
        <td class="py-2 px-3 text-right font-mono text-sm">${fmtGrowth(d.eps_growth_ttm)}</td>
        <td class="py-2 px-3 text-right font-mono text-sm">${fmtGrowth(d.eps_growth_q)}</td>
        <td class="py-2 px-3 text-right">${fmtPct(d.upside)}</td>
        <td class="py-2 px-3 text-right font-mono text-sm">${d.ev_ebitda != null ? d.ev_ebitda.toFixed(1)+'x' : '<span class="text-slate-600">-</span>'}</td>
        <td class="py-2 px-3 text-right font-mono text-xs text-slate-400">${fmtCap(d.market_cap)}</td>
      </tr>`;
    }).join('')
    : `<tr><td colspan="10" class="py-8 text-center text-slate-600 text-sm">${I18n.t('index.no_results')}</td></tr>`;
  }

  // ── ETF render
  function renderEtf() {
    const rows = sortRows(etfRows, etfSortCol, etfSortDir);
    updateIcons('etfHeatmapTable', etfSortCol, etfSortDir);
    document.getElementById('etfHeatmapCount').textContent = `${rows.length} ETF${rows.length !== 1 ? 's' : ''}`;
    document.getElementById('etfHeatmapBody').innerHTML = rows.map(d => {
      const chgStyle = dayChgHeat(d.day_change_pct);
      const chgText  = d.day_change_pct != null ? (d.day_change_pct >= 0 ? '+' : '') + d.day_change_pct.toFixed(2) + '%' : '';
      const chgColor = d.day_change_pct == null ? '' : d.day_change_pct >= 0 ? 'color:rgb(52,211,153)' : 'color:rgb(244,63,94)';
      return `
      <tr class="border-b border-slate-800/60 hover:bg-slate-800/40 transition">
        <td class="py-2 px-3" style="${chgStyle}">
          <a href="/history/${d.ticker}" class="font-mono font-bold text-slate-100 hover:underline">${d.ticker}</a>
          <div class="text-slate-400 text-xs truncate max-w-[120px]">${I18n.stockName(d.ticker, d.name)}</div>
          <div class="text-[10px] font-semibold mt-0.5" style="${chgColor}">${chgText}</div>
        </td>
        <td class="py-2 px-3 text-xs text-slate-500">${I18n.tSector(d.sector)}</td>
        <td class="py-2 px-3 text-right font-mono text-sm" style="${heatColor(d.pe_ttm,10,60)}">${fmtPE(d.pe_ttm)}</td>
      </tr>`;
    }).join('');
  }

  // ── Bind stock controls
  document.querySelectorAll('#heatmapTable th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      if (sortCol === th.dataset.col) sortDir *= -1;
      else { sortCol = th.dataset.col; sortDir = ['ticker','name','sector'].includes(th.dataset.col) ? 1 : -1; }
      render();
    });
  });
  document.getElementById('sectorFilter').addEventListener('change', e => { filterSector = e.target.value; render(); });
  document.getElementById('heatmapSearch').addEventListener('input', e => { filterText = e.target.value; render(); });

  // ── Bind ETF controls
  document.querySelectorAll('#etfHeatmapTable th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      if (etfSortCol === th.dataset.col) etfSortDir *= -1;
      else { etfSortCol = th.dataset.col; etfSortDir = ['ticker','name','sector'].includes(th.dataset.col) ? 1 : -1; }
      renderEtf();
    });
  });

  render();
  renderEtf();

  // ── Day Chg sort buttons
  window.heatmapSortByDayChg = function() {
    if (sortCol === 'day_change_pct') sortDir *= -1;
    else { sortCol = 'day_change_pct'; sortDir = -1; }
    document.getElementById('heatmapDayChgArrow').textContent = sortDir === -1 ? '↓' : '↑';
    document.getElementById('heatmapDayChgSort').classList.toggle('text-brand', true);
    document.getElementById('heatmapDayChgSort').classList.toggle('border-brand/40', true);
    render();
  };

  window.etfSortByDayChg = function() {
    if (etfSortCol === 'day_change_pct') etfSortDir *= -1;
    else { etfSortCol = 'day_change_pct'; etfSortDir = -1; }
    document.getElementById('etfDayChgArrow').textContent = etfSortDir === -1 ? '↓' : '↑';
    document.getElementById('etfDayChgSort').classList.toggle('text-brand', true);
    document.getElementById('etfDayChgSort').classList.toggle('border-brand/40', true);
    renderEtf();
  };
})();
</script>
{% endblock %}
