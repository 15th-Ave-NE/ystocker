{% extends "base.html" %}
{% block title %}yStocker — Fed Balance Sheet (H.4.1){% endblock %}

{% block content %}
<style>
.range-btn {
  padding: 3px 9px;
  border-radius: 6px;
  border: 1px solid #334155;
  background: transparent;
  color: #64748b;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  letter-spacing: 0.02em;
}
.range-btn:hover {
  color: #cbd5e1;
  border-color: #64748b;
}
.range-btn.active {
  color: #a5b4fc;
  border-color: #6366f1;
  background: rgba(99,102,241,0.12);
}
</style>

<!-- ── Header ─────────────────────────────────────────────────────────── -->
<div class="mb-6 sm:mb-8 fade-up">
  <h1 class="text-2xl sm:text-3xl font-bold grad-text mb-1" data-i18n="fed.title">Fed Balance Sheet (H.4.1)</h1>
  <p class="text-slate-400 text-sm" data-i18n="fed.subtitle">
    Federal Reserve weekly balance-sheet data · U.S. Treasury &amp; MBS holdings, total assets, reserve balances
  </p>
  {% if cache_last_updated %}
  <p class="text-xs text-slate-600 mt-1">
    <span data-i18n="fed.data_as_of">Data as of</span> {{ cache_last_updated | int | datetimeformat }}
    &nbsp;·&nbsp;
    {% if warming %}
    <span class="text-brand animate-pulse" data-i18n="fed.refreshing">refreshing now…</span>
    {% else %}
    <span data-i18n="fed.next_refresh">next refresh</span> {{ (cache_last_updated | int + 86400) | datetimeformat }}
    {% endif %}
    &nbsp;·&nbsp;
    <a href="{{ url_for('main.fed_refresh') }}" class="text-brand hover:underline" data-i18n="fed.refresh">↻ Refresh</a>
  </p>
  {% else %}
  <p class="text-xs text-slate-600 mt-1">
    <a href="{{ url_for('main.fed_refresh') }}" class="text-brand hover:underline" data-i18n="fed.load">↻ Load data</a>
  </p>
  {% endif %}
</div>

<!-- ── Stat cards (filled by JS) ─────────────────────────────────────── -->
{% if not cache_last_updated and warming %}
<div id="fedLoadingPanel" class="flex flex-col items-center justify-center py-24 gap-4 fade-up">
  <svg class="w-8 h-8 text-brand animate-spin" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
  </svg>
  <p class="text-slate-400 text-sm animate-pulse" data-i18n="fed.loading">Fetching data from Federal Reserve — this may take a moment…</p>
  <p class="text-xs text-slate-600" data-i18n="fed.loading_hint">This page will refresh automatically when data is ready.</p>
</div>
<script>
  // Poll until data is ready, then reload the page
  (function poll() {
    fetch('/api/fed').then(r => r.json()).then(d => {
      const series = d.series || {};
      const hasData = Object.values(series).some(s => s.values && s.values.some(v => v != null));
      if (hasData) { location.reload(); }
      else { setTimeout(poll, 3000); }
    }).catch(() => setTimeout(poll, 5000));
  })();
</script>
{% else %}
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4 mb-6 sm:mb-8 fade-up" id="statCards">
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="fed.stat_total">Total Assets</div>
    <div id="statTotal" class="text-xl font-bold text-slate-100">—</div>
    <div id="statTotalChg" class="text-xs mt-0.5 text-slate-500">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_treasury">Treasury Securities
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_treasury">ⓘ</span>
    </div>
    <div id="statTreasury" class="text-xl font-bold text-slate-100">—</div>
    <div id="statTreasuryChg" class="text-xs mt-0.5 text-slate-500">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_bills">Bills (Short-Term)
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_bills">ⓘ</span>
    </div>
    <div id="statBills" class="text-xl font-bold text-slate-100">—</div>
    <div id="statBillsChg" class="text-xs mt-0.5 text-slate-500">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_mbs">MBS Holdings
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_mbs">ⓘ</span>
    </div>
    <div id="statMbs" class="text-xl font-bold text-slate-100">—</div>
    <div id="statMbsChg" class="text-xs mt-0.5 text-slate-500">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_reserves">Reserve Balances
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_reserves">ⓘ</span>
    </div>
    <div id="statReserves" class="text-xl font-bold text-slate-100">—</div>
    <div id="statReservesChg" class="text-xs mt-0.5 text-slate-500">—</div>
  </div>
</div>

<!-- ── Charts ────────────────────────────────────────────────────────── -->
<div class="space-y-6" id="chartsArea">

  <!-- Treasury Securities + Bills (nested sub-section) -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.treasury_title">U.S. Treasury Securities Held Outright</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.treasury_desc">Weekly, $ billions — Federal Reserve balance sheet</p>
      </div>
      <div id="treasuryRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn active" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
      </div>
    </div>
    <div id="treasuryLoading" class="flex items-center justify-center h-48 text-slate-500 text-sm animate-pulse" data-i18n="fed.loading_chart">
      Loading Treasury data…
    </div>
    <div class="chart-container" style="height:260px; display:none" id="treasuryChartWrap">
      <canvas id="treasuryChart"></canvas>
    </div>
    <!-- Week-over-week change bar -->
    <div id="treasuryWowWrap" class="mt-3 hidden">
      <p class="text-xs text-slate-500 mb-2" data-i18n="fed.wow_title">Week-over-Week Change ($B)</p>
      <div class="chart-container" style="height:80px">
        <canvas id="treasuryWowChart"></canvas>
      </div>
    </div>

    <!-- Bills (Short-Term) — nested under Treasury -->
    <div class="mt-6 pt-5 border-t border-slate-800/60">
      <div class="flex flex-wrap items-start justify-between gap-2 mb-3">
        <div>
          <h3 class="text-sm font-semibold text-slate-300" data-i18n="fed.bills_title">↳ Treasury Bills (T-Bills, ≤1Y)</h3>
          <p class="text-xs text-slate-500" data-i18n="fed.bills_desc">Short-term T-bills maturing within 1 year — a subset of the Treasury holdings above</p>
        </div>
        <div id="billsRangeSelector" class="flex flex-wrap gap-1 text-xs">
          <button class="range-btn" data-range="52">1Y</button>
          <button class="range-btn" data-range="104">2Y</button>
          <button class="range-btn active" data-range="156">3Y</button>
          <button class="range-btn" data-range="260">5Y</button>
          <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
        </div>
      </div>
      <div id="billsLoading" class="flex items-center justify-center h-32 text-slate-500 text-sm animate-pulse" data-i18n="fed.bills_loading">
        Loading Bills data…
      </div>
      <div class="chart-container" style="height:180px; display:none" id="billsChartWrap">
        <canvas id="billsChart"></canvas>
      </div>
      <!-- WoW bar -->
      <div id="billsWowWrap" class="mt-3 hidden">
        <p class="text-xs text-slate-500 mb-2" data-i18n="fed.wow_title">Week-over-Week Change ($B)</p>
        <div class="chart-container" style="height:70px">
          <canvas id="billsWowChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Assets + MBS combo -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.balance_title">Balance Sheet Overview</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.balance_desc">Total assets, MBS, and reserve balances ($B) — weekly</p>
      </div>
      <div id="balanceRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn active" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
      </div>
    </div>
    <div id="balanceLoading" class="flex items-center justify-center h-48 text-slate-500 text-sm animate-pulse" data-i18n="fed.loading_chart">
      Loading balance-sheet data…
    </div>
    <div class="chart-container" style="height:260px; display:none" id="balanceChartWrap">
      <canvas id="balanceChart"></canvas>
    </div>
  </div>

  <!-- Treasury as % of Total Assets -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.pct_title">Treasury as % of Total Assets</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.pct_desc">How much of the Fed's balance sheet is US Treasuries — higher = more concentrated in government debt</p>
      </div>
      <div id="pctRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn active" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
      </div>
    </div>
    <div class="chart-container" style="height:200px; display:none" id="pctChartWrap">
      <canvas id="pctChart"></canvas>
    </div>
  </div>

</div>

<!-- Error display -->
<div id="fedError" class="hidden mt-4 px-4 py-3 rounded-lg bg-red-900/40 border border-red-700 text-red-300 text-sm"></div>

<!-- Source note -->
<div class="mt-6 text-xs text-slate-600 fade-up">
  <span data-i18n="fed.source_note">Data source:</span>
  <a href="https://www.federalreserve.gov/releases/h41/" target="_blank" rel="noopener"
     class="text-brand hover:underline ml-1">Federal Reserve H.4.1 Statistical Release</a>
  &nbsp;·&nbsp; <span data-i18n="fed.updated_weekly">Updated weekly (Thursdays)</span>
</div>
{% endif %}

<script>
(async function() {
  const gridCol = '#1e293b';
  const tickCol = '#64748b';

  // ── fetch data
  let data;
  try {
    const resp = await fetch('/api/fed');
    data = await resp.json();
    if (!resp.ok) {
      document.getElementById('fedError').textContent = '⚠ ' + (data.error || 'Failed to load data.');
      document.getElementById('fedError').classList.remove('hidden');
      return;
    }
  } catch(e) {
    document.getElementById('fedError').textContent = '⚠ Network error: ' + e;
    document.getElementById('fedError').classList.remove('hidden');
    return;
  }

  const s = data.series || {};

  function lastVal(sid) {
    const d = s[sid];
    if (!d || !d.values) return null;
    return d.values.filter(v => v != null).at(-1) ?? null;
  }
  function prevVal(sid) {
    const d = s[sid];
    if (!d || !d.values) return null;
    const valid = d.values.filter(v => v != null);
    return valid.at(-2) ?? null;
  }

  function fmtB(v) {
    if (v == null) return '—';
    if (Math.abs(v) >= 1000) return '$' + (v / 1000).toFixed(2) + 'T';
    return '$' + v.toFixed(1) + 'B';
  }
  function fmtChg(now, prev) {
    if (now == null || prev == null) return '';
    const chg = now - prev;
    const sign = chg >= 0 ? '+' : '';
    return sign + chg.toFixed(1) + 'B WoW';
  }
  function chgClass(now, prev) {
    if (now == null || prev == null) return 'text-slate-500';
    return now >= prev ? 'text-emerald-400' : 'text-rose-400';
  }

  // ── fill stat cards
  [
    ['WALCL',   'statTotal',    'statTotalChg'],
    ['TREAST',  'statTreasury', 'statTreasuryChg'],
    ['WSHOSHO', 'statBills',    'statBillsChg'],
    ['MBST',    'statMbs',      'statMbsChg'],
    ['WRESBAL', 'statReserves', 'statReservesChg'],
  ].forEach(([sid, valId, chgId]) => {
    const v = lastVal(sid);
    const p = prevVal(sid);
    const valEl = document.getElementById(valId);
    const chgEl = document.getElementById(chgId);
    if (valEl) valEl.textContent = fmtB(v);
    if (chgEl) {
      chgEl.textContent = fmtChg(v, p);
      chgEl.className   = 'text-xs mt-0.5 ' + chgClass(v, p);
    }
  });

  // ── helper: slice series to last N weeks (0 = all)
  function sliceSeries(sid, n) {
    const d = s[sid];
    if (!d) return {dates:[], values:[]};
    const {dates, values} = d;
    if (n <= 0 || n >= dates.length) return {dates, values};
    return {dates: dates.slice(-n), values: values.slice(-n)};
  }

  // ──────────────────────────────────────────────────────────────────────────
  // Treasury chart (with range selector + WoW bar)
  // ──────────────────────────────────────────────────────────────────────────
  document.getElementById('treasuryLoading').style.display = 'none';
  document.getElementById('treasuryChartWrap').style.display = 'block';
  document.getElementById('treasuryWowWrap').classList.remove('hidden');

  const TREASURY_COLORS = {
    border: '#38bdf8',
    fill:   'rgba(56,189,248,0.07)',
  };

  let currentRange = 156; // default 3Y

  // WoW chart data (last 52 weeks always)
  function wowData(n) {
    const {values} = sliceSeries('TREAST', n || 0);
    const wowVals = values.map((v, i) => {
      if (i === 0 || v == null || values[i-1] == null) return null;
      return +(v - values[i-1]).toFixed(2);
    });
    return wowVals;
  }

  const tCtx = document.getElementById('treasuryChart');
  const treasuryChart = new Chart(tCtx, {
    type: 'line',
    data: {
      labels: sliceSeries('TREAST', currentRange).dates,
      datasets: [{
        label: I18n.t('fed.chart_treasuries') || 'Treasuries ($B)',
        data:  sliceSeries('TREAST', currentRange).values,
        borderColor: TREASURY_COLORS.border,
        backgroundColor: TREASURY_COLORS.fill,
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 5,
        fill: true,
        tension: 0.3,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: {
            label: c => {
              const v = c.raw;
              if (v == null) return '';
              return ` $${(v >= 1000 ? (v/1000).toFixed(2)+'T' : v.toFixed(1)+'B')}`;
            }
          }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: {
          grid:{color:gridCol},
          ticks:{
            color:tickCol,
            callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'
          }
        }
      },
      interaction: { mode:'index', intersect:false },
    }
  });

  // WoW bar chart
  const wCtx = document.getElementById('treasuryWowChart');
  const {dates: wowDates, values: wowValsInit} = sliceSeries('TREAST', currentRange);
  const wowBars = wowValsInit.map((v, i) => {
    if (i === 0 || v == null || wowValsInit[i-1] == null) return null;
    return +(v - wowValsInit[i-1]).toFixed(2);
  });
  const wowChart = new Chart(wCtx, {
    type: 'bar',
    data: {
      labels: wowDates,
      datasets: [{
        label: I18n.t('fed.chart_wow') || 'WoW Change ($B)',
        data: wowBars,
        backgroundColor: wowBars.map(v => v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'),
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: {display: false}, tooltip: {
        mode:'index', intersect:false,
        callbacks: { label: c => ` ${c.raw >= 0 ? '+' : ''}${c.raw?.toFixed(1)}B` }
      }},
      scales: {
        x: { display: false },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'B'} }
      },
      interaction: { mode:'index', intersect:false },
    }
  });

  // Range selector buttons
  function wireRangeSelector(selectorId, onRange) {
    document.querySelectorAll(`#${selectorId} .range-btn`).forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll(`#${selectorId} .range-btn`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        onRange(+btn.dataset.range);
      });
    });
  }

  wireRangeSelector('treasuryRangeSelector', n => {
    currentRange = n;
    const {dates, values} = sliceSeries('TREAST', n);
    treasuryChart.data.labels = dates;
    treasuryChart.data.datasets[0].data = values;
    treasuryChart.update();

    const newWow = values.map((v, i) => {
      if (i === 0 || v == null || values[i-1] == null) return null;
      return +(v - values[i-1]).toFixed(2);
    });
    wowChart.data.labels = dates;
    wowChart.data.datasets[0].data = newWow;
    wowChart.data.datasets[0].backgroundColor = newWow.map(v =>
      v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'
    );
    wowChart.update();
  });

  // ──────────────────────────────────────────────────────────────────────────
  // Bills (Short-Term Treasury) chart
  // ──────────────────────────────────────────────────────────────────────────
  if (s['WSHOSHO'] && s['WSHOSHO'].dates.length) {
    document.getElementById('billsLoading').style.display = 'none';
    document.getElementById('billsChartWrap').style.display = 'block';
    document.getElementById('billsWowWrap').classList.remove('hidden');

    let billsRange = 156;

    const bllCtx = document.getElementById('billsChart');
    const billsChart = new Chart(bllCtx, {
      type: 'line',
      data: {
        labels: sliceSeries('WSHOSHO', billsRange).dates,
        datasets: [{
          label: I18n.t('fed.chart_bills') || 'Bills ($B)',
          data:  sliceSeries('WSHOSHO', billsRange).values,
          borderColor: '#818cf8',
          backgroundColor: 'rgba(129,140,248,0.07)',
          borderWidth: 2,
          pointRadius: 0, pointHoverRadius: 5, fill: true, tension: 0.3, spanGaps: true,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: { label: c => { const v = c.raw; if (v == null) return ''; return ` $${v >= 1000 ? (v/1000).toFixed(2)+'T' : v.toFixed(1)+'B'}`; } }
          }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'} }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    const {dates: bllWowDates, values: bllWowVals} = sliceSeries('WSHOSHO', billsRange);
    const bllWowBars = bllWowVals.map((v, i) => {
      if (i === 0 || v == null || bllWowVals[i-1] == null) return null;
      return +(v - bllWowVals[i-1]).toFixed(2);
    });
    const bllWowChart = new Chart(document.getElementById('billsWowChart'), {
      type: 'bar',
      data: {
        labels: bllWowDates,
        datasets: [{
          label: I18n.t('fed.chart_wow') || 'WoW Change ($B)',
          data: bllWowBars,
          backgroundColor: bllWowBars.map(v => v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'),
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: {display:false}, tooltip: {
          mode:'index', intersect:false,
          callbacks: { label: c => ` ${c.raw >= 0 ? '+' : ''}${c.raw?.toFixed(1)}B` }
        }},
        scales: {
          x: { display: false },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'B'} }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    wireRangeSelector('billsRangeSelector', n => {
      billsRange = n;
      const {dates, values} = sliceSeries('WSHOSHO', n);
      billsChart.data.labels = dates;
      billsChart.data.datasets[0].data = values;
      billsChart.update();
      const newWow = values.map((v, i) => {
        if (i === 0 || v == null || values[i-1] == null) return null;
        return +(v - values[i-1]).toFixed(2);
      });
      bllWowChart.data.labels = dates;
      bllWowChart.data.datasets[0].data = newWow;
      bllWowChart.data.datasets[0].backgroundColor = newWow.map(v =>
        v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'
      );
      bllWowChart.update();
    });
  }

  // ──────────────────────────────────────────────────────────────────────────
  // Balance-sheet overview chart (total assets + MBS + reserves)
  // ──────────────────────────────────────────────────────────────────────────
  document.getElementById('balanceLoading').style.display = 'none';
  document.getElementById('balanceChartWrap').style.display = 'block';

  const bCtx = document.getElementById('balanceChart');
  let BALANCE_N = 156; // 3Y default

  function buildBalanceData(n) {
    return {
      walcl: sliceSeries('WALCL',   n),
      mbs:   sliceSeries('MBST',    n),
      res:   sliceSeries('WRESBAL', n),
    };
  }

  let bd = buildBalanceData(BALANCE_N);
  const balanceChart = new Chart(bCtx, {
    type: 'line',
    data: {
      labels: bd.walcl.dates,
      datasets: [
        {
          label: I18n.t('fed.stat_total') || 'Total Assets',
          data: bd.walcl.values,
          borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.05)',
          borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3, spanGaps: true,
        },
        {
          label: I18n.t('fed.stat_mbs') || 'MBS',
          data: bd.mbs.values,
          borderColor: '#34d399', backgroundColor: 'transparent',
          borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.3, spanGaps: true,
          borderDash: [4, 3],
        },
        {
          label: I18n.t('fed.stat_reserves') || 'Reserve Balances',
          data: bd.res.values,
          borderColor: '#f59e0b', backgroundColor: 'transparent',
          borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.3, spanGaps: true,
          borderDash: [4, 3],
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { color: '#94a3b8', boxWidth: 12, font: {size: 11} } },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: {
            label: c => {
              const v = c.raw;
              if (v == null) return '';
              const fmt = v >= 1000 ? '$'+(v/1000).toFixed(2)+'T' : '$'+v.toFixed(1)+'B';
              return ` ${c.dataset.label}: ${fmt}`;
            }
          }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'} }
      },
      interaction: { mode:'index', intersect:false },
    }
  });

  wireRangeSelector('balanceRangeSelector', n => {
    const d = buildBalanceData(n);
    balanceChart.data.labels = d.walcl.dates;
    balanceChart.data.datasets[0].data = d.walcl.values;
    balanceChart.data.datasets[1].data = d.mbs.values;
    balanceChart.data.datasets[2].data = d.res.values;
    balanceChart.update();
  });

  // ──────────────────────────────────────────────────────────────────────────
  // Treasury as % of total assets
  // ──────────────────────────────────────────────────────────────────────────
  function buildPctData(n) {
    const w = sliceSeries('WALCL',  n);
    const t = sliceSeries('TREAST', n);
    return {
      dates: w.dates,
      values: w.values.map((total, i) => {
        const treas = t.values[i];
        if (total == null || treas == null || total === 0) return null;
        return +(treas / total * 100).toFixed(2);
      }),
    };
  }

  const pctInitial = buildPctData(156);
  if (pctInitial.values.some(v => v != null)) {
    document.getElementById('pctChartWrap').style.display = 'block';
    const pCtx = document.getElementById('pctChart');
    const pctChart = new Chart(pCtx, {
      type: 'line',
      data: {
        labels: pctInitial.dates,
        datasets: [{
          label: I18n.t('fed.pct_title') || 'Treasury % of Total Assets',
          data: pctInitial.values,
          borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.07)',
          borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3, spanGaps: true,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false, callbacks: { label: c => ` ${c.raw?.toFixed(1)}%` } }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{ color:tickCol, callback: v => v.toFixed(0)+'%' } }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    wireRangeSelector('pctRangeSelector', n => {
      const d = buildPctData(n);
      pctChart.data.labels = d.dates;
      pctChart.data.datasets[0].data = d.values;
      pctChart.update();
    });
  }
})();

// ── Stat card tooltips ────────────────────────────────────────────────────
(function() {
  const tip = document.createElement('div');
  tip.style.cssText = [
    'position:fixed','z-index:9999','max-width:280px','padding:8px 12px',
    'background:#0f172a','border:1px solid #334155','border-radius:8px',
    'color:#cbd5e1','font-size:12px','line-height:1.5','pointer-events:none',
    'opacity:0','transition:opacity 0.15s','box-shadow:0 4px 16px rgba(0,0,0,0.5)',
  ].join(';');
  document.body.appendChild(tip);
  let hide;
  document.querySelectorAll('.fed-tip').forEach(el => {
    el.addEventListener('mouseenter', function(e) {
      clearTimeout(hide);
      tip.textContent = I18n.t(this.dataset.i18nTip) || this.dataset.i18nTip;
      tip.style.opacity = '1';
      move(e);
    });
    el.addEventListener('mousemove', move);
    el.addEventListener('mouseleave', () => { hide = setTimeout(() => tip.style.opacity = '0', 100); });
  });
  function move(e) {
    const pad = 12, tw = tip.offsetWidth || 280, th = tip.offsetHeight || 60;
    let x = e.clientX + pad, y = e.clientY + pad;
    if (x + tw > window.innerWidth  - pad) x = e.clientX - tw - pad;
    if (y + th > window.innerHeight - pad) y = e.clientY - th - pad;
    tip.style.left = x + 'px'; tip.style.top = y + 'px';
  }
})();
</script>
{% endblock %}
