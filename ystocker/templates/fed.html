{% extends "base.html" %}
{% block title %}yStocker â€” Fed Balance Sheet (H.4.1){% endblock %}

{% block content %}
<style>
.range-btn {
  padding: 3px 9px;
  border-radius: 6px;
  border: 1px solid #334155;
  background: transparent;
  color: #64748b;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  letter-spacing: 0.02em;
}
.range-btn:hover {
  color: #cbd5e1;
  border-color: #64748b;
}
.range-btn.active {
  color: #a5b4fc;
  border-color: #6366f1;
  background: rgba(99,102,241,0.12);
}
.explain-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 6px;
  border: 1px solid #334155;
  background: transparent;
  color: #94a3b8;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  letter-spacing: 0.02em;
  white-space: nowrap;
}
.explain-btn:hover {
  color: #a78bfa;
  border-color: #7c3aed;
}
.explain-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.explain-panel {
  margin-top: 12px;
  padding: 14px 16px;
  border-radius: 10px;
  background: rgba(167,139,250,0.06);
  border: 1px solid rgba(167,139,250,0.2);
  color: #cbd5e1;
  font-size: 13px;
  line-height: 1.65;
  display: none;
}
.explain-panel.visible { display: block; }
.explain-thinking {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #a78bfa;
  font-size: 12px;
  font-style: italic;
}
.explain-thinking .dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: #a78bfa;
  animation: explainBounce 1.2s infinite ease-in-out;
}
.explain-thinking .dot:nth-child(2) { animation-delay: 0.2s; }
.explain-thinking .dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes explainBounce {
  0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
  40%           { transform: scale(1.0); opacity: 1.0; }
}
</style>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mb-6 sm:mb-8 fade-up">
  <h1 class="text-2xl sm:text-3xl font-bold grad-text mb-1" data-i18n="fed.title">Fed Balance Sheet (H.4.1)</h1>
  <p class="text-slate-400 text-sm" data-i18n="fed.subtitle">
    Federal Reserve weekly balance-sheet data Â· assets, liabilities, reserve balances, reverse repos &amp; more
  </p>
  {% if cache_last_updated %}
  <p class="text-xs text-slate-600 mt-1">
    <span data-i18n="fed.data_as_of">Data as of</span> {{ cache_last_updated | int | datetimeformat }}
    &nbsp;Â·&nbsp;
    {% if warming %}
    <span class="text-brand animate-pulse" data-i18n="fed.refreshing">refreshing nowâ€¦</span>
    {% else %}
    <span data-i18n="fed.next_refresh">next refresh</span> {{ (cache_last_updated | int + 86400) | datetimeformat }}
    {% endif %}
    &nbsp;Â·&nbsp;
    <a href="{{ url_for('main.fed_refresh') }}" class="text-brand hover:underline" data-i18n="fed.refresh">â†» Refresh</a>
  </p>
  {% else %}
  <p class="text-xs text-slate-600 mt-1">
    <a href="{{ url_for('main.fed_refresh') }}" class="text-brand hover:underline" data-i18n="fed.load">â†» Load data</a>
  </p>
  {% endif %}
</div>

<!-- â”€â”€ Stat cards (filled by JS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if not cache_last_updated and warming %}
<div id="fedLoadingPanel" class="flex flex-col items-center justify-center py-24 gap-4 fade-up">
  <svg class="w-8 h-8 text-brand animate-spin" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
  </svg>
  <p class="text-slate-400 text-sm animate-pulse" data-i18n="fed.loading">Fetching data from Federal Reserve â€” this may take a momentâ€¦</p>
  <p class="text-xs text-slate-600" data-i18n="fed.loading_hint">This page will refresh automatically when data is ready.</p>
</div>
<script>
  // Poll until data is ready, then reload the page
  (function poll() {
    fetch('/api/fed').then(r => r.json()).then(d => {
      const series = d.series || {};
      const hasData = Object.values(series).some(s => s.values && s.values.some(v => v != null));
      if (hasData) { location.reload(); }
      else { setTimeout(poll, 3000); }
    }).catch(() => setTimeout(poll, 5000));
  })();
</script>
{% else %}
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4 mb-4 sm:mb-5 fade-up" id="statCards">
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="fed.stat_total">Total Assets</div>
    <div id="statTotal" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statTotalChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_treasury">Treasury Securities
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_treasury">â“˜</span>
    </div>
    <div id="statTreasury" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statTreasuryChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_bills">Bills (Short-Term)
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_bills">â“˜</span>
    </div>
    <div id="statBills" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statBillsChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_mbs">MBS Holdings
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_mbs">â“˜</span>
    </div>
    <div id="statMbs" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statMbsChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_reserves">Reserve Balances
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_reserves">â“˜</span>
    </div>
    <div id="statReserves" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statReservesChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
</div>

<!-- Liabilities stat cards row -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-6 sm:mb-8 fade-up" id="statCardsLiab">
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_rrp">ON RRP
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_rrp">â“˜</span>
    </div>
    <div id="statRrp" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statRrpChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_tga">Treasury Gen. Account
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_tga">â“˜</span>
    </div>
    <div id="statTga" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statTgaChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_currency">Currency in Circulation
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_currency">â“˜</span>
    </div>
    <div id="statCurrency" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statCurrencyChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-4 py-3">
    <div class="text-xs text-slate-500 mb-1 flex items-center gap-1" data-i18n="fed.stat_loans">Fed Loans (incl. BTFP)
      <span class="fed-tip text-slate-600 cursor-help text-[10px]" data-i18n-tip="fed.tip_loans">â“˜</span>
    </div>
    <div id="statLoans" class="text-xl font-bold text-slate-100">â€”</div>
    <div id="statLoansChg" class="text-xs mt-0.5 text-slate-500">â€”</div>
  </div>
</div>

<!-- â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="space-y-6" id="chartsArea">

  <!-- Treasury Securities + Bills (nested sub-section) -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.treasury_title">U.S. Treasury Securities Held Outright</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.treasury_desc">Weekly, $ billions â€” Federal Reserve balance sheet</p>
      </div>
      <div id="treasuryRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn active" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
        <button class="explain-btn" onclick="explainChart('treasury')" data-i18n="fed.explain">âœ¦ Explain</button>
      </div>
    </div>
    <div id="treasuryLoading" class="flex items-center justify-center h-48 text-slate-500 text-sm animate-pulse" data-i18n="fed.loading_chart">
      Loading Treasury dataâ€¦
    </div>
    <div class="chart-container" style="height:260px; display:none" id="treasuryChartWrap">
      <canvas id="treasuryChart"></canvas>
    </div>
    <!-- Week-over-week change bar -->
    <div id="treasuryWowWrap" class="mt-3 hidden">
      <p class="text-xs text-slate-500 mb-2" data-i18n="fed.wow_title">Week-over-Week Change ($B)</p>
      <div class="chart-container" style="height:80px">
        <canvas id="treasuryWowChart"></canvas>
      </div>
    </div>
    <div id="treasuryExplainPanel" class="explain-panel"></div>

    <!-- Bills (Short-Term) â€” nested under Treasury -->
    <div class="mt-6 pt-5 border-t border-slate-800/60">
      <div class="flex flex-wrap items-start justify-between gap-2 mb-3">
        <div>
          <h3 class="text-sm font-semibold text-slate-300" data-i18n="fed.bills_title">â†³ Treasury Bills (T-Bills, â‰¤1Y)</h3>
          <p class="text-xs text-slate-500" data-i18n="fed.bills_desc">Short-term T-bills maturing within 1 year â€” a subset of the Treasury holdings above</p>
        </div>
        <div id="billsRangeSelector" class="flex flex-wrap gap-1 text-xs">
          <button class="range-btn active" data-range="52">1Y</button>
          <button class="range-btn" data-range="104">2Y</button>
          <button class="range-btn" data-range="156">3Y</button>
          <button class="range-btn" data-range="260">5Y</button>
          <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
          <button class="explain-btn" onclick="explainChart('bills')" data-i18n="fed.explain">âœ¦ Explain</button>
        </div>
      </div>
      <div id="billsLoading" class="flex items-center justify-center h-32 text-slate-500 text-sm animate-pulse" data-i18n="fed.bills_loading">
        Loading Bills dataâ€¦
      </div>
      <div class="chart-container" style="height:180px; display:none" id="billsChartWrap">
        <canvas id="billsChart"></canvas>
      </div>
      <!-- WoW bar -->
      <div id="billsWowWrap" class="mt-3 hidden">
        <p class="text-xs text-slate-500 mb-2" data-i18n="fed.wow_title">Week-over-Week Change ($B)</p>
        <div class="chart-container" style="height:70px">
          <canvas id="billsWowChart"></canvas>
        </div>
      </div>
      <div id="billsExplainPanel" class="explain-panel"></div>
    </div>
  </div>

  <!-- Total Assets + MBS combo -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.balance_title">Balance Sheet Overview</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.balance_desc">Total assets, MBS, and reserve balances ($B) â€” weekly</p>
      </div>
      <div id="balanceRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn active" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
        <button class="explain-btn" onclick="explainChart('balance')" data-i18n="fed.explain">âœ¦ Explain</button>
      </div>
    </div>
    <div id="balanceLoading" class="flex items-center justify-center h-48 text-slate-500 text-sm animate-pulse" data-i18n="fed.loading_chart">
      Loading balance-sheet dataâ€¦
    </div>
    <div class="chart-container" style="height:260px; display:none" id="balanceChartWrap">
      <canvas id="balanceChart"></canvas>
    </div>
    <div id="balanceExplainPanel" class="explain-panel"></div>
  </div>

  <!-- Treasury as % of Total Assets -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.pct_title">Treasury as % of Total Assets</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.pct_desc">How much of the Fed's balance sheet is US Treasuries â€” higher = more concentrated in government debt</p>
      </div>
      <div id="pctRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn active" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
        <button class="explain-btn" onclick="explainChart('pct')" data-i18n="fed.explain">âœ¦ Explain</button>
      </div>
    </div>
    <div class="chart-container" style="height:200px; display:none" id="pctChartWrap">
      <canvas id="pctChart"></canvas>
    </div>
    <div id="pctExplainPanel" class="explain-panel"></div>
  </div>

  <!-- Liabilities: ON RRP + TGA -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.liab_title">Fed Liabilities: ON RRP &amp; Treasury General Account</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.liab_desc">Key drains on reserve liquidity â€” overnight reverse repos (money-market parking) and Treasury's cash balance at the Fed</p>
      </div>
      <div id="liabRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn active" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
        <button class="explain-btn" onclick="explainChart('liab')" data-i18n="fed.explain">âœ¦ Explain</button>
      </div>
    </div>
    <div id="liabLoading" class="flex items-center justify-center h-48 text-slate-500 text-sm animate-pulse" data-i18n="fed.liab_loading">
      Loading liability dataâ€¦
    </div>
    <div class="chart-container" style="height:260px; display:none" id="liabChartWrap">
      <canvas id="liabChart"></canvas>
    </div>
    <div id="liabExplainPanel" class="explain-panel"></div>
  </div>

  <!-- Currency in Circulation + Fed Loans (BTFP) -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="fed.currloan_title">Currency in Circulation &amp; Fed Emergency Loans</h2>
        <p class="text-xs text-slate-500" data-i18n="fed.currloan_desc">Physical currency outstanding (largest Fed liability) alongside emergency lending â€” BTFP spike visible post-SVB 2023</p>
      </div>
      <div id="currLoanRangeSelector" class="flex flex-wrap gap-1 text-xs">
        <button class="range-btn active" data-range="52">1Y</button>
        <button class="range-btn" data-range="104">2Y</button>
        <button class="range-btn" data-range="156">3Y</button>
        <button class="range-btn" data-range="260">5Y</button>
        <button class="range-btn" data-range="0" data-i18n="fed.range_all">All</button>
        <button class="explain-btn" onclick="explainChart('currLoan')" data-i18n="fed.explain">âœ¦ Explain</button>
      </div>
    </div>
    <div id="currLoanLoading" class="flex items-center justify-center h-48 text-slate-500 text-sm animate-pulse" data-i18n="fed.currloan_loading">
      Loading currency &amp; loans dataâ€¦
    </div>
    <div class="chart-container" style="height:260px; display:none" id="currLoanChartWrap">
      <canvas id="currLoanChart"></canvas>
    </div>
    <div id="currLoanExplainPanel" class="explain-panel"></div>
  </div>

</div>

<!-- Error display -->
<div id="fedError" class="hidden mt-4 px-4 py-3 rounded-lg bg-red-900/40 border border-red-700 text-red-300 text-sm"></div>

<!-- Source note -->
<div class="mt-6 text-xs text-slate-600 fade-up">
  <span data-i18n="fed.source_note">Data source:</span>
  <a href="https://www.federalreserve.gov/releases/h41/" target="_blank" rel="noopener"
     class="text-brand hover:underline ml-1">Federal Reserve H.4.1 Statistical Release</a>
  &nbsp;Â·&nbsp; <span data-i18n="fed.updated_weekly">Updated weekly (Thursdays)</span>
</div>
{% endif %}

<script>
(async function() {
  const gridCol = '#1e293b';
  const tickCol = '#64748b';

  // â”€â”€ fetch data
  let data;
  try {
    const resp = await fetch('/api/fed');
    data = await resp.json();
    if (!resp.ok) {
      document.getElementById('fedError').textContent = 'âš  ' + (data.error || 'Failed to load data.');
      document.getElementById('fedError').classList.remove('hidden');
      return;
    }
  } catch(e) {
    document.getElementById('fedError').textContent = 'âš  Network error: ' + e;
    document.getElementById('fedError').classList.remove('hidden');
    return;
  }

  const s = data.series || {};

  function lastVal(sid) {
    const d = s[sid];
    if (!d || !d.values) return null;
    return d.values.filter(v => v != null).at(-1) ?? null;
  }
  function prevVal(sid) {
    const d = s[sid];
    if (!d || !d.values) return null;
    const valid = d.values.filter(v => v != null);
    return valid.at(-2) ?? null;
  }

  function fmtB(v) {
    if (v == null) return 'â€”';
    if (Math.abs(v) >= 1000) return '$' + (v / 1000).toFixed(2) + 'T';
    return '$' + v.toFixed(1) + 'B';
  }
  function fmtChg(now, prev) {
    if (now == null || prev == null) return '';
    const chg = now - prev;
    const sign = chg >= 0 ? '+' : '';
    return sign + chg.toFixed(1) + 'B WoW';
  }
  function chgClass(now, prev) {
    if (now == null || prev == null) return 'text-slate-500';
    return now >= prev ? 'text-emerald-400' : 'text-rose-400';
  }

  // â”€â”€ fill stat cards
  [
    ['WALCL',     'statTotal',    'statTotalChg'],
    ['TREAST',    'statTreasury', 'statTreasuryChg'],
    ['WSHOSHO',   'statBills',    'statBillsChg'],
    ['MBST',      'statMbs',      'statMbsChg'],
    ['WRESBAL',   'statReserves', 'statReservesChg'],
    ['RRPONTSYD', 'statRrp',      'statRrpChg'],
    ['WTREGEN',   'statTga',      'statTgaChg'],
    ['WCURCIR',   'statCurrency', 'statCurrencyChg'],
    ['WLCFLPCL',  'statLoans',    'statLoansChg'],
  ].forEach(([sid, valId, chgId]) => {
    const v = lastVal(sid);
    const p = prevVal(sid);
    const valEl = document.getElementById(valId);
    const chgEl = document.getElementById(chgId);
    if (valEl) valEl.textContent = fmtB(v);
    if (chgEl) {
      chgEl.textContent = fmtChg(v, p);
      chgEl.className   = 'text-xs mt-0.5 ' + chgClass(v, p);
    }
  });

  // â”€â”€ helper: slice series to last N weeks (0 = all)
  function sliceSeries(sid, n) {
    const d = s[sid];
    if (!d) return {dates:[], values:[]};
    const {dates, values} = d;
    if (n <= 0 || n >= dates.length) return {dates, values};
    return {dates: dates.slice(-n), values: values.slice(-n)};
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Treasury chart (with range selector + WoW bar)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('treasuryLoading').style.display = 'none';
  document.getElementById('treasuryChartWrap').style.display = 'block';
  document.getElementById('treasuryWowWrap').classList.remove('hidden');
  registerExplainData('treasury', sliceSeries('TREAST', 52).dates, sliceSeries('TREAST', 52).values, 'U.S. Treasury Securities Held Outright');

  const TREASURY_COLORS = {
    border: '#38bdf8',
    fill:   'rgba(56,189,248,0.07)',
  };

  let currentRange = 52; // default 1Y

  // WoW chart data (last 52 weeks always)
  function wowData(n) {
    const {values} = sliceSeries('TREAST', n || 0);
    const wowVals = values.map((v, i) => {
      if (i === 0 || v == null || values[i-1] == null) return null;
      return +(v - values[i-1]).toFixed(2);
    });
    return wowVals;
  }

  const tCtx = document.getElementById('treasuryChart');
  const treasuryChart = new Chart(tCtx, {
    type: 'line',
    data: {
      labels: sliceSeries('TREAST', currentRange).dates,
      datasets: [{
        label: I18n.t('fed.chart_treasuries') || 'Treasuries ($B)',
        data:  sliceSeries('TREAST', currentRange).values,
        borderColor: TREASURY_COLORS.border,
        backgroundColor: TREASURY_COLORS.fill,
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 5,
        fill: true,
        tension: 0.3,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: {
            label: c => {
              const v = c.raw;
              if (v == null) return '';
              return ` $${(v >= 1000 ? (v/1000).toFixed(2)+'T' : v.toFixed(1)+'B')}`;
            }
          }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: {
          grid:{color:gridCol},
          ticks:{
            color:tickCol,
            callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'
          }
        }
      },
      interaction: { mode:'index', intersect:false },
    }
  });

  // WoW bar chart
  const wCtx = document.getElementById('treasuryWowChart');
  const {dates: wowDates, values: wowValsInit} = sliceSeries('TREAST', currentRange);
  const wowBars = wowValsInit.map((v, i) => {
    if (i === 0 || v == null || wowValsInit[i-1] == null) return null;
    return +(v - wowValsInit[i-1]).toFixed(2);
  });
  const wowChart = new Chart(wCtx, {
    type: 'bar',
    data: {
      labels: wowDates,
      datasets: [{
        label: I18n.t('fed.chart_wow') || 'WoW Change ($B)',
        data: wowBars,
        backgroundColor: wowBars.map(v => v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'),
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: {display: false}, tooltip: {
        mode:'index', intersect:false,
        callbacks: { label: c => ` ${c.raw >= 0 ? '+' : ''}${c.raw?.toFixed(1)}B` }
      }},
      scales: {
        x: { display: false },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'B'} }
      },
      interaction: { mode:'index', intersect:false },
    }
  });

  // Range selector buttons
  function wireRangeSelector(selectorId, onRange) {
    document.querySelectorAll(`#${selectorId} .range-btn`).forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll(`#${selectorId} .range-btn`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        onRange(+btn.dataset.range);
      });
    });
  }

  wireRangeSelector('treasuryRangeSelector', n => {
    currentRange = n;
    const {dates, values} = sliceSeries('TREAST', n);
    treasuryChart.data.labels = dates;
    treasuryChart.data.datasets[0].data = values;
    treasuryChart.update();

    const newWow = values.map((v, i) => {
      if (i === 0 || v == null || values[i-1] == null) return null;
      return +(v - values[i-1]).toFixed(2);
    });
    wowChart.data.labels = dates;
    wowChart.data.datasets[0].data = newWow;
    wowChart.data.datasets[0].backgroundColor = newWow.map(v =>
      v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'
    );
    wowChart.update();
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Bills (Short-Term Treasury) chart
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (s['WSHOSHO'] && s['WSHOSHO'].dates.length) {
    document.getElementById('billsLoading').style.display = 'none';
    document.getElementById('billsChartWrap').style.display = 'block';
    document.getElementById('billsWowWrap').classList.remove('hidden');
    registerExplainData('bills', sliceSeries('WSHOSHO', 52).dates, sliceSeries('WSHOSHO', 52).values, 'Treasury Bills (Short-Term, â‰¤1Y) Held Outright');

    let billsRange = 52;

    const bllCtx = document.getElementById('billsChart');
    const billsChart = new Chart(bllCtx, {
      type: 'line',
      data: {
        labels: sliceSeries('WSHOSHO', billsRange).dates,
        datasets: [{
          label: I18n.t('fed.chart_bills') || 'Bills ($B)',
          data:  sliceSeries('WSHOSHO', billsRange).values,
          borderColor: '#818cf8',
          backgroundColor: 'rgba(129,140,248,0.07)',
          borderWidth: 2,
          pointRadius: 0, pointHoverRadius: 5, fill: true, tension: 0.3, spanGaps: true,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: { label: c => { const v = c.raw; if (v == null) return ''; return ` $${v >= 1000 ? (v/1000).toFixed(2)+'T' : v.toFixed(1)+'B'}`; } }
          }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'} }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    const {dates: bllWowDates, values: bllWowVals} = sliceSeries('WSHOSHO', billsRange);
    const bllWowBars = bllWowVals.map((v, i) => {
      if (i === 0 || v == null || bllWowVals[i-1] == null) return null;
      return +(v - bllWowVals[i-1]).toFixed(2);
    });
    const bllWowChart = new Chart(document.getElementById('billsWowChart'), {
      type: 'bar',
      data: {
        labels: bllWowDates,
        datasets: [{
          label: I18n.t('fed.chart_wow') || 'WoW Change ($B)',
          data: bllWowBars,
          backgroundColor: bllWowBars.map(v => v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'),
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: {display:false}, tooltip: {
          mode:'index', intersect:false,
          callbacks: { label: c => ` ${c.raw >= 0 ? '+' : ''}${c.raw?.toFixed(1)}B` }
        }},
        scales: {
          x: { display: false },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'B'} }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    wireRangeSelector('billsRangeSelector', n => {
      billsRange = n;
      const {dates, values} = sliceSeries('WSHOSHO', n);
      billsChart.data.labels = dates;
      billsChart.data.datasets[0].data = values;
      billsChart.update();
      const newWow = values.map((v, i) => {
        if (i === 0 || v == null || values[i-1] == null) return null;
        return +(v - values[i-1]).toFixed(2);
      });
      bllWowChart.data.labels = dates;
      bllWowChart.data.datasets[0].data = newWow;
      bllWowChart.data.datasets[0].backgroundColor = newWow.map(v =>
        v == null ? 'transparent' : v >= 0 ? 'rgba(52,211,153,0.6)' : 'rgba(244,63,94,0.6)'
      );
      bllWowChart.update();
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Balance-sheet overview chart (total assets + MBS + reserves)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('balanceLoading').style.display = 'none';
  document.getElementById('balanceChartWrap').style.display = 'block';

  const bCtx = document.getElementById('balanceChart');
  let BALANCE_N = 52; // 1Y default

  function buildBalanceData(n) {
    return {
      walcl: sliceSeries('WALCL',   n),
      mbs:   sliceSeries('MBST',    n),
      res:   sliceSeries('WRESBAL', n),
    };
  }

  let bd = buildBalanceData(BALANCE_N);
  // Register explain data: use Total Assets as the primary series for the overview
  registerExplainData('balance', bd.walcl.dates, bd.walcl.values, 'Fed Balance Sheet Overview (Total Assets, MBS, Reserve Balances)');
  const balanceChart = new Chart(bCtx, {
    type: 'line',
    data: {
      labels: bd.walcl.dates,
      datasets: [
        {
          label: I18n.t('fed.stat_total') || 'Total Assets',
          data: bd.walcl.values,
          borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.05)',
          borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3, spanGaps: true,
        },
        {
          label: I18n.t('fed.stat_mbs') || 'MBS',
          data: bd.mbs.values,
          borderColor: '#34d399', backgroundColor: 'transparent',
          borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.3, spanGaps: true,
          borderDash: [4, 3],
        },
        {
          label: I18n.t('fed.stat_reserves') || 'Reserve Balances',
          data: bd.res.values,
          borderColor: '#f59e0b', backgroundColor: 'transparent',
          borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.3, spanGaps: true,
          borderDash: [4, 3],
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { color: '#94a3b8', boxWidth: 12, font: {size: 11} } },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: {
            label: c => {
              const v = c.raw;
              if (v == null) return '';
              const fmt = v >= 1000 ? '$'+(v/1000).toFixed(2)+'T' : '$'+v.toFixed(1)+'B';
              return ` ${c.dataset.label}: ${fmt}`;
            }
          }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'} }
      },
      interaction: { mode:'index', intersect:false },
    }
  });

  wireRangeSelector('balanceRangeSelector', n => {
    const d = buildBalanceData(n);
    balanceChart.data.labels = d.walcl.dates;
    balanceChart.data.datasets[0].data = d.walcl.values;
    balanceChart.data.datasets[1].data = d.mbs.values;
    balanceChart.data.datasets[2].data = d.res.values;
    balanceChart.update();
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Treasury as % of total assets
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildPctData(n) {
    const w = sliceSeries('WALCL',  n);
    const t = sliceSeries('TREAST', n);
    return {
      dates: w.dates,
      values: w.values.map((total, i) => {
        const treas = t.values[i];
        if (total == null || treas == null || total === 0) return null;
        return +(treas / total * 100).toFixed(2);
      }),
    };
  }

  const pctInitial = buildPctData(52);
  if (pctInitial.values.some(v => v != null)) {
    registerExplainData('pct', pctInitial.dates, pctInitial.values, 'U.S. Treasuries as % of Total Fed Assets');
    document.getElementById('pctChartWrap').style.display = 'block';
    const pCtx = document.getElementById('pctChart');
    const pctChart = new Chart(pCtx, {
      type: 'line',
      data: {
        labels: pctInitial.dates,
        datasets: [{
          label: I18n.t('fed.pct_title') || 'Treasury % of Total Assets',
          data: pctInitial.values,
          borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.07)',
          borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3, spanGaps: true,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false, callbacks: { label: c => ` ${c.raw?.toFixed(1)}%` } }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{ color:tickCol, callback: v => v.toFixed(0)+'%' } }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    wireRangeSelector('pctRangeSelector', n => {
      const d = buildPctData(n);
      pctChart.data.labels = d.dates;
      pctChart.data.datasets[0].data = d.values;
      pctChart.update();
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Liabilities chart: ON RRP + Treasury General Account (TGA)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if ((s['RRPONTSYD'] && s['RRPONTSYD'].dates.length) || (s['WTREGEN'] && s['WTREGEN'].dates.length)) {
    document.getElementById('liabLoading').style.display = 'none';
    document.getElementById('liabChartWrap').style.display = 'block';

    function buildLiabData(n) {
      return {
        rrp: sliceSeries('RRPONTSYD', n),
        tga: sliceSeries('WTREGEN',   n),
      };
    }

    let LIAB_N = 52;
    let ld = buildLiabData(LIAB_N);

    // Use longer series for labels (TGA goes further back)
    const liabLabels = ld.tga.dates.length >= ld.rrp.dates.length ? ld.tga.dates : ld.rrp.dates;
    registerExplainData('liab', liabLabels, ld.tga.values, 'Fed Liabilities: ON RRP & Treasury General Account (TGA)');

    const liabChart = new Chart(document.getElementById('liabChart'), {
      type: 'line',
      data: {
        labels: liabLabels,
        datasets: [
          {
            label: 'ON RRP ($B)',
            data: ld.rrp.values,
            borderColor: '#fb7185', backgroundColor: 'rgba(251,113,133,0.07)',
            borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3, spanGaps: true,
          },
          {
            label: 'TGA ($B)',
            data: ld.tga.values,
            borderColor: '#facc15', backgroundColor: 'transparent',
            borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.3, spanGaps: true,
            borderDash: [4, 3],
          },
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#94a3b8', boxWidth: 12, font: {size: 11} } },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: {
              label: c => {
                const v = c.raw;
                if (v == null) return '';
                const fmt = v >= 1000 ? '$'+(v/1000).toFixed(2)+'T' : '$'+v.toFixed(1)+'B';
                return ` ${c.dataset.label.replace(' ($B)', '')}: ${fmt}`;
              }
            }
          }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'} }
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    wireRangeSelector('liabRangeSelector', n => {
      const d = buildLiabData(n);
      const labels = d.tga.dates.length >= d.rrp.dates.length ? d.tga.dates : d.rrp.dates;
      liabChart.data.labels = labels;
      liabChart.data.datasets[0].data = d.rrp.values;
      liabChart.data.datasets[1].data = d.tga.values;
      liabChart.update();
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Currency in Circulation + Fed Loans (BTFP)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if ((s['WCURCIR'] && s['WCURCIR'].dates.length) || (s['WLCFLPCL'] && s['WLCFLPCL'].dates.length)) {
    document.getElementById('currLoanLoading').style.display = 'none';
    document.getElementById('currLoanChartWrap').style.display = 'block';

    function buildCurrLoanData(n) {
      return {
        cur:  sliceSeries('WCURCIR',  n),
        loan: sliceSeries('WLCFLPCL', n),
      };
    }

    let CL_N = 52;
    let cld = buildCurrLoanData(CL_N);
    registerExplainData('currLoan', cld.cur.dates, cld.cur.values, 'Currency in Circulation & Fed Emergency Loans (incl. BTFP)');

    const currLoanChart = new Chart(document.getElementById('currLoanChart'), {
      type: 'line',
      data: {
        labels: cld.cur.dates,
        datasets: [
          {
            label: 'Currency in Circulation ($B)',
            data: cld.cur.values,
            borderColor: '#94a3b8', backgroundColor: 'rgba(148,163,184,0.06)',
            borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3, spanGaps: true,
            yAxisID: 'yCur',
          },
          {
            label: 'Fed Loans incl. BTFP ($B)',
            data: cld.loan.values,
            borderColor: '#f97316', backgroundColor: 'transparent',
            borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.3, spanGaps: true,
            yAxisID: 'yLoan',
          },
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#94a3b8', boxWidth: 12, font: {size: 11} } },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: {
              label: c => {
                const v = c.raw;
                if (v == null) return '';
                const fmt = v >= 1000 ? '$'+(v/1000).toFixed(2)+'T' : '$'+v.toFixed(1)+'B';
                return ` ${c.dataset.label.replace(' ($B)', '')}: ${fmt}`;
              }
            }
          }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          yCur: {
            type: 'linear', position: 'left',
            grid:{color:gridCol}, ticks:{color:'#94a3b8', callback: v => v >= 1000 ? '$'+(v/1000).toFixed(1)+'T' : '$'+v+'B'}
          },
          yLoan: {
            type: 'linear', position: 'right',
            grid:{drawOnChartArea:false}, ticks:{color:'#f97316', callback: v => '$'+v+'B'}
          },
        },
        interaction: { mode:'index', intersect:false },
      }
    });

    wireRangeSelector('currLoanRangeSelector', n => {
      const d = buildCurrLoanData(n);
      currLoanChart.data.labels = d.cur.dates;
      currLoanChart.data.datasets[0].data = d.cur.values;
      currLoanChart.data.datasets[1].data = d.loan.values;
      currLoanChart.update();
    });
  }

})();

// â”€â”€ AI Explain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _explainData = {};  // populated by main IIFE via registerExplainData()

function registerExplainData(chart, dates, values, label) {
  _explainData[chart] = { dates, values, label };
}

function _explainDone(btn) {
  if (!btn) return;
  btn.disabled = false;
  btn.textContent = btn.dataset.origText || (I18n.t('fed.explain') || 'âœ¦ Explain');
}

function _runExplain(chart, lang) {
  const panel = document.getElementById(chart + 'ExplainPanel');
  const btn   = document.querySelector(`button.explain-btn[onclick="explainChart('${chart}')"]`);
  const d = _explainData[chart];
  if (!panel || !d || !d.dates.length) return;

  panel.classList.add('visible');
  panel.innerHTML = '';

  // Thinking indicator
  const thinking = document.createElement('span');
  thinking.className = 'explain-thinking';
  thinking.innerHTML = `<span>${lang === 'zh' ? 'AI åˆ†æä¸­' : 'Thinking'}</span>`
    + `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
  panel.appendChild(thinking);

  if (btn) {
    btn.disabled = true;
    btn.dataset.origText = btn.dataset.origText || btn.textContent;
    btn.textContent = lang === 'zh' ? 'â³ åˆ†æä¸­â€¦' : 'â³ Thinkingâ€¦';
  }

  fetch('/api/fed/explain', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chart, dates: d.dates, values: d.values, label: d.label, lang }),
  }).then(resp => {
    if (!resp.ok) return resp.json().then(e => { throw new Error(e.error || resp.statusText); });
    let firstChunk = true;
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';
    const textNode = document.createTextNode('');
    function pump() {
      reader.read().then(({ done, value }) => {
        if (done) { _explainFinish(panel, chart, lang, btn); return; }
        buf += decoder.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const payload = line.slice(6).trim();
          if (payload === '[DONE]') { _explainFinish(panel, chart, lang, btn); return; }
          try {
            const obj = JSON.parse(payload);
            if (obj.error) { panel.textContent = 'âš  ' + obj.error; _explainDone(btn); return; }
            if (obj.text) {
              if (firstChunk) { panel.innerHTML = ''; panel.appendChild(textNode); firstChunk = false; }
              textNode.textContent += obj.text;
            }
          } catch {}
        }
        pump();
      });
    }
    pump();
  }).catch(err => {
    panel.textContent = 'âš  ' + err.message;
    _explainDone(btn);
  });
}

function _explainFinish(panel, chart, lang, btn) {
  _explainDone(btn);
  // Add a small translate toggle button at the bottom of the panel
  const otherLang = lang === 'zh' ? 'en' : 'zh';
  const label = lang === 'zh' ? 'ğŸŒ View in English' : 'ğŸŒ ç¿»è¯‘æˆä¸­æ–‡';
  const translateBtn = document.createElement('button');
  translateBtn.textContent = label;
  translateBtn.className = 'mt-3 block text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 cursor-pointer bg-transparent border-0 p-0';
  translateBtn.onclick = () => _runExplain(chart, otherLang);
  panel.appendChild(document.createElement('br'));
  panel.appendChild(translateBtn);
}

function explainChart(chart) {
  const panel = document.getElementById(chart + 'ExplainPanel');
  const btn   = document.querySelector(`button.explain-btn[onclick="explainChart('${chart}')"]`);
  if (!panel) return;

  // Toggle off if already showing
  if (panel.classList.contains('visible') && !btn?.disabled) {
    panel.classList.remove('visible');
    return;
  }

  const d = _explainData[chart];
  if (!d || !d.dates.length) {
    panel.textContent = 'No data available to explain.';
    panel.classList.add('visible');
    return;
  }

  _runExplain(chart, I18n.getLang());
}

// â”€â”€ Stat card tooltips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const tip = document.createElement('div');
  tip.style.cssText = [
    'position:fixed','z-index:9999','max-width:280px','padding:8px 12px',
    'background:#0f172a','border:1px solid #334155','border-radius:8px',
    'color:#cbd5e1','font-size:12px','line-height:1.5','pointer-events:none',
    'opacity:0','transition:opacity 0.15s','box-shadow:0 4px 16px rgba(0,0,0,0.5)',
  ].join(';');
  document.body.appendChild(tip);
  let hide;
  document.querySelectorAll('.fed-tip').forEach(el => {
    el.addEventListener('mouseenter', function(e) {
      clearTimeout(hide);
      tip.textContent = (this.dataset.i18nTip ? I18n.t(this.dataset.i18nTip) : null) || this.dataset.i18nTip;
      tip.style.opacity = '1';
      move(e);
    });
    el.addEventListener('mousemove', move);
    el.addEventListener('mouseleave', () => { hide = setTimeout(() => tip.style.opacity = '0', 100); });
  });
  function move(e) {
    const pad = 12, tw = tip.offsetWidth || 280, th = tip.offsetHeight || 60;
    let x = e.clientX + pad, y = e.clientY + pad;
    if (x + tw > window.innerWidth  - pad) x = e.clientX - tw - pad;
    if (y + th > window.innerHeight - pad) y = e.clientY - th - pad;
    tip.style.left = x + 'px'; tip.style.top = y + 'px';
  }
})();
</script>
{% endblock %}
