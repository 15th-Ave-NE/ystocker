{% extends "base.html" %}
{% block title %}yStocker — 13F Institutional Holdings{% endblock %}

{% block content %}

<!-- ── Header ────────────────────────────────────────────────────────── -->
<div class="mb-6 sm:mb-8 fade-up">
  <h1 class="text-2xl sm:text-3xl font-bold grad-text mb-1" data-i18n="thirteenf.title">13F Institutional Holdings</h1>
  <p class="text-slate-400 text-sm" data-i18n="thirteenf.subtitle">Latest quarterly 13F-HR filings from SEC EDGAR · Top 50 equity positions per fund</p>
  {% if cache_last_updated %}
  <p class="text-xs text-slate-600 mt-1">
    <span data-i18n="thirteenf.data_as_of">Data as of</span> {{ cache_last_updated | int | datetimeformat }}
    &nbsp;·&nbsp;
    {% if warming %}
    <span class="text-brand animate-pulse" data-i18n="thirteenf.refreshing">refreshing now…</span>
    {% else %}
    <span data-i18n="thirteenf.next_refresh">next refresh</span> {{ (cache_last_updated | int + 86400) | datetimeformat }}
    {% endif %}
  </p>
  {% elif warming %}
  <p class="text-xs text-brand animate-pulse mt-1" data-i18n="thirteenf.loading">Fetching holdings from SEC EDGAR — this may take ~30 seconds…</p>
  {% endif %}
</div>

<!-- ── Fund selector + panels ────────────────────────────────────────── -->
{% set fund_names = funds.keys() | list %}
{% set first_ok = namespace(slug='') %}
{% for name in fund_names %}
  {% if not first_ok.slug %}
    {% set fd = holdings.get(name, {}) %}
    {% if fd and not fd.get('error') %}
      {% set first_ok.slug = name | lower | replace(' ', '-') %}
    {% endif %}
  {% endif %}
{% endfor %}
{% set first_slug = first_ok.slug or (fund_names[0] | lower | replace(' ', '-') if fund_names else '') %}

<div x-data="{ activeFund: '{{ first_slug }}' }" class="fade-up">

  <!-- Fund pill buttons -->
  <div class="flex flex-wrap gap-2 mb-6">
    {% for name in fund_names %}
    {% set slug = name | lower | replace(' ', '-') %}
    {% set fd = holdings.get(name, {}) %}
    {% set has_error = fd and fd.get('error') %}
    <button @click="activeFund = '{{ slug }}'"
            {% if has_error %}disabled title="{{ fd.error }}"{% endif %}
            :class="activeFund === '{{ slug }}'
              ? 'border-brand bg-brand/15 text-white shadow-sm shadow-brand/20'
              : 'border-slate-700 text-slate-400 hover:text-slate-200 hover:border-slate-500'"
            class="px-4 py-2 rounded-xl border text-sm font-medium transition-all
                   {% if has_error %}opacity-30 cursor-not-allowed pointer-events-none{% endif %}">
      {{ name }}
    </button>
    {% endfor %}
  </div>

  <!-- Per-fund panels -->
  {% for name, cik in funds.items() %}
  {% set slug = name | lower | replace(' ', '-') %}
  {% set fd = holdings.get(name, {}) %}

  <div x-show="activeFund === '{{ slug }}'" x-transition
       class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6">

    {% if not fd %}
    <!-- No data yet -->
    <div class="py-16 text-center">
      <p class="text-slate-500 text-sm">
        {% if warming %}
      <span class="text-brand animate-pulse" data-i18n="thirteenf.loading">Fetching SEC EDGAR data… this takes ~30s on first load.</span>
        {% else %}
        No data yet. <a href="{{ url_for('main.thirteenf_refresh') }}" class="text-brand hover:underline">Refresh to load</a>.
        {% endif %}
      </p>
    </div>

    {% elif fd.get('error') %}
    <!-- Error state -->
    <div class="py-10 text-center">
      <span class="text-rose-400 text-sm mb-2"><span data-i18n="thirteenf.fetch_failed">Failed to fetch:</span> {{ fd.error }}</span>
      <a href="{{ url_for('main.thirteenf_refresh') }}"
         class="text-brand text-xs hover:underline">↻ Retry</a>
    </div>

    {% else %}
    <!-- Fund metadata row -->
    <div class="flex flex-wrap items-center gap-x-6 gap-y-1 mb-5 text-xs text-slate-500">
      <span><span data-i18n="thirteenf.cik">CIK:</span> <span class="font-mono text-slate-300">{{ cik }}</span></span>
      <span><span data-i18n="thirteenf.filing_date">Filing date:</span> <span class="text-slate-300 font-medium">{{ fd.filing_date }}</span></span>
      <span><span data-i18n="thirteenf.period">Period:</span> <span class="text-slate-300 font-medium">{{ fd.period_of_report }}</span></span>
      <span><span data-i18n="thirteenf.aum">Reported AUM:</span>
        <span class="text-slate-100 font-bold">
          ${{ "{:,.0f}".format(fd.total_value_millions) }}M
        </span>
      </span>
      <span><span data-i18n="thirteenf.shown">Holdings shown:</span> <span class="text-slate-300">{{ fd.holdings | length }} / {{ fd.total_holdings }}</span></span>
    </div>

    <!-- Holdings table -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm" data-sortable>
        <thead>
          <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
            <th class="text-right py-2 px-3 font-medium w-8 cursor-pointer hover:text-slate-300" data-col="0"><span data-i18n="thirteenf.th_rank">#</span> ↕</th>
            <th class="text-left  py-2 px-3 font-medium cursor-pointer hover:text-slate-300" data-col="1"><span data-i18n="thirteenf.th_ticker">Ticker</span> ↕</th>
            <th class="text-left  py-2 px-3 font-medium cursor-pointer hover:text-slate-300" data-col="2"><span data-i18n="thirteenf.th_company">Company</span> ↕</th>
            <th class="text-left  py-2 px-3 font-medium" data-i18n="thirteenf.th_52w">52-week</th>
            <th class="text-right py-2 px-3 font-medium cursor-pointer hover:text-slate-300" data-col="3"><span data-i18n="thirteenf.th_shares">Shares</span> ↕</th>
            <th class="text-right py-2 px-3 font-medium cursor-pointer hover:text-slate-300" data-col="4"><span data-i18n="thirteenf.th_value">Value ($M)</span> ↕</th>
            <th class="text-right py-2 px-3 font-medium cursor-pointer hover:text-slate-300" data-col="5"><span data-i18n="thirteenf.th_pct">% Portfolio</span> ↕</th>
            <th class="text-center py-2 px-3 font-medium" data-i18n="thirteenf.th_change">Change</th>
          </tr>
        </thead>
        <tbody>
          {% for h in fd.holdings %}
          <tr class="border-b border-slate-800/50 hover:bg-slate-800/40 transition"
              data-rank="{{ h.rank }}"
              data-ticker="{{ h.ticker or h.cusip }}"
              data-name="{{ h.name }}"
              data-shares="{{ h.shares }}"
              data-value="{{ h.value_millions }}"
              data-pct="{{ h.pct_portfolio }}">
            <td class="py-2.5 px-3 text-right text-slate-600 text-xs">{{ h.rank }}</td>
            <td class="py-2.5 px-3">
              {% if h.ticker %}
              <a href="{{ url_for('main.history', ticker=h.ticker) }}"
                 class="font-mono font-bold text-brand hover:underline">{{ h.ticker }}</a>
              {% else %}
              <span class="text-slate-600 font-mono text-xs">{{ h.cusip }}</span>
              {% endif %}
            </td>
            <td class="py-2.5 px-3 text-slate-300 text-xs max-w-[180px] truncate" title="{{ h.name }}">{{ h.name }}</td>
            <td class="py-2.5 px-3">
              {% if h.ticker %}
              <div class="flex items-center gap-2">
                <canvas class="sparkline" data-ticker="{{ h.ticker }}" width="80" height="28"></canvas>
                <span class="spark-pct text-xs font-mono" data-ticker="{{ h.ticker }}"></span>
              </div>
              {% endif %}
            </td>
            <td class="py-2.5 px-3 text-right font-mono text-sm text-slate-300">
              {{ "{:,}".format(h.shares) }}
            </td>
            <td class="py-2.5 px-3 text-right font-mono text-sm">
              ${{ "{:,.1f}".format(h.value_millions) }}
            </td>
            <td class="py-2.5 px-3 text-right font-mono text-sm text-slate-300">
              {{ "{:.2f}".format(h.pct_portfolio) }}%
            </td>
            <td class="py-2.5 px-3 text-center">
              {% if h.change == 'new' %}
              <span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-emerald-900/50 text-emerald-300 border border-emerald-800" data-i18n="inst.change_new">New</span>
              {% elif h.change == 'increased' %}
              <span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-sky-900/50 text-sky-300 border border-sky-800" data-i18n="inst.change_added">▲ Added</span>
              {% if h.change_pct %}<span class="text-sky-400 text-xs font-mono ml-1">+{{ h.change_pct }}%</span>{% endif %}
              {% elif h.change == 'reduced' %}
              <span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-amber-900/50 text-amber-300 border border-amber-800" data-i18n="inst.change_reduced">▼ Reduced</span>
              {% if h.change_pct %}<span class="text-amber-400 text-xs font-mono ml-1">{{ h.change_pct }}%</span>{% endif %}
              {% elif h.change == 'closed' %}
              <span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-rose-900/50 text-rose-300 border border-rose-800" data-i18n="inst.change_closed">Closed</span>
              {% elif h.change == 'unchanged' %}
              <span class="text-slate-600 text-xs">—</span>
              {% else %}
              <span class="text-slate-700 text-xs">?</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>
  {% endfor %}

</div>

<!-- Legend -->
<div class="mt-6 flex flex-wrap gap-4 text-xs text-slate-500 fade-up">
  <span class="flex items-center gap-1.5"><span class="px-1.5 py-0.5 rounded bg-emerald-900/50 text-emerald-300 border border-emerald-800 text-[10px] font-semibold" data-i18n="inst.change_new">New</span> <span data-i18n="thirteenf.legend_new">New position this quarter</span></span>
  <span class="flex items-center gap-1.5"><span class="px-1.5 py-0.5 rounded bg-sky-900/50 text-sky-300 border border-sky-800 text-[10px] font-semibold" data-i18n="inst.change_added">▲ Added</span> <span data-i18n="thirteenf.legend_added">Shares increased vs prior quarter</span></span>
  <span class="flex items-center gap-1.5"><span class="px-1.5 py-0.5 rounded bg-amber-900/50 text-amber-300 border border-amber-800 text-[10px] font-semibold" data-i18n="inst.change_reduced">▼ Reduced</span> <span data-i18n="thirteenf.legend_reduced">Shares decreased vs prior quarter</span></span>
  <span class="flex items-center gap-1.5"><span class="px-1.5 py-0.5 rounded bg-rose-900/50 text-rose-300 border border-rose-800 text-[10px] font-semibold" data-i18n="inst.change_closed">Closed</span> <span data-i18n="thirteenf.legend_closed">Position exited (prior quarter only)</span></span>
  <span>· <span data-i18n="thirteenf.source">Data source:</span> <a href="https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&type=13F" target="_blank" rel="noopener" class="text-brand hover:underline">SEC EDGAR</a></span>
</div>

<script>
// Sortable tables — click any ↕ header to sort ascending, click again for descending
document.querySelectorAll('table[data-sortable]').forEach(table => {
  const KEYS = ['rank','ticker','name','shares','value','pct'];
  const NUM  = new Set([0,3,4,5]);
  let sortCol = -1, sortAsc = true;

  table.querySelectorAll('th[data-col]').forEach(th => {
    th.addEventListener('click', () => {
      const col = +th.dataset.col;
      if (sortCol === col) sortAsc = !sortAsc; else { sortCol = col; sortAsc = true; }
      table.querySelectorAll('th[data-col]').forEach(h => {
        const base = h.textContent.replace(/ [↑↓↕]$/, '');
        h.textContent = base + ' ' + (+h.dataset.col === col ? (sortAsc ? '↑' : '↓') : '↕');
      });
      const key = KEYS[col];
      const rows = [...table.tBodies[0].rows];
      rows.sort((a, b) => {
        let av = a.dataset[key] || '', bv = b.dataset[key] || '';
        if (NUM.has(col)) { av = parseFloat(av) || 0; bv = parseFloat(bv) || 0; }
        const cmp = NUM.has(col) ? av - bv : av.localeCompare(bv);
        return sortAsc ? cmp : -cmp;
      });
      rows.forEach(r => table.tBodies[0].appendChild(r));
    });
  });
});

// Sparklines — fetch price history lazily for visible tickers using IntersectionObserver
const _sparkCache = {};
function drawSparkline(canvas, prices) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const valid = prices.filter(p => p != null);
  if (!valid.length) return;
  const mn = Math.min(...valid), mx = Math.max(...valid);
  const range = mx - mn || 1;
  const first = valid[0], last = valid[valid.length - 1];
  const color = last >= first ? '#34d399' : '#f43f5e';
  ctx.clearRect(0, 0, w, h);
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  let drawn = false;
  prices.forEach((p, i) => {
    if (p == null) return;
    const x = (i / (prices.length - 1)) * w;
    const y = h - ((p - mn) / range) * (h - 2) - 1;
    if (!drawn) { ctx.moveTo(x, y); drawn = true; } else ctx.lineTo(x, y);
  });
  ctx.stroke();
}

async function loadSparkline(ticker) {
  if (_sparkCache[ticker]) return _sparkCache[ticker];
  try {
    const r = await fetch(`/api/history/${encodeURIComponent(ticker)}`);
    const d = await r.json();
    _sparkCache[ticker] = d;
    return d;
  } catch { return null; }
}

const observer = new IntersectionObserver(async entries => {
  for (const entry of entries) {
    if (!entry.isIntersecting) continue;
    const canvas = entry.target;
    const ticker = canvas.dataset.ticker;
    observer.unobserve(canvas);
    const d = await loadSparkline(ticker);
    if (!d || !d.prices) continue;
    drawSparkline(canvas, d.prices);
    // 52-week % change
    const prices = d.prices.filter(p => p != null);
    if (prices.length >= 2) {
      const pct = (prices[prices.length-1] - prices[0]) / prices[0] * 100;
      const el = document.querySelector(`.spark-pct[data-ticker="${ticker}"]`);
      if (el) {
        el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
        el.className = 'spark-pct text-xs font-mono ' + (pct >= 0 ? 'text-emerald-400' : 'text-rose-400');
      }
    }
  }
}, { rootMargin: '200px' });

document.querySelectorAll('canvas.sparkline').forEach(c => observer.observe(c));
</script>

{% endblock %}
