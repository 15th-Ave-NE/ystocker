{% extends "base.html" %}
{% block title %}yStocker — {{ ticker }} PE History{% endblock %}

{% block content %}

<div class="mb-6 sm:mb-8 fade-up">
  <div class="flex items-center gap-3 mb-1">
    <button onclick="history.back()" class="text-slate-500 hover:text-slate-300 text-sm transition">← Back</button>
    <span class="text-slate-700">/</span>
    <span class="text-slate-300 text-sm font-mono font-semibold">{{ ticker }}</span>
  </div>
  <h1 class="text-2xl sm:text-3xl font-bold">
    <span class="font-mono grad-text">{{ ticker }}</span>
    <span id="stockName" class="text-slate-400 text-lg sm:text-xl font-normal ml-2 sm:ml-3"></span>
  </h1>
  <p class="text-slate-500 text-sm mt-1">1-year historical PE ratio &amp; price (weekly)</p>
</div>

<!-- ── Stat cards ───────────────────────────────────────────────────── -->
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4 mb-6 sm:mb-8 fade-up">
  {% for id, label in [('statCurrentPe','Current PE'),('statFwdPe','Forward PE'),
                       ('statCurrentPeg','PEG Ratio'),('statTarget','Target Price'),
                       ('statEps','TTM EPS'),('statUpside','Analyst Upside')] %}
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1">{{ label }}</div>
    <div id="{{ id }}" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  {% endfor %}
</div>

<!-- ── Charts ────────────────────────────────────────────────────────── -->
<div class="space-y-6">

  <!-- PE history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200">PE Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500">Estimated from weekly closing price ÷ TTM EPS</p>
      </div>
      <div class="flex gap-2 text-xs">
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-brand"></span> PE (TTM)
        </span>
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-amber-400 border-dashed border"></span> Current PE
        </span>
      </div>
    </div>
    <div id="peLoading" class="flex items-center justify-center h-36 sm:h-48 text-slate-500 text-sm animate-pulse">
      Loading PE history for {{ ticker }} …
    </div>
    <div class="chart-container" style="height:220px; display:none" id="peChartWrap">
      <canvas id="peChart"></canvas>
    </div>
  </div>

  <!-- Price history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200">Price — 52 Weeks</h2>
        <p class="text-xs text-slate-500">Weekly closing price (USD)</p>
      </div>
    </div>
    <div class="chart-container" style="height:200px; display:none" id="priceChartWrap">
      <canvas id="priceHistChart"></canvas>
    </div>
  </div>

  <!-- PEG history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="pegHistSection" style="display:none">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200">PEG Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500">Estimated from weekly PE ÷ annual earnings growth rate</p>
      </div>
      <div class="flex gap-3 text-xs">
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-emerald-400"></span> PEG
        </span>
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> PEG = 1
        </span>
      </div>
    </div>
    <div class="chart-container" style="height:200px" id="pegChartWrap">
      <canvas id="pegHistChart"></canvas>
    </div>
  </div>

</div>

<!-- Error -->
<div id="histError" class="hidden mt-4 px-4 py-3 rounded-lg bg-red-900/40 border border-red-700 text-red-300 text-sm"></div>

<script>
const TICKER = {{ ticker | tojson }};

(async function() {
  let data;
  try {
    const resp = await fetch(`/api/history/${encodeURIComponent(TICKER)}`);
    data = await resp.json();
    if (!resp.ok) {
      document.getElementById('histError').textContent = '⚠ ' + data.error;
      document.getElementById('histError').classList.remove('hidden');
      document.getElementById('peLoading').textContent = 'Failed to load data.';
      return;
    }
  } catch(e) {
    document.getElementById('histError').textContent = '⚠ Network error: ' + e;
    document.getElementById('histError').classList.remove('hidden');
    return;
  }

  // Stat cards
  document.getElementById('stockName').textContent     = data.name || '';
  document.getElementById('statCurrentPe').textContent = data.current_pe  != null ? data.current_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statFwdPe').textContent      = data.forward_pe  != null ? data.forward_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statTarget').textContent     = data.target_price != null ? '$'+data.target_price.toFixed(2) : '—';
  document.getElementById('statEps').textContent        = data.eps          != null ? '$'+data.eps.toFixed(2)          : '—';

  const pegEl = document.getElementById('statCurrentPeg');
  if (data.current_peg != null) {
    pegEl.textContent  = data.current_peg.toFixed(2);
    pegEl.className    = 'text-xl font-bold ' + (data.current_peg < 1 ? 'text-emerald-400' : data.current_peg < 2 ? 'text-amber-400' : 'text-rose-400');
  }

  const upsideEl = document.getElementById('statUpside');
  if (data.target_price != null && data.prices?.length) {
    const lastPrice = data.prices.filter(p => p != null).at(-1);
    if (lastPrice) {
      const upside = (data.target_price - lastPrice) / lastPrice * 100;
      upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(1) + '%';
      upsideEl.className   = 'text-xl font-bold ' + (upside >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }

  const gridCol = '#1e293b';
  const tickCol = '#64748b';

  // ── PE chart
  document.getElementById('peLoading').style.display = 'none';
  document.getElementById('peChartWrap').style.display = 'block';

  const peCtx = document.getElementById('peChart');
  new Chart(peCtx, {
    type: 'line',
    data: {
      labels: data.dates,
      datasets: [
        {
          label: 'PE (TTM)',
          data: data.pe_history,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99,102,241,0.08)',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          fill: true,
          tension: 0.3,
          spanGaps: true,
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: { label: c => ` PE: ${c.raw?.toFixed(1)}x` }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'x'} }
      },
      interaction: { mode:'index', intersect:false },
    },
    plugins: [{
      afterDraw(chart) {
        if (data.current_pe == null) return;
        const {ctx: c, chartArea: a, scales: {y}} = chart;
        const py = y.getPixelForValue(data.current_pe);
        if (py < a.top || py > a.bottom) return;
        c.save();
        c.strokeStyle = '#f59e0b88'; c.lineWidth = 1.5; c.setLineDash([5,4]);
        c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
        c.fillStyle = '#f59e0b'; c.font = '11px Inter,sans-serif';
        c.fillText('Current PE ' + data.current_pe.toFixed(1)+'x', a.left+6, py-5);
        c.restore();
      }
    }]
  });

  // ── Price chart
  document.getElementById('priceChartWrap').style.display = 'block';
  const prCtx = document.getElementById('priceHistChart');
  new Chart(prCtx, {
    type: 'line',
    data: {
      labels: data.dates,
      datasets: [{
        label: 'Price',
        data: data.prices,
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.07)',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 5,
        fill: true,
        tension: 0.3,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: { label: c => ` $${c.raw?.toFixed(2)}` }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => '$'+v} }
      },
      interaction: { mode:'index', intersect:false },
    },
    plugins: [{
      afterDraw(chart) {
        if (data.target_price == null) return;
        const {ctx: c, chartArea: a, scales: {y}} = chart;
        const py = y.getPixelForValue(data.target_price);
        if (py < a.top || py > a.bottom) return;
        c.save();
        c.strokeStyle = '#34d39988'; c.lineWidth = 1.5; c.setLineDash([5,4]);
        c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
        c.fillStyle = '#34d399'; c.font = '11px Inter,sans-serif';
        c.fillText('Target $' + data.target_price.toFixed(2), a.left+6, py-5);
        c.restore();
      }
    }]
  });

  // ── PEG history chart (only when data available)
  if (data.peg_history && data.peg_history.some(v => v != null)) {
    document.getElementById('pegHistSection').style.display = 'block';
    const pgCtx = document.getElementById('pegHistChart');
    new Chart(pgCtx, {
      type: 'line',
      data: {
        labels: data.dates,
        datasets: [{
          label: 'PEG',
          data: data.peg_history,
          borderColor: '#34d399',
          backgroundColor: 'rgba(52,211,153,0.07)',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          fill: true,
          tension: 0.3,
          spanGaps: true,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: { label: c => ` PEG: ${c.raw?.toFixed(2)}` }
          }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v.toFixed(1)} }
        },
        interaction: { mode:'index', intersect:false },
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx: c, chartArea: a, scales: {y}} = chart;
          [1, 2].forEach((ref, i) => {
            const py = y.getPixelForValue(ref);
            if (py < a.top || py > a.bottom) return;
            c.save();
            c.strokeStyle = i === 0 ? '#f59e0b88' : '#f43f5e66';
            c.lineWidth = 1.5; c.setLineDash([5,4]);
            c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
            c.fillStyle = i === 0 ? '#f59e0b' : '#f43f5e';
            c.font = '11px Inter,sans-serif';
            c.fillText('PEG = ' + ref, a.left+6, py-5);
            c.restore();
          });
        }
      }]
    });
  }
})();
</script>
{% endblock %}
