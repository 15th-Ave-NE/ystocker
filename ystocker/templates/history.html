{% extends "base.html" %}
{% block title %}yStocker — {{ ticker }} PE History{% endblock %}

{% block content %}
<style>
  .range-btn {
    font-size: 11px;
    font-weight: 500;
    line-height: 1;
    padding: 3px 7px;
    border-radius: 5px;
    border: 1px solid #334155;
    background: transparent;
    color: #64748b;
    cursor: pointer;
    transition: color 0.15s, background 0.15s, border-color 0.15s;
  }
  .range-btn:hover {
    color: #cbd5e1;
    border-color: #475569;
    background: #1e293b;
  }
  .range-btn.active {
    color: #a5b4fc;
    border-color: #6366f1;
    background: rgba(99,102,241,0.15);
  }
  .expand-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3px;
    border: none;
    background: transparent;
    color: #475569;
    cursor: pointer;
    transition: color 0.15s;
  }
  .expand-btn:hover { color: #cbd5e1; }
  .explain-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 500;
    padding: 3px 9px;
    border-radius: 5px;
    border: 1px solid #334155;
    background: transparent;
    color: #64748b;
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
  }
  .explain-btn:hover {
    color: #a5b4fc;
    border-color: #6366f1;
    background: rgba(99,102,241,0.10);
  }
  .explain-btn.loading {
    pointer-events: none;
    opacity: 0.6;
  }
  .explain-panel {
    margin-top: 14px;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid #1e293b;
    background: rgba(99,102,241,0.04);
    color: #94a3b8;
    font-size: 13px;
    line-height: 1.65;
    white-space: pre-wrap;
    display: none;
  }
</style>

<div class="mb-6 sm:mb-8 fade-up">
  <div class="flex items-center gap-3 mb-1">
    <button onclick="history.back()" class="text-slate-500 hover:text-slate-300 text-sm transition" data-i18n="history.back">← Back</button>
    <span class="text-slate-700">/</span>
    <span class="text-slate-300 text-sm font-mono font-semibold">{{ ticker }}</span>
    <div class="ml-auto flex items-center gap-2">
      <a href="https://www.tradingview.com/chart/?symbol={{ ticker }}" target="_blank" rel="noopener"
         class="flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
                hover:text-slate-200 hover:border-slate-500 transition px-2.5 py-1 rounded-lg">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
        <span data-i18n="history.tradingview">TradingView</span>
      </a>
    </div>
  </div>
  <h1 class="text-2xl sm:text-3xl font-bold">
    <span class="font-mono grad-text">{{ ticker }}</span>
    <span id="stockName" class="text-slate-400 text-lg sm:text-xl font-normal ml-2 sm:ml-3"></span>
  </h1>
  <p class="text-slate-500 text-sm mt-1" data-i18n="history.subtitle">Historical PE ratio &amp; price</p>
</div>

<!-- ── Tab switcher ──────────────────────────────────────────────────── -->
<div class="flex gap-1 mb-6 border-b border-slate-800">
  <button id="tabChartsBtn" onclick="switchTab('charts')"
          class="px-4 py-2 text-sm font-medium border-b-2 border-brand text-brand -mb-px transition"
          data-i18n="history.tab_charts">Charts &amp; Holdings</button>
  <button id="tabNewsBtn" onclick="switchTab('news')"
          class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200 -mb-px transition"
          data-i18n="history.tab_news">News</button>
  <button id="tabVideosBtn" onclick="switchTab('videos')"
          class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200 -mb-px transition"
          data-i18n="history.tab_videos">Videos</button>
</div>

<!-- ── Charts panel ──────────────────────────────────────────────────── -->
<div id="panelCharts">

<!-- ── Stat cards ───────────────────────────────────────────────────── -->
<div class="space-y-3 mb-6 sm:mb-8 fade-up">

  <!-- Valuation -->
  <div>
    <p class="text-[10px] font-semibold uppercase tracking-widest text-slate-600 mb-2 px-1" data-i18n="history.group_valuation">Valuation</p>
    <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-3">
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.current_pe">Current PE</div>
        <div id="statCurrentPe" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.fwd_pe">Forward PE</div>
        <div id="statFwdPe" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.peg_ratio">PEG Ratio</div>
        <div id="statCurrentPeg" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ev_ebitda">EV/EBITDA</div>
        <div id="statEvEbitda" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ev">EV ($B)</div>
        <div id="statEv" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ebitda">EBITDA ($B)</div>
        <div id="statEbitda" class="text-base font-bold text-slate-100">—</div>
      </div>
    </div>
  </div>

  <!-- Earnings -->
  <div>
    <p class="text-[10px] font-semibold uppercase tracking-widest text-slate-600 mb-2 px-1" data-i18n="history.group_earnings">Earnings</p>
    <div class="grid grid-cols-3 sm:grid-cols-3 gap-2 sm:gap-3">
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ttm_eps">TTM EPS</div>
        <div id="statEps" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.eps_growth_ttm">EPS Growth TTM</div>
        <div id="statEpsGrowthTtm" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.eps_growth_q">EPS Growth Q</div>
        <div id="statEpsGrowthQ" class="text-base font-bold text-slate-100">—</div>
      </div>
    </div>
  </div>

  <!-- Price / Sentiment -->
  <div>
    <p class="text-[10px] font-semibold uppercase tracking-widest text-slate-600 mb-2 px-1" data-i18n="history.group_sentiment">Price &amp; Sentiment</p>
    <div class="grid grid-cols-3 sm:grid-cols-3 gap-2 sm:gap-3">
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.target_price">Target Price</div>
        <div id="statTarget" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.upside">Analyst Upside</div>
        <div id="statUpside" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.put_call_ratio">P/C Ratio</div>
        <div id="statPutCallRatio" class="text-base font-bold text-slate-100">—</div>
        <div id="statPutCallLabel" class="text-[10px] mt-0.5 text-slate-600"></div>
      </div>
    </div>
  </div>

</div>

<!-- ── Charts ────────────────────────────────────────────────────────── -->
<div class="space-y-6">

  <!-- PE history line chart -->
  <div id="peHistSection" class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.pe_title">PE Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.pe_desc">Estimated from weekly closing price ÷ TTM EPS</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-brand"></span> <span data-i18n="history.pe_legend">PE (TTM)</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 bg-amber-400 border-dashed border"></span> <span data-i18n="history.current_pe_legend">Current PE</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 border-dashed border border-slate-400"></span> <span data-i18n="history.avg_pe_legend">Avg PE</span>
        </span>
        <div class="flex gap-1" id="peRangeBtns">
          <button class="range-btn" data-chart="pe" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="pe" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="pe" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="pe" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="pe" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="pe" data-period="5y">5Y</button>
          <button class="range-btn" data-chart="pe" data-period="10y">10Y</button>
        </div>
        <button onclick="expandChart('pe')" title="Expand" class="expand-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
        <button id="explainBtnPe" class="explain-btn" onclick="explainChart('pe')" data-i18n="history.explain">✦ Explain</button>
      </div>
    </div>
    <div id="peLoading" class="flex items-center justify-center h-36 sm:h-48 text-slate-500 text-sm animate-pulse">
      Loading PE history for {{ ticker }} …
    </div>
    <div class="chart-container" style="height:300px; display:none" id="peChartWrap">
      <canvas id="peChart"></canvas>
    </div>
    <div id="explainPanelPe" class="explain-panel"></div>
  </div>

  <!-- Forward PE chart -->
  <div id="fwdPeHistSection" class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" style="display:none">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.fwdpe_title">Forward PE — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.fwdpe_desc">Price ÷ consensus forward EPS — forward valuation multiple over time</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5" style="background:#a78bfa"></span> <span data-i18n="history.fwdpe_legend">Forward PE</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> <span data-i18n="history.current_fwdpe_legend">Current Fwd PE</span>
        </span>
        <div class="flex gap-1" id="fwdPeRangeBtns">
          <button class="range-btn" data-chart="fwdpe" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="fwdpe" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="fwdpe" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="fwdpe" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="fwdpe" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="fwdpe" data-period="5y">5Y</button>
          <button class="range-btn" data-chart="fwdpe" data-period="10y">10Y</button>
        </div>
        <button onclick="expandChart('fwdpe')" title="Expand" class="expand-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
        <button id="explainBtnFwdpe" class="explain-btn" onclick="explainChart('fwdpe')" data-i18n="history.explain">✦ Explain</button>
      </div>
    </div>
    <div class="chart-container" style="height:300px" id="fwdPeChartWrap">
      <canvas id="fwdPeChart"></canvas>
    </div>
    <div id="explainPanelFwdpe" class="explain-panel"></div>
  </div>

  <!-- Price history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.price_title">Price — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.price_desc">Weekly closing price (USD)</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-sky-400"></span> <span data-i18n="history.price_legend">Price</span>
        </span>
        <span id="legendTarget" style="display:none" class="items-center gap-1.5 text-xs text-slate-400 cursor-help wall-tip"
              data-tip-i18n="history.tip_target">
          <span class="inline-block w-3 h-0.5 border-dashed border border-emerald-400"></span> <span data-i18n="history.target_legend">Target</span>
        </span>
        <span id="legendCallWall" style="display:none" class="items-center gap-1.5 text-xs text-amber-400 cursor-help wall-tip"
              data-tip-i18n="history.tip_call_wall">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> <span data-i18n="history.call_wall_legend">Call Wall</span>
          <span class="text-slate-500 text-[10px] ml-0.5">ⓘ</span>
        </span>
        <span id="legendPutWall" style="display:none" class="items-center gap-1.5 text-xs text-rose-400 cursor-help wall-tip mr-1"
              data-tip-i18n="history.tip_put_wall">
          <span class="inline-block w-3 h-0.5 border-dashed border border-rose-400"></span> <span data-i18n="history.put_wall_legend">Put Wall</span>
          <span class="text-slate-500 text-[10px] ml-0.5">ⓘ</span>
        </span>
        <div class="flex gap-1" id="priceRangeBtns">
          <button class="range-btn" data-chart="price" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="price" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="price" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="price" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="price" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="price" data-period="5y">5Y</button>
          <button class="range-btn" data-chart="price" data-period="10y">10Y</button>
        </div>
        <button onclick="expandChart('price')" title="Expand" class="expand-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
        <button id="explainBtnPrice" class="explain-btn" onclick="explainChart('price')" data-i18n="history.explain">✦ Explain</button>
      </div>
    </div>
    <div class="chart-container" style="height:300px; display:none" id="priceChartWrap">
      <canvas id="priceHistChart"></canvas>
    </div>
    <div id="explainPanelPrice" class="explain-panel"></div>
  </div>

  <!-- ── Price Forecast chart ────────────────────────────────────────── -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="forecastSection">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="forecast.title">Price Forecast — 6 Months</h2>
        <p class="text-xs text-slate-500" data-i18n="forecast.desc">Statistical projections from 3 independent models trained on 3 years of weekly data. Not investment advice.</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <!-- model legend chips -->
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-1 rounded-sm" style="background:#38bdf8"></span>
          <span data-i18n="forecast.actual">Actual price</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs" style="color:#a78bfa">
          <span class="inline-block w-3 h-1 rounded-sm" style="background:#a78bfa"></span>
          <span data-i18n="forecast.prophet">Prophet</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs" style="color:#fb923c">
          <span class="inline-block w-3 h-1 rounded-sm" style="background:#fb923c"></span>
          <span data-i18n="forecast.arima">ARIMA</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs" style="color:#34d399">
          <span class="inline-block w-3 h-1 rounded-sm" style="background:#34d399"></span>
          <span data-i18n="forecast.linear">Linear</span>
        </span>
        <button onclick="expandChart('forecast')" title="Expand" class="expand-btn ml-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
      </div>
    </div>
    <!-- loading state -->
    <div id="forecastLoading" class="flex items-center gap-2 text-sm text-slate-500 py-6">
      <svg class="animate-spin w-4 h-4 text-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span data-i18n="forecast.loading">Running models…</span>
    </div>
    <div class="chart-container" style="height:380px; display:none" id="forecastChartWrap">
      <canvas id="forecastChart"></canvas>
    </div>
    <!-- per-model status row -->
    <div id="forecastModelStatus" class="hidden flex flex-wrap gap-3 mt-3 text-[11px]"></div>
    <!-- disclaimer -->
    <p class="text-[11px] text-slate-600 mt-3 leading-snug" data-i18n="forecast.disclaimer">
      ⚠ Statistical projections only — not financial advice. Past patterns do not guarantee future results.
    </p>
  </div>

  <!-- PEG history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="pegHistSection" style="display:none">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.peg_title">PEG Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.peg_desc">Estimated from weekly PE ÷ annual earnings growth rate</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-emerald-400"></span> <span data-i18n="history.peg_legend">PEG</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> <span data-i18n="history.peg1_legend">PEG = 1</span>
        </span>
        <div class="flex gap-1" id="pegRangeBtns">
          <button class="range-btn" data-chart="peg" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="peg" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="peg" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="peg" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="peg" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="peg" data-period="5y">5Y</button>
          <button class="range-btn" data-chart="peg" data-period="10y">10Y</button>
        </div>
        <button onclick="expandChart('peg')" title="Expand" class="expand-btn ml-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
        <button id="explainBtnPeg" class="explain-btn" onclick="explainChart('peg')" data-i18n="history.explain">✦ Explain</button>
      </div>
    </div>
    <div class="chart-container" style="height:300px" id="pegChartWrap">
      <canvas id="pegHistChart"></canvas>
    </div>
    <div id="explainPanelPeg" class="explain-panel"></div>
  </div>

  <!-- P/C Ratio by Expiration chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="pcChartSection" style="display:none">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.pc_chart_title">Put/Call Ratio by Expiration</h2>
        <p class="text-xs text-slate-500" data-i18n="history.pc_chart_desc">Total put OI ÷ call OI per expiry — &gt;1.2 bearish · &lt;0.7 bullish</p>
      </div>
      <div class="flex items-center gap-3 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-rose-400"><span class="inline-block w-2 h-2 rounded-sm bg-rose-500/70"></span> &gt;1.2 Bearish</span>
        <span class="flex items-center gap-1.5 text-xs text-amber-400"><span class="inline-block w-2 h-2 rounded-sm bg-amber-500/70"></span> Neutral</span>
        <span class="flex items-center gap-1.5 text-xs text-emerald-400"><span class="inline-block w-2 h-2 rounded-sm bg-emerald-500/70"></span> &lt;0.7 Bullish</span>
      </div>
    </div>
    <div class="chart-container" style="height:280px"><canvas id="pcByExpiryChart"></canvas></div>
  </div>

  <!-- Annual Financials: 3 years actuals + 2 years forward estimates -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="financialsSection" style="display:none">
    <div class="flex items-baseline gap-3 mb-4">
      <h2 class="text-base font-semibold text-slate-200" data-i18n="history.financials_title">Annual Financials</h2>
      <span class="text-xs text-slate-500" data-i18n="history.financials_desc">3-year actuals · 2-year forward estimates · values in $B except EPS</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="financialsTable">
        <thead id="financialsHead"></thead>
        <tbody id="financialsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- EV/EBITDA panel -->
  <div id="evEbitdaSection" class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" style="display:none">
    <h2 class="text-base font-semibold text-slate-200 mb-1" data-i18n="history.ev_ebitda_title">EV / EBITDA</h2>
    <p class="text-xs text-slate-500 mb-4" data-i18n="history.ev_ebitda_desc">Enterprise Value ÷ EBITDA — capital-structure-neutral valuation multiple.</p>
    <div class="grid grid-cols-3 gap-3">
      <div class="bg-slate-800/60 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ev_ebitda">EV/EBITDA</div>
        <div id="evEbitdaVal" class="text-base font-bold text-slate-100">—</div>
        <div id="evEbitdaBand" class="text-xs mt-0.5"></div>
      </div>
      <div class="bg-slate-800/60 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ev">EV ($B)</div>
        <div id="evVal" class="text-base font-bold text-slate-100">—</div>
      </div>
      <div class="bg-slate-800/60 rounded-xl px-3 py-3">
        <div class="text-xs text-slate-500 mb-1" data-i18n="history.ebitda">EBITDA ($B)</div>
        <div id="ebitdaVal" class="text-base font-bold text-slate-100">—</div>
      </div>
    </div>
    <p class="text-xs text-slate-600 mt-3">
      <span class="text-emerald-400">■</span> &lt;8x 便宜 &nbsp;
      <span class="text-sky-400">■</span> 8–13x 正常 &nbsp;
      <span class="text-amber-400">■</span> 13–20x 成长型 &nbsp;
      <span class="text-rose-400">■</span> 20x+ 高增长或泡沫
    </p>
  </div>

</div>

<!-- ── Expand modal ──────────────────────────────────────────────────── -->
<div id="chartModal" class="fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm" style="display:none">
  <div class="relative bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-[95vw] max-w-6xl p-5 sm:p-8">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 id="modalTitle" class="text-base font-semibold text-slate-200"></h3>
        <p id="modalDesc"  class="text-xs text-slate-500 mt-0.5"></p>
      </div>
      <button onclick="closeModal()" class="text-slate-500 hover:text-slate-200 transition ml-4 flex-shrink-0">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div style="height:65vh; min-height:300px; position:relative">
      <canvas id="modalCanvas"></canvas>
    </div>
  </div>
</div>

<!-- Institutional Holdings (13F) -->
<div id="instHoldersSection" class="mt-6 bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" style="display:none">
  <h2 class="text-base font-semibold text-slate-200 mb-1" data-i18n="history.inst_title">Institutional Holdings (13F)</h2>
  <p class="text-xs text-slate-500 mb-4" data-i18n="history.inst_desc">Multi-quarter position history across tracked funds — sorted by latest position size</p>

  <!-- Shares-held bar chart per quarter -->
  <div class="mb-6">
    <div class="chart-container" style="height:260px"><canvas id="instSharesChart"></canvas></div>
  </div>

  <!-- Multi-quarter table -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="instHoldersTable">
      <thead id="instHoldersHead"></thead>
      <tbody id="instHoldersBody"></tbody>
    </table>
  </div>
</div>

</div><!-- end #panelCharts -->

<!-- ── News panel ────────────────────────────────────────────────────── -->
<div id="panelNews" style="display:none">

  <!-- Timeline scrubber -->
  <div id="newsTimeline" class="relative mb-5" style="display:none">
    <div class="flex items-center gap-2 mb-2">
      <span class="text-xs text-slate-500 font-medium" data-i18n="history.news_timeline">Timeline</span>
      <div class="flex-1 h-px bg-slate-800"></div>
    </div>
    <!-- Scrollable day-segment bar -->
    <div id="timelineBar"
         class="flex gap-1 overflow-x-auto pb-1"
         style="scrollbar-width:thin; scrollbar-color:#334155 transparent">
    </div>
  </div>

  <!-- Status + refresh -->
  <div class="flex items-center justify-between mb-4">
    <div id="newsStatus" class="text-slate-500 text-sm animate-pulse" data-i18n="history.news_loading">Fetching news…</div>
    <button onclick="loadNews(true)"
            class="flex items-center gap-1.5 text-xs text-slate-400 border border-slate-700 bg-slate-800
                   hover:text-slate-200 hover:border-slate-500 transition px-2.5 py-1 rounded-lg"
            data-i18n="history.news_refresh">↻ Refresh</button>
  </div>

  <div id="newsFeed" class="space-y-3"></div>
</div>

<!-- ── Videos panel ──────────────────────────────────────────────── -->
<div id="panelVideos" style="display:none">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <div id="videosStatus" class="text-slate-500 text-sm"></div>
    </div>
    <a id="videosYtLink" href="#" target="_blank" rel="noopener"
       class="flex items-center gap-1.5 text-xs text-slate-400 border border-slate-700 bg-slate-800
              hover:text-slate-200 hover:border-slate-500 transition px-2.5 py-1 rounded-lg"
       data-i18n="history.videos_open_yt">Open on YouTube ↗</a>
  </div>
  <div id="videosFeed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

<!-- Error -->
<div id="histError" class="hidden mt-4 px-4 py-3 rounded-lg bg-red-900/40 border border-red-700 text-red-300 text-sm"></div>

<script>
const TICKER = {{ ticker | tojson }};

// ── Range buttons + expand modal ─────────────────────────────────────────────
const _chartConfigs   = {};   // key → latest Chart.js config object
const _chartInstances = {};   // key → live Chart instance (for inline charts)
const _periodCache    = {};   // period → fetched data
let   _modalChart     = null;
let   _modalKey       = null;
let   _staticData     = null;   // reference values (target, walls, current_pe)
let   _forecastResult = null;   // last forecast API response

(async function() {
  let data;
  try {
    const resp = await fetch(`/api/history/${encodeURIComponent(TICKER)}`);
    data = await resp.json();
    if (!resp.ok) {
      document.getElementById('histError').textContent = '⚠ ' + data.error;
      document.getElementById('histError').classList.remove('hidden');
      document.getElementById('peLoading').textContent = I18n.t('history.failed') || 'Failed to load data.';
      return;
    }
  } catch(e) {
    document.getElementById('histError').textContent = '⚠ Network error: ' + e;
    document.getElementById('histError').classList.remove('hidden');
    return;
  }

  // Stat cards
  document.getElementById('stockName').textContent     = data.name || '';
  document.getElementById('statCurrentPe').textContent = data.current_pe  != null ? data.current_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statFwdPe').textContent      = data.forward_pe  != null ? data.forward_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statTarget').textContent     = data.target_price != null ? '$'+data.target_price.toFixed(2) : '—';
  document.getElementById('statEps').textContent        = data.eps          != null ? '$'+data.eps.toFixed(2)          : '—';

  const pegEl = document.getElementById('statCurrentPeg');
  if (data.current_peg != null) {
    pegEl.textContent  = data.current_peg.toFixed(2);
    pegEl.className    = 'text-xl font-bold ' + (data.current_peg < 1 ? 'text-emerald-400' : data.current_peg < 2 ? 'text-amber-400' : 'text-rose-400');
  }

  const upsideEl = document.getElementById('statUpside');
  if (data.target_price != null && data.prices?.length) {
    const lastPrice = data.prices.filter(p => p != null).at(-1);
    if (lastPrice) {
      const upside = (data.target_price - lastPrice) / lastPrice * 100;
      upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(1) + '%';
      upsideEl.className   = 'text-xl font-bold ' + (upside >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }

  function setGrowthStat(elId, val) {
    const el = document.getElementById(elId);
    if (val != null) {
      el.textContent = (val >= 0 ? '+' : '') + val.toFixed(1) + '%';
      el.className   = 'text-sm sm:text-base font-bold ' + (val >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }
  setGrowthStat('statEpsGrowthTtm', data.eps_growth_ttm);
  setGrowthStat('statEpsGrowthQ',   data.eps_growth_q);

  const evEl = document.getElementById('statEvEbitda');
  if (data.ev_ebitda != null) {
    evEl.textContent = data.ev_ebitda.toFixed(1) + 'x';
    evEl.className   = 'text-sm sm:text-base font-bold text-slate-100';
  }

  const evBEl = document.getElementById('statEv');
  if (data.ev != null) {
    evBEl.textContent = '$' + data.ev.toFixed(1) + 'B';
    evBEl.className   = 'text-sm sm:text-base font-bold text-slate-100';
  }

  const ebitdaEl = document.getElementById('statEbitda');
  if (data.ebitda != null) {
    ebitdaEl.textContent = '$' + data.ebitda.toFixed(1) + 'B';
    ebitdaEl.className   = 'text-sm sm:text-base font-bold text-slate-100';
  }

  const pcEl    = document.getElementById('statPutCallRatio');
  const pcLabel = document.getElementById('statPutCallLabel');
  if (data.put_call_ratio != null) {
    const pcr = data.put_call_ratio;
    pcEl.textContent = pcr.toFixed(2);
    if (pcr > 1.2) {
      pcEl.className = 'text-base font-bold text-rose-400';
      pcLabel.textContent = 'Bearish';
      pcLabel.className = 'text-[10px] mt-0.5 text-rose-500';
    } else if (pcr < 0.7) {
      pcEl.className = 'text-base font-bold text-emerald-400';
      pcLabel.textContent = 'Bullish';
      pcLabel.className = 'text-[10px] mt-0.5 text-emerald-600';
    } else {
      pcEl.className = 'text-base font-bold text-amber-400';
      pcLabel.textContent = 'Neutral';
      pcLabel.className = 'text-[10px] mt-0.5 text-amber-600';
    }
  }

  // Annual Financials table — fetched async from dedicated endpoint
  (async () => {
    try {
      const resp = await fetch(`/api/financials/${encodeURIComponent(TICKER)}`);
      const fdata = await resp.json();
      if (fdata.financials_table && fdata.financials_table.length > 0) {
        document.getElementById('financialsSection').style.display = 'block';
        const rows = fdata.financials_table;
    const METRICS = [
      { key: 'revenue',     label: 'Revenue ($B)',     est_key: 'revenue_est' },
      { key: 'gross_profit',label: 'Gross Profit ($B)',est_key: null },
      { key: 'ebitda_is',   label: 'EBITDA ($B)',      est_key: null },
      { key: 'net_income',  label: 'Net Income ($B)',  est_key: null },
      { key: 'eps_diluted', label: 'EPS (Diluted)',    est_key: 'eps_est' },
    ];
    // Header
    const thead = document.getElementById('financialsHead');
    const yearCols = rows.map(r => `<th class="py-2 px-3 text-right text-xs font-semibold ${r.is_estimate ? 'text-sky-400' : 'text-slate-400'} whitespace-nowrap">
      ${r.year}${r.is_estimate ? '<span class="ml-1 text-[9px] text-sky-600 align-middle">EST</span>' : ''}
    </th>`).join('');
    thead.innerHTML = `<tr class="border-b border-slate-800"><th class="py-2 px-3 text-left text-xs text-slate-500 font-medium">Metric</th>${yearCols}</tr>`;
    // Body
    const tbody = document.getElementById('financialsBody');
    const fmt = (v, isEps) => v == null ? '<span class="text-slate-700">—</span>' : (isEps ? v.toFixed(2) : v.toFixed(2));
    tbody.innerHTML = METRICS.map((m, mi) => {
      const cells = rows.map(r => {
        const isEst = r.is_estimate;
        const val = isEst ? (r[m.est_key] ?? r[m.key]) : r[m.key];
        const cls = isEst ? 'text-sky-300 font-medium' : 'text-slate-200';
        return `<td class="py-2.5 px-3 text-right font-mono text-sm ${cls}">${fmt(val, m.key === 'eps_diluted')}</td>`;
      }).join('');
      const rowBg = mi % 2 === 0 ? '' : 'bg-slate-800/20';
      return `<tr class="border-b border-slate-800/40 ${rowBg}">
        <td class="py-2.5 px-3 text-xs text-slate-400 font-medium whitespace-nowrap">${m.label}</td>${cells}
      </tr>`;
    }).join('');
      }
    } catch(e) {
      console.warn('Financials fetch failed:', e);
    }
  })();

  // EV/EBITDA panel
  if (data.ev_ebitda != null || data.ev != null || data.ebitda != null) {
    document.getElementById('evEbitdaSection').style.display = 'block';
    if (data.ev_ebitda != null) {
      const v = data.ev_ebitda;
      document.getElementById('evEbitdaVal').textContent = v.toFixed(1) + 'x';
      const band = v < 8
        ? { label: '便宜 (Cheap)',                    cls: 'text-emerald-400' }
        : v < 13
        ? { label: '正常 (Fair)',                     cls: 'text-sky-400' }
        : v < 20
        ? { label: '成长型 (Growth)',                  cls: 'text-amber-400' }
        : { label: '高增长或泡沫 (High growth / Bubble)', cls: 'text-rose-400' };
      const bandEl = document.getElementById('evEbitdaBand');
      bandEl.textContent = band.label;
      bandEl.className   = 'text-xs mt-0.5 ' + band.cls;
    }
    if (data.ev != null)     document.getElementById('evVal').textContent     = '$' + data.ev.toFixed(1) + 'B';
    if (data.ebitda != null) document.getElementById('ebitdaVal').textContent = '$' + data.ebitda.toFixed(1) + 'B';
  }

  // Cache 1y data and static reference values (target, walls, current_pe)
  _periodCache['1y'] = data;
  const staticData = {
    current_pe:   data.current_pe,
    forward_pe:   data.forward_pe,
    target_price: data.target_price,
    call_wall:    data.call_wall,
    put_wall:     data.put_wall,
  };
  _staticData = staticData;

  // ── PE chart (only when data available)
  if (data.pe_history && data.pe_history.some(v => v != null)) {
    document.getElementById('peLoading').style.display = 'none';
    document.getElementById('peChartWrap').style.display = 'block';
    const peCfg = _buildConfig('pe', data, staticData);
    _registerChart('pe', peCfg, new Chart(document.getElementById('peChart'), peCfg));
  } else {
    document.getElementById('peLoading').style.display = 'none';
  }

  // ── Price chart
  document.getElementById('priceChartWrap').style.display = 'block';
  if (data.target_price != null) document.getElementById('legendTarget').style.display   = 'flex';
  if (data.call_wall    != null) document.getElementById('legendCallWall').style.display = 'flex';
  if (data.put_wall     != null) document.getElementById('legendPutWall').style.display  = 'flex';

  const prCfg = _buildConfig('price', data, staticData);
  _registerChart('price', prCfg, new Chart(document.getElementById('priceHistChart'), prCfg));

  // ── PEG history chart (only when data available)
  if (data.peg_history && data.peg_history.some(v => v != null)) {
    document.getElementById('pegHistSection').style.display = 'block';
    const pgCfg = _buildConfig('peg', data, staticData);
    _registerChart('peg', pgCfg, new Chart(document.getElementById('pegHistChart'), pgCfg));
  }

  // ── Forward PE chart (only when fwd_pe_history data is available)
  if (data.fwd_pe_history && data.fwd_pe_history.some(v => v != null)) {
    document.getElementById('fwdPeHistSection').style.display = 'block';
    const fwdCfg = _buildConfig('fwdpe', data, staticData);
    _registerChart('fwdpe', fwdCfg, new Chart(document.getElementById('fwdPeChart'), fwdCfg));
  }

  // ── P/C ratio by expiry bar chart
  if (data.pc_by_expiry && data.pc_by_expiry.length > 0) {
    document.getElementById('pcChartSection').style.display = 'block';
    const pcLabels = data.pc_by_expiry.map(d => d.exp);
    const pcRatios = data.pc_by_expiry.map(d => d.ratio);
    const pcColors = pcRatios.map(r =>
      r == null       ? 'rgba(100,116,139,0.5)'
      : r > 1.2       ? 'rgba(239,68,68,0.65)'
      : r < 0.7       ? 'rgba(52,211,153,0.65)'
      :                  'rgba(251,191,36,0.65)'
    );
    const pcBorders = pcRatios.map(r =>
      r == null       ? '#64748b'
      : r > 1.2       ? '#ef4444'
      : r < 0.7       ? '#34d399'
      :                  '#fbbf24'
    );
    new Chart(document.getElementById('pcByExpiryChart'), {
      type: 'bar',
      data: {
        labels: pcLabels,
        datasets: [
          {
            label: 'P/C Ratio',
            data: pcRatios,
            backgroundColor: pcColors,
            borderColor: pcBorders,
            borderWidth: 1,
            borderRadius: 3,
            order: 1,
          },
          {
            label: '1.2 (Bearish)',
            data: pcLabels.map(() => 1.2),
            type: 'line',
            borderColor: 'rgba(239,68,68,0.45)',
            borderWidth: 1,
            borderDash: [4,3],
            pointRadius: 0,
            fill: false,
            order: 0,
          },
          {
            label: '0.7 (Bullish)',
            data: pcLabels.map(() => 0.7),
            type: 'line',
            borderColor: 'rgba(52,211,153,0.45)',
            borderWidth: 1,
            borderDash: [4,3],
            pointRadius: 0,
            fill: false,
            order: 0,
          },
        ],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#94a3b8', font: { size: 11 }, boxWidth: 12 } },
          tooltip: { callbacks: {
            label: c => c.dataset.label === 'P/C Ratio'
              ? (c.raw == null ? 'N/A' : ` P/C: ${c.raw.toFixed(2)}`)
              : ` ${c.dataset.label}`,
          }},
        },
        scales: {
          x: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', maxRotation: 45, font: { size: 10 } } },
          y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', font: { size: 11 } },
               title: { display: true, text: 'P/C Ratio', color: '#64748b', font: { size: 11 } } },
        },
      },
    });
  }

  // ── Wire up range buttons
  document.querySelectorAll('.range-btn[data-chart]').forEach(btn => {
    btn.addEventListener('click', () => _handleRange(btn.dataset.chart, btn.dataset.period, staticData));
  });

  // ── Forecast chart (async, non-blocking)
  (function() {
    const loading  = document.getElementById('forecastLoading');
    const wrap     = document.getElementById('forecastChartWrap');
    const statusEl = document.getElementById('forecastModelStatus');
    if (!loading || !wrap) return;

    fetch(`/api/forecast/${encodeURIComponent(TICKER)}`)
      .then(r => r.json())
      .then(result => {
        loading.style.display = 'none';
        if (result.error) {
          loading.textContent = (I18n.t('forecast.failed') || 'Forecast unavailable.') + ' ' + result.error;
          loading.style.display = '';
          return;
        }
        // Build & render chart
        const cfg = _buildConfig('forecast', result, staticData);
        _forecastResult = result;
        _chartConfigs['forecast'] = cfg;
        wrap.style.display = '';
        _chartInstances['forecast'] = new Chart(document.getElementById('forecastChart'), cfg);

        // Per-model status chips
        const models = { prophet: '#a78bfa', arima: '#fb923c', linear: '#34d399' };
        const chips = Object.entries(models).map(([m, col]) => {
          const err = result[m]?.error;
          const pts = (result[m]?.forecast || []).length;
          if (err) {
            return `<span class="flex items-center gap-1" style="color:#64748b">
                      <span class="w-2 h-2 rounded-full bg-slate-600"></span>
                      ${I18n.t('forecast.' + m) || m}: <em>${I18n.t('forecast.model_error') || 'unavailable'}</em>
                    </span>`;
          }
          return `<span class="flex items-center gap-1" style="color:${col}">
                    <span class="w-2 h-2 rounded-full" style="background:${col}"></span>
                    ${I18n.t('forecast.' + m) || m}: ${pts} pts
                  </span>`;
        });
        statusEl.innerHTML = chips.join('');
        statusEl.classList.remove('hidden');
        statusEl.classList.add('flex');
      })
      .catch(err => {
        loading.style.display = '';
        loading.textContent = (I18n.t('forecast.failed') || 'Forecast unavailable.') + ' ' + err.message;
      });
  })();

  // ── Institutional holdings (13F) — multi-quarter
  (function() {
    const section = document.getElementById('instHoldersSection');
    const thead   = document.getElementById('instHoldersHead');
    const tbody   = document.getElementById('instHoldersBody');
    if (!section) return;

    fetch(`/api/13f/ticker/${encodeURIComponent(TICKER)}`)
      .then(r => r.json())
      .then(json => {
        const holders = (json.holders || []).filter(h => h.quarters && h.quarters.length > 0);
        if (!holders.length) return;
        section.style.display = 'block';

        // Collect all unique periods across all funds, sorted newest→oldest
        const periodSet = new Set();
        holders.forEach(h => h.quarters.forEach(q => periodSet.add(q.period)));
        const periods = [...periodSet].sort((a, b) => b.localeCompare(a));

        // ── Grouped bar chart: shares held per fund per quarter ─────────────
        const COLORS = [
          '#818cf8','#34d399','#f472b6','#fb923c','#38bdf8',
          '#a3e635','#c084fc','#fbbf24','#2dd4bf','#f87171',
        ];
        const chartCtx = document.getElementById('instSharesChart');
        if (chartCtx) {
          const datasets = holders.slice(0, 10).map((h, i) => ({
            label: h.fund,
            data: periods.map(p => {
              const q = h.quarters.find(q => q.period === p);
              return q ? q.shares : 0;
            }),
            backgroundColor: COLORS[i % COLORS.length] + '99',
            borderColor:     COLORS[i % COLORS.length],
            borderWidth: 1,
          }));
          new Chart(chartCtx, {
            type: 'bar',
            data: { labels: periods.map(p => p.slice(0,7)), datasets },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: {
                legend: { labels: { color: '#94a3b8', font: { size: 11 } } },
                tooltip: { callbacks: {
                  label: c => ` ${c.dataset.label}: ${c.raw.toLocaleString()} shares`
                }},
              },
              scales: {
                x: { stacked: false, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } },
                y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8',
                  callback: v => v >= 1e9 ? (v/1e9).toFixed(1)+'B' :
                                 v >= 1e6 ? (v/1e6).toFixed(1)+'M' :
                                 v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v } },
              },
            },
          });
        }

        // ── Table: fund | Q1 shares/value/chg | Q2 | Q3 | Q4 ───────────────
        const changeBadge = (chg, pct) => {
          if (chg === 'new')       return `<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold bg-emerald-900/50 text-emerald-300 border border-emerald-800">New</span>`;
          if (chg === 'increased') return `<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold bg-sky-900/50 text-sky-300 border border-sky-800">▲</span>${pct != null ? `<span class="text-sky-400 text-[10px] font-mono ml-0.5">+${pct}%</span>` : ''}`;
          if (chg === 'reduced')   return `<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold bg-amber-900/50 text-amber-300 border border-amber-800">▼</span>${pct != null ? `<span class="text-amber-400 text-[10px] font-mono ml-0.5">${pct}%</span>` : ''}`;
          if (chg === 'closed')    return `<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold bg-rose-900/50 text-rose-300 border border-rose-800">Closed</span>`;
          return `<span class="text-slate-600 text-xs">—</span>`;
        };

        // Header: Fund | period1 (×2 cols: shares, $M) | period2 ...
        thead.innerHTML = `<tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
          <th class="text-left py-2 px-3 font-medium">Fund</th>
          ${periods.map(p => `
            <th class="text-right py-2 px-3 font-medium whitespace-nowrap" colspan="3">${p.slice(0,7)}</th>
          `).join('')}
        </tr>
        <tr class="text-xs text-slate-600 border-b border-slate-800 select-none">
          <th></th>
          ${periods.map(() => `
            <th class="text-right py-1 px-3 font-medium">Shares</th>
            <th class="text-right py-1 px-3 font-medium">Value ($M)</th>
            <th class="text-center py-1 px-3 font-medium">Chg</th>
          `).join('')}
        </tr>`;

        const maxVal = Math.max(...holders.map(h => h.value_millions), 0.01);
        tbody.innerHTML = holders.map(h => {
          const t = Math.min(h.value_millions / maxVal, 1);
          const bg = `rgba(99,102,241,${(0.04 + t * 0.22).toFixed(2)})`;
          const bl = `rgba(99,102,241,${(0.15 + t * 0.55).toFixed(2)})`;
          const tc = t > 0.5 ? '#a5b4fc' : '#94a3b8';
          const cells = periods.map(p => {
            const q = h.quarters.find(q => q.period === p);
            if (!q) return `<td class="py-2 px-3 text-right text-slate-700 text-xs">—</td>
                            <td class="py-2 px-3 text-right text-slate-700 text-xs">—</td>
                            <td class="py-2 px-3"></td>`;
            return `<td class="py-2 px-3 text-right font-mono text-xs text-slate-300">${q.shares.toLocaleString()}</td>
                    <td class="py-2 px-3 text-right font-mono text-xs font-semibold" style="color:${tc}">$${q.value_millions.toFixed(1)}M</td>
                    <td class="py-2 px-3 text-center text-xs">${changeBadge(q.change, q.change_pct)}</td>`;
          }).join('');
          return `<tr class="border-b border-slate-800/40 transition" style="background:${bg};border-left:3px solid ${bl}">
            <td class="py-2.5 px-3 font-medium text-sm whitespace-nowrap" style="color:${tc}">${h.fund}</td>
            ${cells}
          </tr>`;
        }).join('');
      })
      .catch(err => console.warn('13F fetch failed:', err));
  })();
})();

// ── Chart config builder, range handler, modal ───────────────────────────────

function _registerChart(key, cfg, instance) {
  _chartConfigs[key]   = cfg;
  _chartInstances[key] = instance;
}

// Fetch + cache period data
async function _fetchPeriod(period) {
  if (_periodCache[period]) return _periodCache[period];
  const resp = await fetch(`/api/history/${encodeURIComponent(TICKER)}?period=${period}`);
  const d = await resp.json();
  if (!resp.ok) throw new Error(d.error || 'Failed');
  _periodCache[period] = d;
  return d;
}

// Update active state for range buttons of a given chart key
function _setActiveBtn(chartKey, period) {
  document.querySelectorAll(`.range-btn[data-chart="${chartKey}"]`).forEach(b => {
    b.classList.toggle('active', b.dataset.period === period);
  });
}

// Build a fresh Chart.js config from fetched data for a given chart key
function _buildConfig(key, d, staticData) {
  const gridCol = '#1e293b', tickCol = '#64748b';
  if (key === 'pe') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'PE (TTM)', data:d.pe_history,
        borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.08)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` PE: ${c.raw?.toFixed(1)}x`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>v+'x'}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          // Average PE line
          const vals = d.pe_history.filter(v => v != null);
          if (vals.length) {
            const avg = vals.reduce((s,v) => s+v, 0) / vals.length;
            const ay = y.getPixelForValue(avg);
            if (ay >= a.top && ay <= a.bottom) {
              c.save(); c.strokeStyle='rgba(148,163,184,0.5)'; c.lineWidth=1; c.setLineDash([4,4]);
              c.beginPath(); c.moveTo(a.left,ay); c.lineTo(a.right,ay); c.stroke();
              c.fillStyle='#94a3b8'; c.font='11px Inter,sans-serif';
              c.fillText('Avg '+avg.toFixed(1)+'x', a.left+6, ay+12); c.restore();
            }
          }
          // Current PE line
          const pe = staticData.current_pe;
          if (pe == null) return;
          const py = y.getPixelForValue(pe);
          if (py < a.top || py > a.bottom) return;
          c.save(); c.strokeStyle='#f59e0b88'; c.lineWidth=1.5; c.setLineDash([5,4]);
          c.beginPath(); c.moveTo(a.left,py); c.lineTo(a.right,py); c.stroke();
          c.fillStyle='#f59e0b'; c.font='11px Inter,sans-serif';
          c.fillText('Current PE '+pe.toFixed(1)+'x', a.left+6, py-5); c.restore();
        }
      }],
      _title: 'PE Ratio', _desc: 'Estimated from closing price ÷ TTM EPS',
    };
  }
  if (key === 'price') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'Price', data:d.prices,
        borderColor:'#38bdf8', backgroundColor:'rgba(56,189,248,0.07)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` $${c.raw?.toFixed(2)}`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>'$'+v}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          function drawRef(price, sc, lc, label, off) {
            if (price == null) return;
            const py = y.getPixelForValue(price);
            if (py < a.top || py > a.bottom) return;
            c.save(); c.strokeStyle=sc; c.lineWidth=1.5; c.setLineDash([5,4]);
            c.beginPath(); c.moveTo(a.left,py); c.lineTo(a.right,py); c.stroke();
            c.fillStyle=lc; c.font='11px Inter,sans-serif';
            c.fillText(label, a.left+6, py+off); c.restore();
          }
          drawRef(staticData.target_price,'#34d39988','#34d399','Target $'+staticData.target_price?.toFixed(2),-5);
          drawRef(staticData.call_wall,   '#f59e0b88','#f59e0b','Call Wall $'+staticData.call_wall?.toFixed(2),-5);
          drawRef(staticData.put_wall,    '#f43f5e88','#f43f5e','Put Wall $'+staticData.put_wall?.toFixed(2),12);
        }
      }],
      _title: 'Price', _desc: 'Closing price (USD)',
    };
  }
  if (key === 'peg') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'PEG', data:d.peg_history,
        borderColor:'#34d399', backgroundColor:'rgba(52,211,153,0.07)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` PEG: ${c.raw?.toFixed(2)}`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>v.toFixed(1)}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          [1,2].forEach((ref,i) => {
            const py = y.getPixelForValue(ref);
            if (py < a.top || py > a.bottom) return;
            c.save(); c.strokeStyle=i===0?'#f59e0b88':'#f43f5e66'; c.lineWidth=1.5; c.setLineDash([5,4]);
            c.beginPath(); c.moveTo(a.left,py); c.lineTo(a.right,py); c.stroke();
            c.fillStyle=i===0?'#f59e0b':'#f43f5e'; c.font='11px Inter,sans-serif';
            c.fillText('PEG = '+ref, a.left+6, py-5); c.restore();
          });
        }
      }],
      _title: 'PEG Ratio', _desc: 'Estimated from PE ÷ annual earnings growth rate',
    };
  }
  if (key === 'fwdpe') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'Forward PE', data:d.fwd_pe_history,
        borderColor:'#a78bfa', backgroundColor:'rgba(167,139,250,0.08)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` Fwd PE: ${c.raw?.toFixed(1)}x`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>v+'x'}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          // Average Forward PE line
          const vals = d.fwd_pe_history.filter(v => v != null);
          if (vals.length) {
            const avg = vals.reduce((s,v) => s+v, 0) / vals.length;
            const ay = y.getPixelForValue(avg);
            if (ay >= a.top && ay <= a.bottom) {
              c.save(); c.strokeStyle='rgba(148,163,184,0.5)'; c.lineWidth=1; c.setLineDash([4,4]);
              c.beginPath(); c.moveTo(a.left,ay); c.lineTo(a.right,ay); c.stroke();
              c.fillStyle='#94a3b8'; c.font='11px Inter,sans-serif';
              c.fillText('Avg '+avg.toFixed(1)+'x', a.left+6, ay+12); c.restore();
            }
          }
          // Current forward PE reference line
          const fpe = staticData.forward_pe;
          if (fpe == null) return;
          const fy = y.getPixelForValue(fpe);
          if (fy < a.top || fy > a.bottom) return;
          c.save(); c.strokeStyle='#f59e0b88'; c.lineWidth=1.5; c.setLineDash([5,4]);
          c.beginPath(); c.moveTo(a.left,fy); c.lineTo(a.right,fy); c.stroke();
          c.fillStyle='#f59e0b'; c.font='11px Inter,sans-serif';
          c.fillText('Current Fwd PE '+fpe.toFixed(1)+'x', a.left+6, fy-5); c.restore();
        }
      }],
      _title: 'Forward PE', _desc: 'Price ÷ consensus forward EPS — shows how the forward valuation multiple has moved',
    };
  }
  if (key === 'pc') {
    const rows = (d.pc_by_expiry || []).filter(r => r.ratio != null);
    const labels = rows.map(r => r.exp);
    const ratios = rows.map(r => r.ratio);
    const colors = ratios.map(v => v > 1.2 ? 'rgba(239,68,68,0.7)' : v < 0.7 ? 'rgba(52,211,153,0.7)' : 'rgba(251,191,36,0.7)');
    const borderColors = ratios.map(v => v > 1.2 ? '#ef4444' : v < 0.7 ? '#34d399' : '#fbbf24');
    const gridCol = '#1e293b', tickCol = '#64748b';
    return {
      type: 'bar',
      data: { labels, datasets: [{ label: 'P/C Ratio', data: ratios,
        backgroundColor: colors, borderColor: borderColors, borderWidth: 1, borderRadius: 3 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { callbacks: {
          label: c => ` P/C: ${c.raw?.toFixed(2)} — ${c.raw > 1.2 ? 'Bearish' : c.raw < 0.7 ? 'Bullish' : 'Neutral'}`
        }}},
        scales: {
          x: { grid: { color: gridCol }, ticks: { color: tickCol, maxRotation: 45, font: { size: 10 } } },
          y: { grid: { color: gridCol }, ticks: { color: tickCol }, min: 0,
               title: { display: true, text: 'Put/Call OI Ratio', color: tickCol, font: { size: 11 } } },
        },
        interaction: { mode: 'index', intersect: false },
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c, chartArea:a, scales:{y}} = chart;
          // Reference line at 1.0
          const y1 = y.getPixelForValue(1.0);
          if (y1 >= a.top && y1 <= a.bottom) {
            c.save(); c.strokeStyle = 'rgba(148,163,184,0.5)'; c.lineWidth = 1; c.setLineDash([4,4]);
            c.beginPath(); c.moveTo(a.left, y1); c.lineTo(a.right, y1); c.stroke();
            c.fillStyle = '#94a3b8'; c.font = '10px Inter,sans-serif';
            c.fillText('Neutral 1.0', a.left + 6, y1 - 4); c.restore();
          }
        }
      }],
      _title: 'Put/Call Ratio by Expiration', _desc: 'Put OI ÷ Call OI per expiration date — above 1.0 = bearish hedging, below 0.7 = bullish',
    };
  }
  // ── Forecast chart config ──────────────────────────────────────────────
  if (key === 'forecast') {
    // d is the full forecast result from /api/forecast
    const gridCol = '#1e293b', tickCol = '#64748b';
    const trainDates  = (d.train  || []).map(p => p.date);
    const trainPrices = (d.train  || []).map(p => p.value);

    // Build combined label array: all training dates + forecast dates from first available model
    const fcModels  = ['prophet', 'arima', 'linear'];
    const firstFC   = fcModels.map(m => d[m]?.forecast || []).find(fc => fc.length > 0) || [];
    const fcDates   = firstFC.map(p => p.date);
    const allDates  = [...trainDates, ...fcDates];

    // Pad actual-price dataset with nulls in the forecast zone
    const actualData = [...trainPrices, ...fcDates.map(() => null)];

    // For each model: pad left with nulls (training zone), then forecast values
    // Also build shaded CI datasets
    function fcDataset(modelKey, color) {
      const fc = d[modelKey]?.forecast || [];
      if (!fc.length) return null;
      // Align to allDates — pad training zone with null, then values
      const padLen = trainDates.length > 0 ? trainDates.length - 1 : 0;
      const fVals  = [...Array(padLen).fill(null), trainPrices[trainPrices.length - 1], ...fc.map(p => p.value)];
      const loVals = [...Array(padLen).fill(null), trainPrices[trainPrices.length - 1], ...fc.map(p => p.lo)];
      const hiVals = [...Array(padLen).fill(null), trainPrices[trainPrices.length - 1], ...fc.map(p => p.hi)];
      return { fVals, loVals, hiVals, color };
    }
    const modelColors = { prophet: '#a78bfa', arima: '#fb923c', linear: '#34d399' };
    const fcSets = {};
    fcModels.forEach(m => { fcSets[m] = fcDataset(m, modelColors[m]); });

    const datasets = [
      // Actual price
      {
        label: I18n.t('forecast.actual') || 'Actual',
        data:  actualData,
        borderColor: '#38bdf8', backgroundColor: 'rgba(56,189,248,0.06)',
        borderWidth: 2, pointRadius: 0, pointHoverRadius: 5, hitRadius: 8,
        fill: 'origin', tension: 0.3, spanGaps: true, order: 10,
        elements: { point: { hitRadius: 8, radius: 0, hoverRadius: 5 } },
      },
    ];

    // Forecast lines (no fill — CI drawn via afterDraw plugin instead)
    const fcAvailable = [];
    fcModels.forEach((m, idx) => {
      const s = fcSets[m];
      if (!s) return;
      fcAvailable.push({ m, s, idx });
      datasets.push({
        label: I18n.t('forecast.' + m) || m.toUpperCase(),
        data: s.fVals,
        borderColor: s.color, backgroundColor: 'transparent',
        borderWidth: 2, pointRadius: 0, pointHoverRadius: 5, hitRadius: 8,
        borderDash: [5, 3], tension: 0.3, spanGaps: true, order: 5 + idx,
        elements: { point: { hitRadius: 8, radius: 0, hoverRadius: 5 } },
      });
    });

    // Vertical divider plugin: draw a line at the train/forecast boundary
    // Also draw CI bands as canvas fills (avoids hitRadius crash from fill: dataset)
    const boundaryIdx = trainDates.length - 1;

    return {
      type: 'line',
      data: { labels: allDates, datasets },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: tickCol, font: { size: 11 },
              filter: item => !(item.label || '').startsWith('__'),
            },
          },
          tooltip: {
            mode: 'index', intersect: false,
            filter: item => !(item.dataset.label || '').startsWith('__'),
            callbacks: { label: c => (c.dataset.label || '').startsWith('__') ? null : ` ${c.dataset.label}: $${c.raw?.toFixed(2)}` },
          },
        },
        scales: {
          x: { grid: { color: gridCol }, ticks: { color: tickCol, maxTicksLimit: 10, maxRotation: 0 } },
          y: { grid: { color: gridCol }, ticks: { color: tickCol, callback: v => '$' + v } },
        },
        interaction: { mode: 'index', intersect: false },
      },
      plugins: [{
        afterDraw(chart) {
          const { ctx: c, chartArea: a, scales: { x, y } } = chart;

          // Draw CI bands as canvas fills per model
          fcAvailable.forEach(({ m, s }) => {
            const col = s.color;
            const loData = s.loVals;
            const hiData = s.hiVals;
            const len = Math.min(loData.length, hiData.length, allDates.length);
            c.save();
            c.beginPath();
            let started = false;
            for (let i = 0; i < len; i++) {
              if (hiData[i] == null) continue;
              const px = x.getPixelForValue(i);
              const py = y.getPixelForValue(hiData[i]);
              if (!started) { c.moveTo(px, py); started = true; }
              else c.lineTo(px, py);
            }
            for (let i = len - 1; i >= 0; i--) {
              if (loData[i] == null) continue;
              const px = x.getPixelForValue(i);
              const py = y.getPixelForValue(loData[i]);
              c.lineTo(px, py);
            }
            c.closePath();
            c.fillStyle = col + '28';
            c.fill();
            c.restore();
          });

          // Vertical boundary line
          if (boundaryIdx < 0 || boundaryIdx >= allDates.length) return;
          const bx = x.getPixelForValue(boundaryIdx);
          if (bx < a.left || bx > a.right) return;
          c.save();
          c.strokeStyle = 'rgba(100,116,139,0.5)';
          c.lineWidth = 1;
          c.setLineDash([4, 4]);
          c.beginPath(); c.moveTo(bx, a.top); c.lineTo(bx, a.bottom); c.stroke();
          c.fillStyle = '#64748b'; c.font = '10px Inter,sans-serif';
          c.fillText('Forecast →', bx + 4, a.top + 12);
          c.restore();
        },
      }],
      _title: 'Price Forecast — 6 Months',
      _desc:  'Prophet / ARIMA / Linear regression with 80% confidence intervals (26-week horizon)',
    };
  }
}

// Handle a range button click: fetch data, rebuild inline chart
async function _handleRange(chartKey, period, staticData) {
  _setActiveBtn(chartKey, period);

  const wrapId  = { pe:'peChartWrap', price:'priceChartWrap', peg:'pegChartWrap', fwdpe:'fwdPeChartWrap' }[chartKey];
  const canvasId = { pe:'peChart', price:'priceHistChart', peg:'pegHistChart', fwdpe:'fwdPeChart' }[chartKey];
  const wrap = document.getElementById(wrapId);

  // Show loading overlay
  let overlay = wrap.querySelector('.chart-loading-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = 'chart-loading-overlay';
    overlay.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);border-radius:8px;z-index:10;';
    overlay.innerHTML = '<svg class="animate-spin" style="width:20px;height:20px;color:#6366f1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';
    wrap.style.position = 'relative';
    wrap.appendChild(overlay);
  } else {
    overlay.style.display = 'flex';
  }

  let d;
  try { d = await _fetchPeriod(period); } catch(e) {
    overlay.style.display = 'none';
    return;
  }

  overlay.style.display = 'none';
  if (_chartInstances[chartKey]) { _chartInstances[chartKey].destroy(); }
  const cfg = _buildConfig(chartKey, d, staticData);
  _chartConfigs[chartKey] = cfg;
  _chartInstances[chartKey] = new Chart(document.getElementById(canvasId), cfg);

  // If modal is open for this chart, refresh it too
  if (_modalKey === chartKey && document.getElementById('chartModal').style.display !== 'none') {
    _renderModal(chartKey, d, staticData);
  }
}

function _renderModal(key, d, staticData) {
  if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
  const cfg = _buildConfig(key, d, staticData);
  _modalChart = new Chart(document.getElementById('modalCanvas'), cfg);
}

function expandChart(key) {
  // For forecast, rebuild from stored API result to avoid Chart.js circular ref issues
  if (key === 'forecast') {
    if (!_forecastResult || !_staticData) return;
    const modal = document.getElementById('chartModal');
    const cfg = _buildConfig('forecast', _forecastResult, _staticData);
    document.getElementById('modalTitle').textContent = cfg._title || '';
    document.getElementById('modalDesc').textContent  = cfg._desc  || '';
    modal.style.display = 'flex';
    if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
    _modalKey = 'forecast';
    _modalChart = new Chart(document.getElementById('modalCanvas'), cfg);
    return;
  }

  const cfg = _chartConfigs[key];
  if (!cfg) return;
  _modalKey = key;
  const modal = document.getElementById('chartModal');
  document.getElementById('modalTitle').textContent = cfg._title || '';
  document.getElementById('modalDesc').textContent  = cfg._desc  || '';
  modal.style.display = 'flex';
  if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
  const plugins = cfg.plugins;
  const clone = JSON.parse(JSON.stringify(cfg, (k, v) => k.startsWith('_') ? undefined : v));
  if (plugins) clone.plugins = plugins;
  _modalChart = new Chart(document.getElementById('modalCanvas'), clone);
}

function closeModal() {
  document.getElementById('chartModal').style.display = 'none';
  if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
  _modalKey = null;
}

document.getElementById('chartModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ── Wall tooltip ─────────────────────────────────────────────────────────────
(function() {
  const tip = document.createElement('div');
  tip.id = 'wallTip';
  tip.style.cssText = [
    'position:fixed','z-index:9999','max-width:280px','padding:8px 12px',
    'background:#0f172a','border:1px solid #334155','border-radius:8px',
    'color:#cbd5e1','font-size:12px','line-height:1.5','pointer-events:none',
    'opacity:0','transition:opacity 0.15s','box-shadow:0 4px 16px rgba(0,0,0,0.5)',
  ].join(';');
  document.body.appendChild(tip);

  let hideTimer;
  document.querySelectorAll('.wall-tip').forEach(el => {
    el.addEventListener('mouseenter', function(e) {
      clearTimeout(hideTimer);
      const key = this.dataset.tipI18n;
      tip.textContent = (key && I18n.t(key)) || this.dataset.tip || '';
      tip.style.opacity = '1';
      positionTip(e);
    });
    el.addEventListener('mousemove', positionTip);
    el.addEventListener('mouseleave', () => {
      hideTimer = setTimeout(() => { tip.style.opacity = '0'; }, 100);
    });
  });

  function positionTip(e) {
    const pad = 12;
    let x = e.clientX + pad;
    let y = e.clientY + pad;
    // keep inside viewport
    const tw = tip.offsetWidth  || 280;
    const th = tip.offsetHeight || 60;
    if (x + tw > window.innerWidth  - pad) x = e.clientX - tw - pad;
    if (y + th > window.innerHeight - pad) y = e.clientY - th - pad;
    tip.style.left = x + 'px';
    tip.style.top  = y + 'px';
  }
})();

// ── Tab switching ─────────────────────────────────────────────────────────────
let _newsLoaded = false;
let _newsAutoRefresh = null;
let _videosLoaded = false;

function switchTab(tab) {
  const isCharts = tab === 'charts';
  const isNews   = tab === 'news';
  const isVideos = tab === 'videos';
  document.getElementById('panelCharts').style.display = isCharts ? '' : 'none';
  document.getElementById('panelNews').style.display   = isNews   ? '' : 'none';
  document.getElementById('panelVideos').style.display = isVideos ? '' : 'none';

  const chartsBtn = document.getElementById('tabChartsBtn');
  const newsBtn   = document.getElementById('tabNewsBtn');
  const videosBtn = document.getElementById('tabVideosBtn');
  const activeClass   = 'px-4 py-2 text-sm font-medium border-b-2 -mb-px transition border-brand text-brand';
  const inactiveClass = 'px-4 py-2 text-sm font-medium border-b-2 -mb-px transition border-transparent text-slate-400 hover:text-slate-200';
  chartsBtn.className = isCharts ? activeClass : inactiveClass;
  newsBtn.className   = isNews   ? activeClass : inactiveClass;
  videosBtn.className = isVideos ? activeClass : inactiveClass;

  if (isNews) {
    if (!_newsLoaded) loadNews(false);
    // Auto-refresh every 2 minutes while tab is visible
    if (!_newsAutoRefresh) {
      _newsAutoRefresh = setInterval(() => {
        if (document.getElementById('panelNews').style.display !== 'none') loadNews(false);
      }, 2 * 60 * 1000);
    }
  }
  if (isVideos && !_videosLoaded) loadVideos();
}

// ── News feed ─────────────────────────────────────────────────────────────────
async function loadNews(force) {
  if (!force && _newsLoaded) return;
  if (force) _newsLoaded = false;
  const statusEl = document.getElementById('newsStatus');
  const feedEl   = document.getElementById('newsFeed');
  statusEl.textContent = I18n.t('history.news_loading') || 'Fetching news…';
  statusEl.className   = 'text-slate-500 text-sm animate-pulse';

  let data;
  try {
    const url = `/api/news/${encodeURIComponent(TICKER)}` + (force ? `?force=1` : '');
    const resp = await fetch(url);
    data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Failed');
  } catch(e) {
    statusEl.textContent = (I18n.t('history.news_error') || 'Failed to load news.') + ' ' + e.message;
    statusEl.className   = 'text-red-400 text-sm';
    return;
  }

  _newsLoaded = true;
  const articles = data.articles || [];

  if (!articles.length) {
    statusEl.textContent = I18n.t('history.news_empty') || 'No news found.';
    statusEl.className   = 'text-slate-500 text-sm';
    feedEl.innerHTML = '';
    document.getElementById('newsTimeline').style.display = 'none';
    return;
  }

  statusEl.textContent = `${articles.length} articles`;
  statusEl.className   = 'text-slate-500 text-sm';

  // ── Build article IDs and render feed ──────────────────────────────────────
  feedEl.innerHTML = articles.map((a, i) => _renderArticle(a, i)).join('');

  // ── Build timeline scrubber ────────────────────────────────────────────────
  _buildTimeline(articles);

  // ── AI Translation (Chinese mode only) ─────────────────────────────────────
  if (I18n.getLang() === 'zh') {
    _translateNews(articles, feedEl, statusEl);
  }
}

function _buildTimeline(articles) {
  // Group article indices by calendar date label
  const groups = [];  // [{label, dateStr, indices:[]}]
  const byDate  = {};
  articles.forEach((a, i) => {
    const label = _dateLabel(a.published);
    if (!byDate[label]) { byDate[label] = { label, indices: [] }; groups.push(byDate[label]); }
    byDate[label].indices.push(i);
  });

  const bar = document.getElementById('timelineBar');
  bar.innerHTML = '';

  // Compute relative widths: more articles on a day = wider segment
  const maxCount = Math.max(...groups.map(g => g.indices.length));

  groups.forEach((g, gi) => {
    const btn = document.createElement('button');
    // Width proportional to article count, min 40px
    const pct  = Math.max(40, Math.round(g.indices.length / maxCount * 120));
    btn.id = `tlBtn-${gi}`;
    btn.style.cssText = `min-width:${pct}px; flex-shrink:0`;
    btn.className = 'tl-seg relative flex flex-col items-center gap-0.5 px-2 py-1.5 rounded-lg border ' +
      'border-slate-700 bg-slate-800/60 hover:border-slate-500 hover:bg-slate-700/60 transition text-left cursor-pointer';
    btn.innerHTML =
      `<span class="text-[10px] font-semibold text-slate-300 whitespace-nowrap">${_escHtml(g.label)}</span>` +
      `<span class="text-[9px] text-slate-500">${g.indices.length} art.</span>` +
      // Mini bar showing count
      `<div class="w-full mt-0.5 h-1 rounded-full bg-slate-700 overflow-hidden">` +
        `<div class="h-full rounded-full bg-indigo-500/70" style="width:${Math.round(g.indices.length / maxCount * 100)}%"></div>` +
      `</div>`;

    btn.addEventListener('click', () => {
      // Scroll to first article in this group
      const el = document.getElementById(`newsItem-${g.indices[0]}`);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Highlight active segment
      document.querySelectorAll('.tl-seg').forEach(b => {
        b.classList.toggle('border-indigo-500', b === btn);
        b.classList.toggle('bg-indigo-900/30', b === btn);
        b.classList.toggle('border-slate-700', b !== btn);
        b.classList.toggle('bg-slate-800/60',  b !== btn);
      });
    });

    bar.appendChild(btn);
  });

  document.getElementById('newsTimeline').style.display = 'block';
}

function _dateLabel(ts) {
  if (!ts) return '—';
  const d = new Date(ts * 1000);
  const now = new Date();
  const diffDays = Math.floor((now - d) / 86400000);
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}

function _timeAgo(ts) {
  if (!ts) return '';
  const diff = Math.floor(Date.now() / 1000) - ts;
  if (diff < 60)         return I18n.t('history.news_just_now') || 'just now';
  if (diff < 3600)       return Math.floor(diff / 60)   + (I18n.t('history.news_min_ago') || 'm ago');
  if (diff < 86400)      return Math.floor(diff / 3600)  + (I18n.t('history.news_hr_ago')  || 'h ago');
  return Math.floor(diff / 86400) + (I18n.t('history.news_day_ago') || 'd ago');
}

function _renderArticle(a, idx) {
  const importantBadge = a.important
    ? `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold
                   bg-amber-900/50 text-amber-300 border border-amber-800 ml-1 align-middle">${I18n.t('history.news_important') || 'Important'}</span>`
    : '';
  const thumb = a.thumbnail
    ? `<img src="${_escAttr(a.thumbnail)}" alt="" class="w-16 h-16 object-cover rounded-lg flex-shrink-0 opacity-80"
             onerror="this.style.display='none'">`
    : '';
  const timeAgo = _timeAgo(a.published);
  const meta = [a.publisher, timeAgo].filter(Boolean).join(' · ');

  return `
<a id="newsItem-${idx}" href="${_escAttr(a.link)}" target="_blank" rel="noopener noreferrer"
   class="flex gap-3 items-start bg-slate-900 border ${a.important ? 'border-amber-800/60' : 'border-slate-800'}
          rounded-xl p-3 sm:p-4 hover:border-slate-600 hover:bg-slate-800/60 transition group">
  ${thumb}
  <div class="flex-1 min-w-0">
    <p class="text-sm font-medium text-slate-200 group-hover:text-white leading-snug line-clamp-2">
      ${_escHtml(a.title)}${importantBadge}
    </p>
    ${a.summary ? `<p class="text-xs text-slate-500 mt-1 line-clamp-2">${_escHtml(a.summary)}</p>` : ''}
    <p class="text-xs text-slate-600 mt-1.5">${_escHtml(meta)}</p>
  </div>
  <svg class="w-4 h-4 text-slate-600 group-hover:text-slate-400 flex-shrink-0 mt-0.5 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
  </svg>
</a>`;
}

function _escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function _escAttr(s) {
  if (!s) return '#';
  return s.replace(/"/g,'%22').replace(/'/g,'%27');
}

// ── AI news translation (Chinese mode) ───────────────────────────────────────
async function _translateNews(articles, feedEl, statusEl) {
  if (!articles.length) return;

  // Show subtle translating indicator
  const origStatus = statusEl.textContent;
  statusEl.textContent = origStatus + ' · ' + (I18n.t('history.news_translating') || 'Translating…');

  const payload = articles.map(a => ({ link: a.link, title: a.title, summary: a.summary || null }));

  let data;
  try {
    const resp = await fetch('/api/news/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ articles: payload, lang: 'zh' }),
    });
    data = await resp.json();
    if (!resp.ok || data.error) throw new Error(data.error || 'Failed');
  } catch(e) {
    statusEl.textContent = origStatus + ' · ' + (I18n.t('history.news_trans_fail') || 'Translation unavailable');
    return;
  }

  const transMap = {};
  (data.translations || []).forEach(t => { if (t.link) transMap[t.link] = t; });

  // Patch the DOM in-place for each article
  articles.forEach((a, i) => {
    const t = transMap[a.link];
    if (!t) return;
    const el = document.getElementById(`newsItem-${i}`);
    if (!el) return;

    // Update title
    const titleEl = el.querySelector('p.text-sm');
    if (titleEl && t.title_zh) {
      // Preserve the important badge if present
      const badge = titleEl.querySelector('span');
      titleEl.textContent = t.title_zh;
      if (badge) titleEl.appendChild(badge);
    }

    // Update summary
    const summaryEl = el.querySelector('p.text-xs.text-slate-500');
    if (summaryEl && t.summary_zh) {
      summaryEl.textContent = t.summary_zh;
    }
  });

  // Update status with AI attribution badge
  statusEl.innerHTML =
    `${_escHtml(String(articles.length) + ' ' + (I18n.t('th.name') ? '' : 'articles'))} ` +
    `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ` +
    `bg-indigo-900/40 text-indigo-300 border border-indigo-800 ml-1">✦ ${_escHtml(I18n.t('history.news_translated') || 'Translated by AI')}</span>`;
}

// ── YouTube videos ────────────────────────────────────────────────────────────
async function loadVideos() {
  const statusEl = document.getElementById('videosStatus');
  const feedEl   = document.getElementById('videosFeed');
  const ytLink   = document.getElementById('videosYtLink');

  // YouTube search URL (past week filter) for the "Open on YouTube" link
  const ytQuery = encodeURIComponent(TICKER + ' stock');
  // sp=EgIIAg%3D%3D is the "This week" upload date filter
  ytLink.href = `https://www.youtube.com/results?search_query=${ytQuery}&sp=EgIIAg%3D%3D`;

  statusEl.textContent = I18n.t('history.videos_loading') || 'Fetching videos…';
  statusEl.className   = 'text-slate-500 text-sm animate-pulse';
  feedEl.innerHTML     = '';

  let data;
  try {
    const resp = await fetch(`/api/videos/${encodeURIComponent(TICKER)}`);
    data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Failed');
  } catch(e) {
    statusEl.textContent = (I18n.t('history.videos_error') || 'Failed to load videos.') + ' ' + e.message;
    statusEl.className   = 'text-red-400 text-sm';
    return;
  }

  _videosLoaded = true;
  const videos = data.videos || [];

  if (data.note) {
    // API key not configured — show a prompt to search on YouTube directly
    statusEl.textContent = '';
    feedEl.innerHTML =
      `<div class="col-span-full text-slate-500 text-sm py-6 text-center">
         No <code class="text-slate-400">YOUTUBE_API_KEY</code> configured —
         <a href="${ytLink.href}" target="_blank" rel="noopener"
            class="text-indigo-400 hover:text-indigo-300 underline">search YouTube directly ↗</a>
       </div>`;
    return;
  }

  if (!videos.length) {
    statusEl.textContent = I18n.t('history.videos_empty') || 'No videos found.';
    statusEl.className   = 'text-slate-500 text-sm';
    return;
  }

  statusEl.textContent = `${videos.length} videos`;
  statusEl.className   = 'text-slate-500 text-sm';
  feedEl.innerHTML = videos.map(v => _renderVideo(v)).join('');
  I18n.apply(feedEl);
}

function _renderVideo(v) {
  const ago = _timeAgo(v.published);
  const meta = [v.channel, ago].filter(Boolean).join(' · ');
  return `
<a href="https://www.youtube.com/watch?v=${_escAttr(v.id)}" target="_blank" rel="noopener noreferrer"
   class="flex flex-col bg-slate-900 border border-slate-800 rounded-xl overflow-hidden
          hover:border-slate-600 hover:bg-slate-800/60 transition group">
  <div class="relative w-full" style="padding-top:56.25%">
    <img src="https://i.ytimg.com/vi/${_escAttr(v.id)}/hqdefault.jpg" alt=""
         class="absolute inset-0 w-full h-full object-cover opacity-90 group-hover:opacity-100 transition"
         onerror="this.src='https://i.ytimg.com/vi/${_escAttr(v.id)}/mqdefault.jpg'">
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="w-10 h-10 rounded-full bg-black/60 flex items-center justify-center
                  group-hover:bg-red-600/80 transition">
        <svg class="w-5 h-5 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </div>
    </div>
    ${v.duration ? `<span class="absolute bottom-1.5 right-1.5 text-[10px] font-semibold
                                 bg-black/75 text-white px-1 py-0.5 rounded">${_escHtml(v.duration)}</span>` : ''}
  </div>
  <div class="p-3">
    <p class="text-sm font-medium text-slate-200 group-hover:text-white leading-snug line-clamp-2">
      ${_escHtml(v.title)}
    </p>
    <p class="text-xs text-slate-500 mt-1.5">${_escHtml(meta)}</p>
  </div>
</a>`;
}

// ── Gemini explain hook ───────────────────────────────────────────────────────
// Maps chart key → {btnId, panelId, dataKey}
const _explainMeta = {
  pe:    { btn: 'explainBtnPe',    panel: 'explainPanelPe',    key: 'pe_history'      },
  fwdpe: { btn: 'explainBtnFwdpe', panel: 'explainPanelFwdpe', key: 'fwd_pe_history'  },
  price: { btn: 'explainBtnPrice', panel: 'explainPanelPrice', key: 'prices'          },
  peg:   { btn: 'explainBtnPeg',   panel: 'explainPanelPeg',   key: 'peg_history'     },
};

// Track currently displayed period per chart key (default: 1y)
const _explainPeriod = { pe: '1y', fwdpe: '1y', price: '1y', peg: '1y' };

// Keep _explainPeriod in sync when the user clicks a range button
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.range-btn[data-chart]');
  if (btn) _explainPeriod[btn.dataset.chart] = btn.dataset.period;
});

async function explainChart(chartKey) {
  const meta  = _explainMeta[chartKey];
  if (!meta) return;
  const btn   = document.getElementById(meta.btn);
  const panel = document.getElementById(meta.panel);
  if (!btn || !panel) return;

  // Get the data for the currently shown period
  const period = _explainPeriod[chartKey] || '1y';
  let d;
  try { d = await _fetchPeriod(period); } catch(e) { return; }

  const values = d[meta.key] || [];
  const dates  = d.dates || [];
  if (!values.some(v => v != null)) return;

  // Toggle off if already showing for the same chart
  if (panel.style.display === 'block') {
    panel.style.display = 'none';
    btn.textContent = I18n.t('history.explain');
    return;
  }

  panel.style.display = 'block';
  panel.textContent   = I18n.t('history.explain_thinking');
  btn.classList.add('loading');
  btn.textContent = I18n.t('history.explain_thinking');

  const lang = (typeof I18n !== 'undefined') ? I18n.getLang() : 'en';

  try {
    const resp = await fetch(
      `/api/history/${encodeURIComponent(TICKER)}/explain`,
      {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ chart: chartKey, dates, values, period, lang }),
      }
    );

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      panel.textContent = '⚠ ' + (err.error || 'Failed to get explanation.');
      return;
    }

    panel.textContent = '';
    const reader  = resp.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop(); // keep incomplete line
      for (const line of lines) {
        if (!line.startsWith('data:')) continue;
        const raw = line.slice(5).trim();
        if (raw === '[DONE]') break;
        try {
          const msg = JSON.parse(raw);
          if (msg.error) { panel.textContent += '\n⚠ ' + msg.error; break; }
          if (msg.text)  panel.textContent += msg.text;
        } catch {}
      }
    }
  } catch(e) {
    panel.textContent = '⚠ Network error: ' + e.message;
  } finally {
    btn.classList.remove('loading');
    btn.textContent = panel.textContent ? I18n.t('history.explain_hide') : I18n.t('history.explain');
  }
}
</script>
{% endblock %}
