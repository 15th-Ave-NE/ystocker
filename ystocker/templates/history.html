{% extends "base.html" %}
{% block title %}yStocker — {{ ticker }} PE History{% endblock %}

{% block content %}

<div class="mb-6 sm:mb-8 fade-up">
  <div class="flex items-center gap-3 mb-1">
    <button onclick="history.back()" class="text-slate-500 hover:text-slate-300 text-sm transition" data-i18n="history.back">← Back</button>
    <span class="text-slate-700">/</span>
    <span class="text-slate-300 text-sm font-mono font-semibold">{{ ticker }}</span>
    <a href="https://www.tradingview.com/chart/?symbol={{ ticker }}" target="_blank" rel="noopener"
       class="ml-auto flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
              hover:text-slate-200 hover:border-slate-500 transition px-2.5 py-1 rounded-lg">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
      </svg>
      <span data-i18n="history.tradingview">TradingView</span>
    </a>
  </div>
  <h1 class="text-2xl sm:text-3xl font-bold">
    <span class="font-mono grad-text">{{ ticker }}</span>
    <span id="stockName" class="text-slate-400 text-lg sm:text-xl font-normal ml-2 sm:ml-3"></span>
  </h1>
  <p class="text-slate-500 text-sm mt-1" data-i18n="history.subtitle">1-year historical PE ratio &amp; price (weekly)</p>
</div>

<!-- ── Stat cards ───────────────────────────────────────────────────── -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3 sm:gap-4 mb-6 sm:mb-8 fade-up">
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.current_pe">Current PE</div>
    <div id="statCurrentPe" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.fwd_pe">Forward PE</div>
    <div id="statFwdPe" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.peg_ratio">PEG Ratio</div>
    <div id="statCurrentPeg" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.target_price">Target Price</div>
    <div id="statTarget" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.ttm_eps">TTM EPS</div>
    <div id="statEps" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.upside">Analyst Upside</div>
    <div id="statUpside" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.eps_growth_ttm">EPS Growth TTM</div>
    <div id="statEpsGrowthTtm" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.eps_growth_q">EPS Growth Q</div>
    <div id="statEpsGrowthQ" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
</div>

<!-- ── Charts ────────────────────────────────────────────────────────── -->
<div class="space-y-6">

  <!-- PE history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.pe_title">PE Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.pe_desc">Estimated from weekly closing price ÷ TTM EPS</p>
      </div>
      <div class="flex gap-2 text-xs">
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-brand"></span> <span data-i18n="history.pe_legend">PE (TTM)</span>
        </span>
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-amber-400 border-dashed border"></span> <span data-i18n="history.current_pe_legend">Current PE</span>
        </span>
      </div>
    </div>
    <div id="peLoading" class="flex items-center justify-center h-36 sm:h-48 text-slate-500 text-sm animate-pulse">
      Loading PE history for {{ ticker }} …
    </div>
    <div class="chart-container" style="height:220px; display:none" id="peChartWrap">
      <canvas id="peChart"></canvas>
    </div>
  </div>

  <!-- Price history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.price_title">Price — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.price_desc">Weekly closing price (USD)</p>
      </div>
    </div>
    <div class="chart-container" style="height:200px; display:none" id="priceChartWrap">
      <canvas id="priceHistChart"></canvas>
    </div>
  </div>

  <!-- PEG history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="pegHistSection" style="display:none">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.peg_title">PEG Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.peg_desc">Estimated from weekly PE ÷ annual earnings growth rate</p>
      </div>
      <div class="flex gap-3 text-xs">
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-emerald-400"></span> <span data-i18n="history.peg_legend">PEG</span>
        </span>
        <span class="flex items-center gap-1.5 text-slate-400">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> <span data-i18n="history.peg1_legend">PEG = 1</span>
        </span>
      </div>
    </div>
    <div class="chart-container" style="height:200px" id="pegChartWrap">
      <canvas id="pegHistChart"></canvas>
    </div>
  </div>

</div>

<!-- Institutional Holders (13F) -->
<div id="instHoldersSection" class="mt-6 bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" style="display:none">
  <h2 class="text-base font-semibold text-slate-200 mb-1">Institutional Holdings (13F)</h2>
  <p class="text-xs text-slate-500 mb-4">Funds reporting this position in their latest SEC 13F filing</p>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
          <th class="text-left py-2 px-3 font-medium">Fund</th>
          <th class="text-right py-2 px-3 font-medium">Portfolio Rank</th>
          <th class="text-right py-2 px-3 font-medium">Shares</th>
          <th class="text-right py-2 px-3 font-medium">Value</th>
          <th class="text-right py-2 px-3 font-medium">% of Portfolio</th>
          <th class="text-center py-2 px-3 font-medium">Change</th>
        </tr>
      </thead>
      <tbody id="instHoldersBody"></tbody>
    </table>
  </div>
</div>

<!-- Error -->
<div id="histError" class="hidden mt-4 px-4 py-3 rounded-lg bg-red-900/40 border border-red-700 text-red-300 text-sm"></div>

<script>
const TICKER = {{ ticker | tojson }};

(async function() {
  let data;
  try {
    const resp = await fetch(`/api/history/${encodeURIComponent(TICKER)}`);
    data = await resp.json();
    if (!resp.ok) {
      document.getElementById('histError').textContent = '⚠ ' + data.error;
      document.getElementById('histError').classList.remove('hidden');
      document.getElementById('peLoading').textContent = I18n.t('history.failed') || 'Failed to load data.';
      return;
    }
  } catch(e) {
    document.getElementById('histError').textContent = '⚠ Network error: ' + e;
    document.getElementById('histError').classList.remove('hidden');
    return;
  }

  // Stat cards
  document.getElementById('stockName').textContent     = data.name || '';
  document.getElementById('statCurrentPe').textContent = data.current_pe  != null ? data.current_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statFwdPe').textContent      = data.forward_pe  != null ? data.forward_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statTarget').textContent     = data.target_price != null ? '$'+data.target_price.toFixed(2) : '—';
  document.getElementById('statEps').textContent        = data.eps          != null ? '$'+data.eps.toFixed(2)          : '—';

  const pegEl = document.getElementById('statCurrentPeg');
  if (data.current_peg != null) {
    pegEl.textContent  = data.current_peg.toFixed(2);
    pegEl.className    = 'text-xl font-bold ' + (data.current_peg < 1 ? 'text-emerald-400' : data.current_peg < 2 ? 'text-amber-400' : 'text-rose-400');
  }

  const upsideEl = document.getElementById('statUpside');
  if (data.target_price != null && data.prices?.length) {
    const lastPrice = data.prices.filter(p => p != null).at(-1);
    if (lastPrice) {
      const upside = (data.target_price - lastPrice) / lastPrice * 100;
      upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(1) + '%';
      upsideEl.className   = 'text-xl font-bold ' + (upside >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }

  function setGrowthStat(elId, val) {
    const el = document.getElementById(elId);
    if (val != null) {
      el.textContent = (val >= 0 ? '+' : '') + val.toFixed(1) + '%';
      el.className   = 'text-lg sm:text-xl font-bold ' + (val >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }
  setGrowthStat('statEpsGrowthTtm', data.eps_growth_ttm);
  setGrowthStat('statEpsGrowthQ',   data.eps_growth_q);

  const gridCol = '#1e293b';
  const tickCol = '#64748b';

  // ── PE chart
  document.getElementById('peLoading').style.display = 'none';
  document.getElementById('peChartWrap').style.display = 'block';

  const peCtx = document.getElementById('peChart');
  new Chart(peCtx, {
    type: 'line',
    data: {
      labels: data.dates,
      datasets: [
        {
          label: 'PE (TTM)',
          data: data.pe_history,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99,102,241,0.08)',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          fill: true,
          tension: 0.3,
          spanGaps: true,
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: { label: c => ` PE: ${c.raw?.toFixed(1)}x` }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v+'x'} }
      },
      interaction: { mode:'index', intersect:false },
    },
    plugins: [{
      afterDraw(chart) {
        if (data.current_pe == null) return;
        const {ctx: c, chartArea: a, scales: {y}} = chart;
        const py = y.getPixelForValue(data.current_pe);
        if (py < a.top || py > a.bottom) return;
        c.save();
        c.strokeStyle = '#f59e0b88'; c.lineWidth = 1.5; c.setLineDash([5,4]);
        c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
        c.fillStyle = '#f59e0b'; c.font = '11px Inter,sans-serif';
        c.fillText('Current PE ' + data.current_pe.toFixed(1)+'x', a.left+6, py-5);
        c.restore();
      }
    }]
  });

  // ── Price chart
  document.getElementById('priceChartWrap').style.display = 'block';
  const prCtx = document.getElementById('priceHistChart');
  new Chart(prCtx, {
    type: 'line',
    data: {
      labels: data.dates,
      datasets: [{
        label: 'Price',
        data: data.prices,
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.07)',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 5,
        fill: true,
        tension: 0.3,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: { label: c => ` $${c.raw?.toFixed(2)}` }
        }
      },
      scales: {
        x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
        y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => '$'+v} }
      },
      interaction: { mode:'index', intersect:false },
    },
    plugins: [{
      afterDraw(chart) {
        if (data.target_price == null) return;
        const {ctx: c, chartArea: a, scales: {y}} = chart;
        const py = y.getPixelForValue(data.target_price);
        if (py < a.top || py > a.bottom) return;
        c.save();
        c.strokeStyle = '#34d39988'; c.lineWidth = 1.5; c.setLineDash([5,4]);
        c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
        c.fillStyle = '#34d399'; c.font = '11px Inter,sans-serif';
        c.fillText('Target $' + data.target_price.toFixed(2), a.left+6, py-5);
        c.restore();
      }
    }]
  });

  // ── PEG history chart (only when data available)
  if (data.peg_history && data.peg_history.some(v => v != null)) {
    document.getElementById('pegHistSection').style.display = 'block';
    const pgCtx = document.getElementById('pegHistChart');
    new Chart(pgCtx, {
      type: 'line',
      data: {
        labels: data.dates,
        datasets: [{
          label: 'PEG',
          data: data.peg_history,
          borderColor: '#34d399',
          backgroundColor: 'rgba(52,211,153,0.07)',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          fill: true,
          tension: 0.3,
          spanGaps: true,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index', intersect: false,
            callbacks: { label: c => ` PEG: ${c.raw?.toFixed(2)}` }
          }
        },
        scales: {
          x: { grid:{color:gridCol}, ticks:{color:tickCol, maxTicksLimit:8, maxRotation:0} },
          y: { grid:{color:gridCol}, ticks:{color:tickCol, callback: v => v.toFixed(1)} }
        },
        interaction: { mode:'index', intersect:false },
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx: c, chartArea: a, scales: {y}} = chart;
          [1, 2].forEach((ref, i) => {
            const py = y.getPixelForValue(ref);
            if (py < a.top || py > a.bottom) return;
            c.save();
            c.strokeStyle = i === 0 ? '#f59e0b88' : '#f43f5e66';
            c.lineWidth = 1.5; c.setLineDash([5,4]);
            c.beginPath(); c.moveTo(a.left, py); c.lineTo(a.right, py); c.stroke();
            c.fillStyle = i === 0 ? '#f59e0b' : '#f43f5e';
            c.font = '11px Inter,sans-serif';
            c.fillText('PEG = ' + ref, a.left+6, py-5);
            c.restore();
          });
        }
      }]
    });
  }
  // ── Institutional holders (13F)
  if (data.institutional_holders && data.institutional_holders.length > 0) {
    const section = document.getElementById('instHoldersSection');
    const tbody   = document.getElementById('instHoldersBody');
    section.style.display = 'block';

    const changeLabel = {
      new:       '<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-emerald-900/50 text-emerald-300 border border-emerald-800">New</span>',
      increased: '<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-sky-900/50 text-sky-300 border border-sky-800">▲ Added</span>',
      reduced:   '<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-amber-900/50 text-amber-300 border border-amber-800">▼ Reduced</span>',
      closed:    '<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-rose-900/50 text-rose-300 border border-rose-800">Closed</span>',
      unchanged: '<span class="text-slate-600 text-xs">—</span>',
    };

    tbody.innerHTML = data.institutional_holders.map(h => `
      <tr class="border-b border-slate-800/50 hover:bg-slate-800/40 transition">
        <td class="py-2.5 px-3 text-slate-200 font-medium text-sm">${h.fund}</td>
        <td class="py-2.5 px-3 text-right text-slate-500 text-xs">${h.rank}</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm text-slate-300">${h.shares.toLocaleString()}</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm">$${h.value_millions.toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})}M</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm text-slate-300">${h.pct_portfolio.toFixed(2)}%</td>
        <td class="py-2.5 px-3 text-center">${changeLabel[h.change] || '<span class="text-slate-700 text-xs">?</span>'}</td>
      </tr>`).join('');
  }
</script>
{% endblock %}
