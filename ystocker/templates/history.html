{% extends "base.html" %}
{% block title %}yStocker — {{ ticker }} PE History{% endblock %}

{% block content %}
<style>
  .range-btn {
    font-size: 11px;
    font-weight: 500;
    line-height: 1;
    padding: 3px 7px;
    border-radius: 5px;
    border: 1px solid #334155;
    background: transparent;
    color: #64748b;
    cursor: pointer;
    transition: color 0.15s, background 0.15s, border-color 0.15s;
  }
  .range-btn:hover {
    color: #cbd5e1;
    border-color: #475569;
    background: #1e293b;
  }
  .range-btn.active {
    color: #a5b4fc;
    border-color: #6366f1;
    background: rgba(99,102,241,0.15);
  }
  .expand-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3px;
    border: none;
    background: transparent;
    color: #475569;
    cursor: pointer;
    transition: color 0.15s;
  }
  .expand-btn:hover { color: #cbd5e1; }
</style>

<div class="mb-6 sm:mb-8 fade-up">
  <div class="flex items-center gap-3 mb-1">
    <button onclick="history.back()" class="text-slate-500 hover:text-slate-300 text-sm transition" data-i18n="history.back">← Back</button>
    <span class="text-slate-700">/</span>
    <span class="text-slate-300 text-sm font-mono font-semibold">{{ ticker }}</span>
    <a href="https://www.tradingview.com/chart/?symbol={{ ticker }}" target="_blank" rel="noopener"
       class="ml-auto flex items-center gap-1 text-xs text-slate-400 border border-slate-700 bg-slate-800
              hover:text-slate-200 hover:border-slate-500 transition px-2.5 py-1 rounded-lg">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
      </svg>
      <span data-i18n="history.tradingview">TradingView</span>
    </a>
  </div>
  <h1 class="text-2xl sm:text-3xl font-bold">
    <span class="font-mono grad-text">{{ ticker }}</span>
    <span id="stockName" class="text-slate-400 text-lg sm:text-xl font-normal ml-2 sm:ml-3"></span>
  </h1>
  <p class="text-slate-500 text-sm mt-1" data-i18n="history.subtitle">Historical PE ratio &amp; price</p>
</div>

<!-- ── Stat cards ───────────────────────────────────────────────────── -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3 sm:gap-4 mb-6 sm:mb-8 fade-up">
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.current_pe">Current PE</div>
    <div id="statCurrentPe" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.fwd_pe">Forward PE</div>
    <div id="statFwdPe" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.peg_ratio">PEG Ratio</div>
    <div id="statCurrentPeg" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.target_price">Target Price</div>
    <div id="statTarget" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.ttm_eps">TTM EPS</div>
    <div id="statEps" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.upside">Analyst Upside</div>
    <div id="statUpside" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.eps_growth_ttm">EPS Growth TTM</div>
    <div id="statEpsGrowthTtm" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
  <div class="bg-slate-900 border border-slate-800 rounded-xl px-3 sm:px-4 py-3">
    <div class="text-xs text-slate-500 mb-1" data-i18n="history.eps_growth_q">EPS Growth Q</div>
    <div id="statEpsGrowthQ" class="text-lg sm:text-xl font-bold text-slate-100">—</div>
  </div>
</div>

<!-- ── Charts ────────────────────────────────────────────────────────── -->
<div class="space-y-6">

  <!-- PE history line chart -->
  <div id="peHistSection" class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.pe_title">PE Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.pe_desc">Estimated from weekly closing price ÷ TTM EPS</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-brand"></span> <span data-i18n="history.pe_legend">PE (TTM)</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 bg-amber-400 border-dashed border"></span> <span data-i18n="history.current_pe_legend">Current PE</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 border-dashed border border-slate-400"></span> <span data-i18n="history.avg_pe_legend">Avg PE</span>
        </span>
        <div class="flex gap-1" id="peRangeBtns">
          <button class="range-btn" data-chart="pe" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="pe" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="pe" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="pe" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="pe" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="pe" data-period="5y">5Y</button>
        </div>
        <button onclick="expandChart('pe')" title="Expand" class="expand-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
      </div>
    </div>
    <div id="peLoading" class="flex items-center justify-center h-36 sm:h-48 text-slate-500 text-sm animate-pulse">
      Loading PE history for {{ ticker }} …
    </div>
    <div class="chart-container" style="height:220px; display:none" id="peChartWrap">
      <canvas id="peChart"></canvas>
    </div>
  </div>

  <!-- Price history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.price_title">Price — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.price_desc">Weekly closing price (USD)</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-sky-400"></span> <span data-i18n="history.price_legend">Price</span>
        </span>
        <span id="legendTarget" style="display:none" class="items-center gap-1.5 text-xs text-slate-400 cursor-help wall-tip"
              data-tip-i18n="history.tip_target">
          <span class="inline-block w-3 h-0.5 border-dashed border border-emerald-400"></span> <span data-i18n="history.target_legend">Target</span>
        </span>
        <span id="legendCallWall" style="display:none" class="items-center gap-1.5 text-xs text-amber-400 cursor-help wall-tip"
              data-tip-i18n="history.tip_call_wall">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> <span data-i18n="history.call_wall_legend">Call Wall</span>
          <span class="text-slate-500 text-[10px] ml-0.5">ⓘ</span>
        </span>
        <span id="legendPutWall" style="display:none" class="items-center gap-1.5 text-xs text-rose-400 cursor-help wall-tip mr-1"
              data-tip-i18n="history.tip_put_wall">
          <span class="inline-block w-3 h-0.5 border-dashed border border-rose-400"></span> <span data-i18n="history.put_wall_legend">Put Wall</span>
          <span class="text-slate-500 text-[10px] ml-0.5">ⓘ</span>
        </span>
        <div class="flex gap-1" id="priceRangeBtns">
          <button class="range-btn" data-chart="price" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="price" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="price" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="price" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="price" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="price" data-period="5y">5Y</button>
        </div>
        <button onclick="expandChart('price')" title="Expand" class="expand-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:200px; display:none" id="priceChartWrap">
      <canvas id="priceHistChart"></canvas>
    </div>
  </div>

  <!-- PEG history line chart -->
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" id="pegHistSection" style="display:none">
    <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-0 sm:justify-between mb-4">
      <div>
        <h2 class="text-base font-semibold text-slate-200" data-i18n="history.peg_title">PEG Ratio — 52 Weeks</h2>
        <p class="text-xs text-slate-500" data-i18n="history.peg_desc">Estimated from weekly PE ÷ annual earnings growth rate</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap justify-end">
        <span class="flex items-center gap-1.5 text-xs text-slate-400">
          <span class="inline-block w-3 h-0.5 bg-emerald-400"></span> <span data-i18n="history.peg_legend">PEG</span>
        </span>
        <span class="flex items-center gap-1.5 text-xs text-slate-400 mr-1">
          <span class="inline-block w-3 h-0.5 border-dashed border border-amber-400"></span> <span data-i18n="history.peg1_legend">PEG = 1</span>
        </span>
        <div class="flex gap-1" id="pegRangeBtns">
          <button class="range-btn" data-chart="peg" data-period="1mo">1M</button>
          <button class="range-btn" data-chart="peg" data-period="3mo">3M</button>
          <button class="range-btn" data-chart="peg" data-period="6mo">6M</button>
          <button class="range-btn active" data-chart="peg" data-period="1y">1Y</button>
          <button class="range-btn" data-chart="peg" data-period="2y">2Y</button>
          <button class="range-btn" data-chart="peg" data-period="5y">5Y</button>
        </div>
        <button onclick="expandChart('peg')" title="Expand" class="expand-btn ml-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m4 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
        </button>
      </div>
    </div>
    <div class="chart-container" style="height:200px" id="pegChartWrap">
      <canvas id="pegHistChart"></canvas>
    </div>
  </div>

</div>

<!-- ── Expand modal ──────────────────────────────────────────────────── -->
<div id="chartModal" class="fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm" style="display:none">
  <div class="relative bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-[95vw] max-w-6xl p-5 sm:p-8">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 id="modalTitle" class="text-base font-semibold text-slate-200"></h3>
        <p id="modalDesc"  class="text-xs text-slate-500 mt-0.5"></p>
      </div>
      <button onclick="closeModal()" class="text-slate-500 hover:text-slate-200 transition ml-4 flex-shrink-0">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div style="height:65vh; min-height:300px; position:relative">
      <canvas id="modalCanvas"></canvas>
    </div>
  </div>
</div>

<!-- Institutional Holders (13F) -->
<div id="instHoldersSection" class="mt-6 bg-slate-900 border border-slate-800 rounded-2xl p-4 sm:p-6 fade-up" style="display:none">
  <h2 class="text-base font-semibold text-slate-200 mb-1" data-i18n="history.inst_title">Institutional Holdings (13F)</h2>
  <p class="text-xs text-slate-500 mb-4" data-i18n="history.inst_desc">Funds reporting this position in their latest SEC 13F filing — sorted by position size</p>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-xs text-slate-500 border-b border-slate-800 select-none">
          <th class="text-left py-2 px-3 font-medium" data-i18n="history.inst_fund">Fund</th>
          <th class="text-right py-2 px-3 font-medium" data-i18n="history.inst_rank">Portfolio Rank</th>
          <th class="text-right py-2 px-3 font-medium" data-i18n="history.inst_shares">Shares</th>
          <th class="text-right py-2 px-3 font-medium" data-i18n="history.inst_value">Value</th>
          <th class="text-right py-2 px-3 font-medium" data-i18n="history.inst_pct">% of Portfolio</th>
          <th class="text-center py-2 px-3 font-medium" data-i18n="history.inst_change">Change</th>
        </tr>
      </thead>
      <tbody id="instHoldersBody"></tbody>
    </table>
  </div>
</div>

<!-- Error -->
<div id="histError" class="hidden mt-4 px-4 py-3 rounded-lg bg-red-900/40 border border-red-700 text-red-300 text-sm"></div>

<script>
const TICKER = {{ ticker | tojson }};

// ── Range buttons + expand modal ─────────────────────────────────────────────
const _chartConfigs   = {};   // key → latest Chart.js config object
const _chartInstances = {};   // key → live Chart instance (for inline charts)
const _periodCache    = {};   // period → fetched data
let   _modalChart     = null;
let   _modalKey       = null;

(async function() {
  let data;
  try {
    const resp = await fetch(`/api/history/${encodeURIComponent(TICKER)}`);
    data = await resp.json();
    if (!resp.ok) {
      document.getElementById('histError').textContent = '⚠ ' + data.error;
      document.getElementById('histError').classList.remove('hidden');
      document.getElementById('peLoading').textContent = I18n.t('history.failed') || 'Failed to load data.';
      return;
    }
  } catch(e) {
    document.getElementById('histError').textContent = '⚠ Network error: ' + e;
    document.getElementById('histError').classList.remove('hidden');
    return;
  }

  // Stat cards
  document.getElementById('stockName').textContent     = data.name || '';
  document.getElementById('statCurrentPe').textContent = data.current_pe  != null ? data.current_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statFwdPe').textContent      = data.forward_pe  != null ? data.forward_pe.toFixed(1)+'x'  : '—';
  document.getElementById('statTarget').textContent     = data.target_price != null ? '$'+data.target_price.toFixed(2) : '—';
  document.getElementById('statEps').textContent        = data.eps          != null ? '$'+data.eps.toFixed(2)          : '—';

  const pegEl = document.getElementById('statCurrentPeg');
  if (data.current_peg != null) {
    pegEl.textContent  = data.current_peg.toFixed(2);
    pegEl.className    = 'text-xl font-bold ' + (data.current_peg < 1 ? 'text-emerald-400' : data.current_peg < 2 ? 'text-amber-400' : 'text-rose-400');
  }

  const upsideEl = document.getElementById('statUpside');
  if (data.target_price != null && data.prices?.length) {
    const lastPrice = data.prices.filter(p => p != null).at(-1);
    if (lastPrice) {
      const upside = (data.target_price - lastPrice) / lastPrice * 100;
      upsideEl.textContent = (upside >= 0 ? '+' : '') + upside.toFixed(1) + '%';
      upsideEl.className   = 'text-xl font-bold ' + (upside >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }

  function setGrowthStat(elId, val) {
    const el = document.getElementById(elId);
    if (val != null) {
      el.textContent = (val >= 0 ? '+' : '') + val.toFixed(1) + '%';
      el.className   = 'text-lg sm:text-xl font-bold ' + (val >= 0 ? 'text-emerald-400' : 'text-rose-400');
    }
  }
  setGrowthStat('statEpsGrowthTtm', data.eps_growth_ttm);
  setGrowthStat('statEpsGrowthQ',   data.eps_growth_q);

  // Cache 1y data and static reference values (target, walls, current_pe)
  _periodCache['1y'] = data;
  const staticData = {
    current_pe:   data.current_pe,
    target_price: data.target_price,
    call_wall:    data.call_wall,
    put_wall:     data.put_wall,
  };

  // ── PE chart (only when data available)
  if (data.pe_history && data.pe_history.some(v => v != null)) {
    document.getElementById('peLoading').style.display = 'none';
    document.getElementById('peChartWrap').style.display = 'block';
    const peCfg = _buildConfig('pe', data, staticData);
    _registerChart('pe', peCfg, new Chart(document.getElementById('peChart'), peCfg));
  } else {
    document.getElementById('peLoading').style.display = 'none';
  }

  // ── Price chart
  document.getElementById('priceChartWrap').style.display = 'block';
  if (data.target_price != null) document.getElementById('legendTarget').style.display   = 'flex';
  if (data.call_wall    != null) document.getElementById('legendCallWall').style.display = 'flex';
  if (data.put_wall     != null) document.getElementById('legendPutWall').style.display  = 'flex';

  const prCfg = _buildConfig('price', data, staticData);
  _registerChart('price', prCfg, new Chart(document.getElementById('priceHistChart'), prCfg));

  // ── PEG history chart (only when data available)
  if (data.peg_history && data.peg_history.some(v => v != null)) {
    document.getElementById('pegHistSection').style.display = 'block';
    const pgCfg = _buildConfig('peg', data, staticData);
    _registerChart('peg', pgCfg, new Chart(document.getElementById('pegHistChart'), pgCfg));
  }

  // ── Wire up range buttons
  document.querySelectorAll('.range-btn[data-chart]').forEach(btn => {
    btn.addEventListener('click', () => _handleRange(btn.dataset.chart, btn.dataset.period, staticData));
  });
  // ── Institutional holders (13F)
  if (data.institutional_holders && data.institutional_holders.length > 0) {
    const section = document.getElementById('instHoldersSection');
    const tbody   = document.getElementById('instHoldersBody');
    section.style.display = 'block';

    // Sort by value descending (hottest = largest position first)
    const holders = [...data.institutional_holders].sort((a, b) => b.value_millions - a.value_millions);

    // Heatmap: scale intensity relative to the largest holder
    const maxVal = Math.max(...holders.map(h => h.value_millions), 0.01);
    function holdHeat(v) {
      const t = Math.min(v / maxVal, 1);
      const alpha = (0.06 + t * 0.38).toFixed(2);
      const borderAlpha = (0.20 + t * 0.65).toFixed(2);
      return {
        bg:     `rgba(99,102,241,${alpha})`,
        border: `rgba(99,102,241,${borderAlpha})`,
        text:   t > 0.5 ? '#a5b4fc' : '#94a3b8',
      };
    }

    const changeLabel = {
      new:       h => `<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-emerald-900/50 text-emerald-300 border border-emerald-800">${I18n.t('inst.change_new') || 'New'}</span>`,
      increased: h => `<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-sky-900/50 text-sky-300 border border-sky-800">${I18n.t('inst.change_added') || '▲ Added'}</span>${h.change_pct != null ? `<span class="text-sky-400 text-xs font-mono ml-1">+${h.change_pct}%</span>` : ''}`,
      reduced:   h => `<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-amber-900/50 text-amber-300 border border-amber-800">${I18n.t('inst.change_reduced') || '▼ Reduced'}</span>${h.change_pct != null ? `<span class="text-amber-400 text-xs font-mono ml-1">${h.change_pct}%</span>` : ''}`,
      closed:    h => `<span class="px-1.5 py-0.5 rounded text-[11px] font-semibold bg-rose-900/50 text-rose-300 border border-rose-800">${I18n.t('inst.change_closed') || 'Closed'}</span>`,
      unchanged: h => `<span class="text-slate-600 text-xs">—</span>`,
    };

    tbody.innerHTML = holders.map(h => {
      const heat = holdHeat(h.value_millions);
      return `
      <tr class="border-b border-slate-800/50 transition" style="background:${heat.bg};border-left:3px solid ${heat.border}">
        <td class="py-2.5 px-3 font-medium text-sm" style="color:${heat.text}">${h.fund}</td>
        <td class="py-2.5 px-3 text-right text-slate-500 text-xs">${h.rank}</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm text-slate-300">${h.shares.toLocaleString()}</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm font-semibold" style="color:${heat.text}">$${h.value_millions.toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})}M</td>
        <td class="py-2.5 px-3 text-right font-mono text-sm text-slate-300">${h.pct_portfolio.toFixed(2)}%</td>
        <td class="py-2.5 px-3 text-center">${changeLabel[h.change] ? changeLabel[h.change](h) : '<span class="text-slate-700 text-xs">?</span>'}</td>
      </tr>`;
    }).join('');
  }
})();

// ── Chart config builder, range handler, modal ───────────────────────────────

function _registerChart(key, cfg, instance) {
  _chartConfigs[key]   = cfg;
  _chartInstances[key] = instance;
}

// Fetch + cache period data
async function _fetchPeriod(period) {
  if (_periodCache[period]) return _periodCache[period];
  const resp = await fetch(`/api/history/${encodeURIComponent(TICKER)}?period=${period}`);
  const d = await resp.json();
  if (!resp.ok) throw new Error(d.error || 'Failed');
  _periodCache[period] = d;
  return d;
}

// Update active state for range buttons of a given chart key
function _setActiveBtn(chartKey, period) {
  document.querySelectorAll(`.range-btn[data-chart="${chartKey}"]`).forEach(b => {
    b.classList.toggle('active', b.dataset.period === period);
  });
}

// Build a fresh Chart.js config from fetched data for a given chart key
function _buildConfig(key, d, staticData) {
  const gridCol = '#1e293b', tickCol = '#64748b';
  if (key === 'pe') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'PE (TTM)', data:d.pe_history,
        borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.08)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` PE: ${c.raw?.toFixed(1)}x`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>v+'x'}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          // Average PE line
          const vals = d.pe_history.filter(v => v != null);
          if (vals.length) {
            const avg = vals.reduce((s,v) => s+v, 0) / vals.length;
            const ay = y.getPixelForValue(avg);
            if (ay >= a.top && ay <= a.bottom) {
              c.save(); c.strokeStyle='rgba(148,163,184,0.5)'; c.lineWidth=1; c.setLineDash([4,4]);
              c.beginPath(); c.moveTo(a.left,ay); c.lineTo(a.right,ay); c.stroke();
              c.fillStyle='#94a3b8'; c.font='11px Inter,sans-serif';
              c.fillText('Avg '+avg.toFixed(1)+'x', a.left+6, ay+12); c.restore();
            }
          }
          // Current PE line
          const pe = staticData.current_pe;
          if (pe == null) return;
          const py = y.getPixelForValue(pe);
          if (py < a.top || py > a.bottom) return;
          c.save(); c.strokeStyle='#f59e0b88'; c.lineWidth=1.5; c.setLineDash([5,4]);
          c.beginPath(); c.moveTo(a.left,py); c.lineTo(a.right,py); c.stroke();
          c.fillStyle='#f59e0b'; c.font='11px Inter,sans-serif';
          c.fillText('Current PE '+pe.toFixed(1)+'x', a.left+6, py-5); c.restore();
        }
      }],
      _title: 'PE Ratio', _desc: 'Estimated from closing price ÷ TTM EPS',
    };
  }
  if (key === 'price') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'Price', data:d.prices,
        borderColor:'#38bdf8', backgroundColor:'rgba(56,189,248,0.07)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` $${c.raw?.toFixed(2)}`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>'$'+v}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          function drawRef(price, sc, lc, label, off) {
            if (price == null) return;
            const py = y.getPixelForValue(price);
            if (py < a.top || py > a.bottom) return;
            c.save(); c.strokeStyle=sc; c.lineWidth=1.5; c.setLineDash([5,4]);
            c.beginPath(); c.moveTo(a.left,py); c.lineTo(a.right,py); c.stroke();
            c.fillStyle=lc; c.font='11px Inter,sans-serif';
            c.fillText(label, a.left+6, py+off); c.restore();
          }
          drawRef(staticData.target_price,'#34d39988','#34d399','Target $'+staticData.target_price?.toFixed(2),-5);
          drawRef(staticData.call_wall,   '#f59e0b88','#f59e0b','Call Wall $'+staticData.call_wall?.toFixed(2),-5);
          drawRef(staticData.put_wall,    '#f43f5e88','#f43f5e','Put Wall $'+staticData.put_wall?.toFixed(2),12);
        }
      }],
      _title: 'Price', _desc: 'Closing price (USD)',
    };
  }
  if (key === 'peg') {
    return {
      type: 'line',
      data: { labels: d.dates, datasets: [{ label:'PEG', data:d.peg_history,
        borderColor:'#34d399', backgroundColor:'rgba(52,211,153,0.07)',
        borderWidth:2, pointRadius:0, pointHoverRadius:5, fill:true, tension:0.3, spanGaps:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false, callbacks:{label:c=>` PEG: ${c.raw?.toFixed(2)}`}} },
        scales:{ x:{grid:{color:gridCol},ticks:{color:tickCol,maxTicksLimit:8,maxRotation:0}}, y:{grid:{color:gridCol},ticks:{color:tickCol,callback:v=>v.toFixed(1)}} },
        interaction:{mode:'index',intersect:false},
      },
      plugins: [{
        afterDraw(chart) {
          const {ctx:c,chartArea:a,scales:{y}} = chart;
          [1,2].forEach((ref,i) => {
            const py = y.getPixelForValue(ref);
            if (py < a.top || py > a.bottom) return;
            c.save(); c.strokeStyle=i===0?'#f59e0b88':'#f43f5e66'; c.lineWidth=1.5; c.setLineDash([5,4]);
            c.beginPath(); c.moveTo(a.left,py); c.lineTo(a.right,py); c.stroke();
            c.fillStyle=i===0?'#f59e0b':'#f43f5e'; c.font='11px Inter,sans-serif';
            c.fillText('PEG = '+ref, a.left+6, py-5); c.restore();
          });
        }
      }],
      _title: 'PEG Ratio', _desc: 'Estimated from PE ÷ annual earnings growth rate',
    };
  }
}

// Handle a range button click: fetch data, rebuild inline chart
async function _handleRange(chartKey, period, staticData) {
  _setActiveBtn(chartKey, period);

  const wrapId  = { pe:'peChartWrap', price:'priceChartWrap', peg:'pegChartWrap' }[chartKey];
  const canvasId = { pe:'peChart', price:'priceHistChart', peg:'pegHistChart' }[chartKey];
  const wrap = document.getElementById(wrapId);

  // Show loading overlay
  let overlay = wrap.querySelector('.chart-loading-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = 'chart-loading-overlay';
    overlay.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);border-radius:8px;z-index:10;';
    overlay.innerHTML = '<svg class="animate-spin" style="width:20px;height:20px;color:#6366f1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';
    wrap.style.position = 'relative';
    wrap.appendChild(overlay);
  } else {
    overlay.style.display = 'flex';
  }

  let d;
  try { d = await _fetchPeriod(period); } catch(e) {
    overlay.style.display = 'none';
    return;
  }

  overlay.style.display = 'none';
  if (_chartInstances[chartKey]) { _chartInstances[chartKey].destroy(); }
  const cfg = _buildConfig(chartKey, d, staticData);
  _chartConfigs[chartKey] = cfg;
  _chartInstances[chartKey] = new Chart(document.getElementById(canvasId), cfg);

  // If modal is open for this chart, refresh it too
  if (_modalKey === chartKey && document.getElementById('chartModal').style.display !== 'none') {
    _renderModal(chartKey, d, staticData);
  }
}

function _renderModal(key, d, staticData) {
  if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
  const cfg = _buildConfig(key, d, staticData);
  _modalChart = new Chart(document.getElementById('modalCanvas'), cfg);
}

function expandChart(key) {
  const cfg = _chartConfigs[key];
  if (!cfg) return;
  _modalKey = key;
  const modal = document.getElementById('chartModal');
  document.getElementById('modalTitle').textContent = cfg._title || '';
  document.getElementById('modalDesc').textContent  = cfg._desc  || '';
  modal.style.display = 'flex';
  if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
  const plugins = cfg.plugins;
  const clone = JSON.parse(JSON.stringify(cfg, (k, v) => k.startsWith('_') ? undefined : v));
  if (plugins) clone.plugins = plugins;
  _modalChart = new Chart(document.getElementById('modalCanvas'), clone);
}

function closeModal() {
  document.getElementById('chartModal').style.display = 'none';
  if (_modalChart) { _modalChart.destroy(); _modalChart = null; }
  _modalKey = null;
}

document.getElementById('chartModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ── Wall tooltip ─────────────────────────────────────────────────────────────
(function() {
  const tip = document.createElement('div');
  tip.id = 'wallTip';
  tip.style.cssText = [
    'position:fixed','z-index:9999','max-width:280px','padding:8px 12px',
    'background:#0f172a','border:1px solid #334155','border-radius:8px',
    'color:#cbd5e1','font-size:12px','line-height:1.5','pointer-events:none',
    'opacity:0','transition:opacity 0.15s','box-shadow:0 4px 16px rgba(0,0,0,0.5)',
  ].join(';');
  document.body.appendChild(tip);

  let hideTimer;
  document.querySelectorAll('.wall-tip').forEach(el => {
    el.addEventListener('mouseenter', function(e) {
      clearTimeout(hideTimer);
      const key = this.dataset.tipI18n;
      tip.textContent = (key && I18n.t(key)) || this.dataset.tip || '';
      tip.style.opacity = '1';
      positionTip(e);
    });
    el.addEventListener('mousemove', positionTip);
    el.addEventListener('mouseleave', () => {
      hideTimer = setTimeout(() => { tip.style.opacity = '0'; }, 100);
    });
  });

  function positionTip(e) {
    const pad = 12;
    let x = e.clientX + pad;
    let y = e.clientY + pad;
    // keep inside viewport
    const tw = tip.offsetWidth  || 280;
    const th = tip.offsetHeight || 60;
    if (x + tw > window.innerWidth  - pad) x = e.clientX - tw - pad;
    if (y + th > window.innerHeight - pad) y = e.clientY - th - pad;
    tip.style.left = x + 'px';
    tip.style.top  = y + 'px';
  }
})();
</script>
{% endblock %}
