{% extends "base.html" %}
{% block title %}yStocker — Daily Report{% endblock %}

{% block content %}
<style>
  .card { background:#0f172a; border:1px solid #1e293b; border-radius:14px; padding:16px 18px; }
  .card-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.07em; color:#475569; margin-bottom:10px; }
  .idx-row { display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #1e293b; }
  .idx-row:last-child { border-bottom:none; }
  .up   { color:#34d399; }
  .down { color:#f87171; }
  .neutral { color:#94a3b8; }
</style>

<!-- Header -->
<div class="mb-6 fade-up flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
  <div>
    <h1 class="text-2xl sm:text-3xl font-bold grad-text">Daily Markets Report</h1>
    <p class="text-slate-400 mt-1 text-sm" id="reportDate">Loading…</p>
  </div>
  <button onclick="location.reload()"
          class="px-4 py-2 text-sm rounded-xl border border-slate-700 text-slate-300
                 hover:border-brand hover:text-brand transition shrink-0">
    Refresh
  </button>
</div>

<!-- Loading -->
<div id="drLoading" class="flex items-center gap-2 text-slate-500 text-sm py-8">
  <svg class="animate-spin w-4 h-4 text-brand shrink-0" fill="none" viewBox="0 0 24 24">
    <circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
    <path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
  </svg>
  <span>Loading market data…</span>
</div>

<div id="drContent" style="display:none">

<!-- ── Index Snapshot ─────────────────────────────────────────────── -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6 fade-up">
  <!-- US Indices -->
  <div class="card">
    <div class="card-title">US Indices</div>
    <div id="drUsIndices"></div>
  </div>
  <!-- Asia/Europe Indices -->
  <div class="card">
    <div class="card-title">Asia / Europe</div>
    <div id="drIntlIndices"></div>
  </div>
  <!-- Sentiment -->
  <div class="card">
    <div class="card-title">Sentiment</div>
    <div id="drSentiment"></div>
  </div>
</div>

<!-- ── Sector Performance ─────────────────────────────────────────── -->
<div class="card mb-6 fade-up">
  <div class="card-title">Sector Performance (Day Change)</div>
  <div id="drSectors" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-2"></div>
</div>

<!-- ── Gold Ratios ────────────────────────────────────────────────── -->
<div class="card mb-6 fade-up">
  <div class="card-title">Commodity Ratios</div>
  <div id="drCommodities" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
</div>

<!-- ── Put/Call Ratio + AAII + VIX ───────────────────────────────── -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 fade-up">
  <div class="card"><div class="card-title">VIX</div><div id="drVix"></div></div>
  <div class="card"><div class="card-title">Put/Call Ratio</div><div id="drPcr"></div></div>
  <div class="card"><div class="card-title">Fear &amp; Greed</div><div id="drFg"></div></div>
</div>

<!-- ── Economic Events Today ─────────────────────────────────────── -->
<div class="card mb-6 fade-up">
  <div class="card-title">Economic Events</div>
  <div id="drEvents" class="text-sm text-slate-400"></div>
</div>

<!-- ── Top Movers ─────────────────────────────────────────────────── -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 fade-up">
  <div class="card">
    <div class="card-title">Top Gainers</div>
    <div id="drGainers" class="text-sm text-slate-400">
      <div class="flex items-center gap-2 text-slate-600 text-xs py-2"><svg class="animate-spin w-3 h-3 shrink-0" fill="none" viewBox="0 0 24 24"><circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>Loading…</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Top Losers</div>
    <div id="drLosers" class="text-sm text-slate-400">
      <div class="flex items-center gap-2 text-slate-600 text-xs py-2"><svg class="animate-spin w-3 h-3 shrink-0" fill="none" viewBox="0 0 24 24"><circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>Loading…</div>
    </div>
  </div>
</div>

<!-- ── AI Summary ──────────────────────────────────────────────────── -->
<div class="card mb-6 fade-up" id="drAiCard">
  <div class="flex items-center justify-between mb-3">
    <div class="card-title" style="margin-bottom:0">AI Market Commentary</div>
    <button id="drAiBtn" onclick="generateAiSummary()"
            class="px-3 py-1 text-xs rounded-lg border border-brand/50 text-brand hover:bg-brand/10 transition">
      Generate
    </button>
  </div>
  <div id="drAiContent" class="text-sm text-slate-300 leading-relaxed">
    <span class="text-slate-600">Click "Generate" for an AI-written market summary.</span>
  </div>
</div>

</div><!-- /drContent -->

<script>
const GRID_COL = '#1e293b', TICK_COL = '#64748b';

function _chg(v, dec=2) {
  if (v == null) return '<span class="neutral">—</span>';
  const cls = v >= 0 ? 'up' : 'down';
  const sign = v >= 0 ? '+' : '';
  return `<span class="${cls}">${sign}${v.toFixed(dec)}%</span>`;
}

function _val(v, dec=2, prefix='') {
  if (v == null) return '<span class="neutral">—</span>';
  return prefix + v.toLocaleString(undefined, {minimumFractionDigits:dec, maximumFractionDigits:dec});
}

// ── Markets data ──────────────────────────────────────────────────
async function loadMarkets() {
  const resp = await fetch('/api/markets');
  const data = await resp.json();
  const idx = data.indices || {};
  const now = new Date();
  document.getElementById('reportDate').textContent =
    now.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // US indices
  const us = ['spx','ixic','dji'];
  const usLabels = { spx:'S&P 500', ixic:'Nasdaq', dji:'Dow Jones' };
  document.getElementById('drUsIndices').innerHTML = us.map(k => {
    const d = idx[k] || {};
    return `<div class="idx-row">
      <span class="text-sm font-semibold text-slate-200">${usLabels[k]}</span>
      <div class="text-right">
        <div class="text-sm font-mono text-slate-100">${_val(d.current,2)}</div>
        <div class="text-xs">${_chg(d.day_chg)}</div>
      </div>
    </div>`;
  }).join('');

  // Intl indices
  const intl = ['ftse','n225','sse','twii','kospi'];
  const intlLabels = { ftse:'FTSE 100', n225:'Nikkei 225', sse:'Shanghai', twii:'Taiwan', kospi:'KOSPI' };
  document.getElementById('drIntlIndices').innerHTML = intl.map(k => {
    const d = idx[k] || {};
    return `<div class="idx-row">
      <span class="text-sm font-semibold text-slate-200">${intlLabels[k]}</span>
      <div class="text-right">
        <div class="text-sm font-mono text-slate-100">${_val(d.current,2)}</div>
        <div class="text-xs">${_chg(d.day_chg)}</div>
      </div>
    </div>`;
  }).join('');

  // VIX
  const vix = data.vix || {};
  document.getElementById('drVix').innerHTML = vix.current != null ? `
    <div class="text-3xl font-bold tabular-nums ${vix.current >= 30 ? 'text-rose-400' : vix.current >= 20 ? 'text-orange-400' : 'text-emerald-400'}">
      ${vix.current?.toFixed(2)}
    </div>
    <div class="text-xs text-slate-500 mt-1">Day change: ${_chg(vix.day_chg)}</div>
    <div class="text-xs text-slate-600 mt-1">${vix.current < 15 ? 'Calm' : vix.current < 20 ? 'Normal' : vix.current < 30 ? 'Elevated' : 'Extreme Fear'}</div>
  ` : '<div class="text-slate-600 text-sm">—</div>';

  // Sectors
  const sectors = (data.sectors || []).sort((a,b) => (b.day_chg ?? -999) - (a.day_chg ?? -999));
  document.getElementById('drSectors').innerHTML = sectors.map(s => {
    const col = s.day_chg == null ? '#475569' : s.day_chg >= 0 ? '#34d399' : '#f87171';
    return `<div class="bg-slate-800/50 rounded-xl p-2.5 text-center">
      <div class="text-xs text-slate-400 mb-1 truncate">${s.label}</div>
      <div class="text-sm font-bold" style="color:${col}">${s.day_chg != null ? (s.day_chg >= 0 ? '+' : '') + s.day_chg.toFixed(2) + '%' : '—'}</div>
    </div>`;
  }).join('');

  document.getElementById('drContent').style.display = '';
  document.getElementById('drLoading').style.display = 'none';
  _latestMarketData = data;
}

// ── Helpers ───────────────────────────────────────────────────────
function _fgColor(r) {
  const lo = (r||'').toLowerCase();
  if (lo.includes('extreme fear')) return '#ef4444';
  if (lo.includes('fear'))         return '#f87171';
  if (lo.includes('extreme greed'))return '#10b981';
  if (lo.includes('greed'))        return '#34d399';
  return '#94a3b8';
}

// ── Sentiment data ────────────────────────────────────────────────
async function loadSentiment() {
  // Fetch all three independently — one failure should not block others
  const [fgResult, pcrResult, aaiiResult] = await Promise.allSettled([
    fetch('/api/fear-greed').then(r => r.json()),
    fetch('/api/put-call-ratio').then(r => r.json()),
    fetch('/api/aaii-sentiment').then(r => r.json()),
  ]);

  const fgResp   = fgResult.status   === 'fulfilled' ? fgResult.value   : {};
  const pcrResp  = pcrResult.status  === 'fulfilled' ? pcrResult.value  : {};
  const aaiiResp = aaiiResult.status === 'fulfilled' ? aaiiResult.value : {};

  // Fear & Greed
  const fgScore = fgResp.score != null ? Math.round(fgResp.score) : null;
  document.getElementById('drFg').innerHTML = fgScore != null ? `
    <div class="text-3xl font-bold tabular-nums" style="color:${_fgColor(fgResp.rating)}">${fgScore}</div>
    <div class="text-xs mt-1" style="color:${_fgColor(fgResp.rating)}">${fgResp.rating || ''}</div>
  ` : '<div class="text-slate-600 text-sm">—</div>';

  // PCR
  const pcrVal = pcrResp.current ?? null;
  const pcrSig = pcrVal == null ? '' : pcrVal < 0.6 ? 'Bullish' : pcrVal < 0.8 ? 'Neutral' : 'Bearish';
  const pcrCol = pcrVal == null ? '#94a3b8' : pcrVal < 0.6 ? '#34d399' : pcrVal < 0.8 ? '#94a3b8' : '#f87171';
  document.getElementById('drPcr').innerHTML = pcrVal != null ? `
    <div class="text-3xl font-bold tabular-nums" style="color:${pcrCol}">${pcrVal.toFixed(2)}</div>
    <div class="text-xs mt-1" style="color:${pcrCol}">${pcrSig}</div>
    <div class="text-xs text-slate-500 mt-1">20-day MA: ${pcrResp.ma20?.toFixed(2) ?? '—'}</div>
  ` : '<div class="text-slate-600 text-sm">—</div>';

  // Sentiment (AAII + FG combined in one card)
  const latest = (aaiiResp.latest) || {};
  const spread = latest.bull_bear_spread ?? null;
  document.getElementById('drSentiment').innerHTML = `
    <div class="space-y-2">
      <div class="idx-row">
        <span class="text-xs text-slate-400">AAII Bull</span>
        <span class="text-sm font-semibold text-emerald-400">${latest.bullish?.toFixed(1) ?? '—'}%</span>
      </div>
      <div class="idx-row">
        <span class="text-xs text-slate-400">AAII Bear</span>
        <span class="text-sm font-semibold text-rose-400">${latest.bearish?.toFixed(1) ?? '—'}%</span>
      </div>
      <div class="idx-row">
        <span class="text-xs text-slate-400">Bull-Bear Spread</span>
        <span class="text-sm font-semibold ${spread == null ? 'neutral' : spread >= 0 ? 'up' : 'down'}">
          ${spread != null ? (spread >= 0 ? '+' : '') + spread.toFixed(1) + '%' : '—'}
        </span>
      </div>
      <div class="idx-row">
        <span class="text-xs text-slate-400">PCR</span>
        <span class="text-sm font-semibold" style="color:${pcrCol}">${pcrVal != null ? pcrVal.toFixed(2) : '—'}</span>
      </div>
      <div class="idx-row">
        <span class="text-xs text-slate-400">Fear &amp; Greed</span>
        <span class="text-sm font-semibold" style="color:${_fgColor(fgResp.rating)}">${fgScore ?? '—'}</span>
      </div>
    </div>`;
  // Store for AI summary
  _latestSentiment = { fg: fgResp, pcr: pcrResp, aaii: latest };
}

// ── Gold Ratios ───────────────────────────────────────────────────
async function loadGoldRatios() {
  try {
    const data = await fetch('/api/gold-ratios').then(r => r.json());
    if (data.error) return;
    document.getElementById('drCommodities').innerHTML = `
      <div class="stat-card">
        <div class="stat-label text-[11px] text-slate-500 mb-1">Gold</div>
        <div class="text-lg font-bold text-yellow-300">$${data.gold_price?.toFixed(0) ?? '—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label text-[11px] text-slate-500 mb-1">Silver</div>
        <div class="text-lg font-bold text-slate-300">$${data.silver_price?.toFixed(2) ?? '—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label text-[11px] text-slate-500 mb-1">Gold / Silver</div>
        <div class="text-lg font-bold text-yellow-300">${data.current_gs?.toFixed(1) ?? '—'}</div>
        <div class="text-xs text-slate-500">${data.gs_day_chg != null ? (data.gs_day_chg >= 0 ? '+' : '') + data.gs_day_chg.toFixed(2) : ''} today</div>
      </div>
      <div class="stat-card">
        <div class="stat-label text-[11px] text-slate-500 mb-1">Gold / Copper</div>
        <div class="text-lg font-bold text-orange-300">${data.current_gc?.toFixed(1) ?? '—'}</div>
        <div class="text-xs text-slate-500">${data.gc_day_chg != null ? (data.gc_day_chg >= 0 ? '+' : '') + data.gc_day_chg.toFixed(2) : ''} today</div>
      </div>`;
  } catch(e) {
    console.warn('Gold ratios load failed:', e.message);
  }
}

// ── Economic Events ───────────────────────────────────────────────
async function loadEconEvents() {
  try {
    const data = await fetch('/api/economic-events').then(r => r.json());
    const allEvents = data.events || [];
    const today = new Date().toISOString().slice(0, 10);
    const evEl = document.getElementById('drEvents');
    _latestEvents = allEvents;

    // Get sorted unique dates starting from today
    const dates = [...new Set(allEvents.map(e => e.date))].filter(d => d >= today).sort();

    // Find the nearest date with High-impact events
    let events = [];
    let evLabel = '';
    for (const d of dates) {
      const hi = allEvents.filter(e => e.date === d && e.impact === 'High');
      if (hi.length) { events = hi; evLabel = d === today ? 'Today' : d; break; }
    }
    // If no High events found, show today's all events (or nearest day)
    if (!events.length && dates.length) {
      const d = dates[0];
      events = allEvents.filter(e => e.date === d);
      evLabel = d === today ? 'Today' : d;
    }

    if (!events.length) {
      evEl.innerHTML = '<span class="text-slate-600">No upcoming events found.</span>';
      return;
    }
    const impColor = { High: '#f87171', Medium: '#fbbf24', Low: '#64748b' };
    const labelHtml = evLabel && evLabel !== 'Today'
      ? `<div class="text-xs text-slate-500 mb-2">Next high-impact events: <span class="text-slate-300">${evLabel}</span></div>` : '';
    evEl.innerHTML = labelHtml + `<div class="space-y-1">` + events.slice(0, 15).map(ev => `
      <div class="flex items-center gap-3 py-1.5 border-b border-slate-800/60 last:border-0">
        <span class="text-xs text-slate-500 whitespace-nowrap w-14 shrink-0">${ev.time || '—'}</span>
        <span class="text-xs font-medium text-slate-400 w-7 shrink-0">${ev.country || ''}</span>
        <span class="text-sm text-slate-200 flex-1">${ev.event || ''}</span>
        ${ev.impact ? `<span class="text-[10px] font-bold px-1 rounded shrink-0" style="color:${impColor[ev.impact]||'#64748b'}">${ev.impact}</span>` : ''}
        ${ev.actual != null ? `<span class="text-xs font-mono text-emerald-400 shrink-0">${ev.actual}</span>` : ev.forecast != null ? `<span class="text-xs font-mono text-slate-500 shrink-0">est ${ev.forecast}</span>` : ''}
      </div>`).join('') + `</div>`;
  } catch(e) {
    console.warn('Events load failed:', e.message);
  }
}

// ── Top Movers ────────────────────────────────────────────────────
let _moversData = null;
async function loadMovers() {
  try {
    const data = await fetch('/api/movers').then(r => r.json());
    if (data.error) return;
    _moversData = data;
    const fmtMover = (m, isGain) => `
      <div class="flex items-center justify-between py-1.5 border-b border-slate-800/60 last:border-0">
        <a href="/history/${m.ticker}" class="text-sm font-semibold text-slate-200 hover:text-brand transition">${m.ticker}</a>
        <div class="text-right">
          <div class="text-xs text-slate-500">$${m.price?.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
          <div class="text-sm font-bold ${isGain ? 'text-emerald-400' : 'text-rose-400'}">${m.day_chg >= 0 ? '+' : ''}${m.day_chg?.toFixed(2)}%</div>
        </div>
      </div>`;
    document.getElementById('drGainers').innerHTML = (data.gainers || []).map(m => fmtMover(m, true)).join('') || '<span class="text-slate-600 text-xs">No data</span>';
    document.getElementById('drLosers').innerHTML  = (data.losers  || []).map(m => fmtMover(m, false)).join('') || '<span class="text-slate-600 text-xs">No data</span>';
  } catch(e) {
    console.warn('Movers load failed:', e.message);
    document.getElementById('drGainers').innerHTML = '<span class="text-slate-600 text-xs">Unavailable</span>';
    document.getElementById('drLosers').innerHTML  = '<span class="text-slate-600 text-xs">Unavailable</span>';
  }
}

// ── AI Market Summary ─────────────────────────────────────────────
let _summaryGenerating = false;
let _latestMarketData  = null;
let _latestSentiment   = {};
let _latestEvents      = [];

async function generateAiSummary() {
  if (_summaryGenerating) return;
  _summaryGenerating = true;
  const btn     = document.getElementById('drAiBtn');
  const content = document.getElementById('drAiContent');
  btn.disabled  = true;
  btn.textContent = 'Generating…';
  content.innerHTML = '<div class="flex items-center gap-2 text-slate-500 text-sm"><svg class="animate-spin w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24"><circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>Thinking…</div>';

  try {
    // Gather all available data for the prompt
    const body = {
      market_data: {
        indices: _latestMarketData?.indices || {},
        vix:     _latestMarketData?.vix || {},
        sectors: _latestMarketData?.sectors || [],
        fg:      _latestSentiment.fg || {},
        pcr:     _latestSentiment.pcr || {},
        aaii:    _latestSentiment.aaii || {},
        gainers: _moversData?.gainers || [],
        losers:  _moversData?.losers  || [],
        events:  _latestEvents.filter(e => e.impact === 'High').slice(0, 5),
      }
    };
    const resp = await fetch('/api/daily-summary', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    // Convert newlines to paragraphs
    const paras = result.summary.split(/\n\n+/).filter(Boolean);
    content.innerHTML = paras.map(p => `<p class="mb-3 last:mb-0">${p.replace(/\n/g,'<br>')}</p>`).join('');
    if (result.generated_at) {
      content.innerHTML += `<p class="text-xs text-slate-600 mt-3">Generated ${result.generated_at}</p>`;
    }
  } catch(e) {
    content.innerHTML = `<span class="text-rose-400 text-xs">⚠ ${e.message}</span>`;
  }
  btn.disabled    = false;
  btn.textContent = 'Regenerate';
  _summaryGenerating = false;
}

// Boot
Promise.all([loadMarkets(), loadSentiment(), loadGoldRatios(), loadEconEvents(), loadMovers()]);
</script>
{% endblock %}
